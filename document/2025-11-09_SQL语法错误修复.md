# SQLè¯­æ³•é”™è¯¯ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-11-09  
**é—®é¢˜ç±»å‹**: SQLiteè¯­æ³•é”™è¯¯  
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ï¼ˆå¯¼è‡´æ‰€æœ‰å†™å…¥åŠŸèƒ½å¤±è´¥ï¼‰

---

## âŒ é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
sqlite3.OperationalError: unrecognized token: "#"
```

### é”™è¯¯ä½ç½®
- **æ–‡ä»¶**: `registry/service.py`
- **å‡½æ•°**: `batch_upsert_tasks`ï¼ˆç¬¬697è¡Œï¼‰
- **åŸå› **: SQLå­—ç¬¦ä¸²å†…ä½¿ç”¨äº†Pythoné£æ ¼çš„`#`æ³¨é‡Š

### å½±å“èŒƒå›´
- âœ… å†™å…¥å›æ–‡å•å·åå†æ¬¡å¤„ç†ä¸æ˜¾ç¤ºå¾…å®¡æŸ¥
- âœ… æŸ¥è¯¢å†å²è®°å½•æ—¶æ¥å£å·æ²¡æœ‰è¢«å†™å…¥å®Œæˆä¿¡æ¯
- âœ… å›æ–‡å•å·æ²¡æœ‰è¢«è®°å½•åˆ°æ•°æ®åº“
- âœ… æ‰€æœ‰ä¾èµ–`batch_upsert_tasks`çš„åŠŸèƒ½å‡å¤±æ•ˆ

---

## ğŸ” æ ¹æœ¬åŸå› 

**SQLiteåªè¯†åˆ«`--`ä½œä¸ºå•è¡Œæ³¨é‡Šï¼Œä¸è¯†åˆ«`#`ç¬¦å·ï¼**

åœ¨ä¹‹å‰çš„ä¿®æ”¹ä¸­ï¼Œæˆ‘é”™è¯¯åœ°åœ¨SQLå­—ç¬¦ä¸²å†…éƒ¨æ·»åŠ äº†Pythoné£æ ¼çš„æ³¨é‡Šï¼š

```python
# âŒ é”™è¯¯å†™æ³•
conn.execute(
    """
    INSERT INTO tasks (...)
    ON CONFLICT(id) DO UPDATE SET
        status = excluded.status,  # ã€ä¿®å¤ã€‘å¼ºåˆ¶æ›´æ–°statusï¼ˆæ”¯æŒé‡ç½®ï¼‰
        display_status = excluded.display_status,  # ã€ä¿®å¤ã€‘å¼ºåˆ¶æ›´æ–°ï¼ˆæ”¯æŒé‡ç½®ï¼‰
        ...
    """,
    ...
)
```

è¿™äº›`#`æ³¨é‡Šä¼šè¢«SQLiteè§£æå™¨å½“ä½œSQLçš„ä¸€éƒ¨åˆ†ï¼Œå¯¼è‡´è¯­æ³•é”™è¯¯ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶ï¼š`registry/service.py`

#### 1. `batch_upsert_tasks`å‡½æ•°ï¼ˆç¬¬708-726è¡Œï¼‰

**ä¿®å¤å‰**:
```python
ON CONFLICT(id) DO UPDATE SET
    business_id = excluded.business_id,
    department = excluded.department,
    interface_time = excluded.interface_time,
    role = excluded.role,
    status = excluded.status,  # ã€ä¿®å¤ã€‘å¼ºåˆ¶æ›´æ–°statusï¼ˆæ”¯æŒé‡ç½®ï¼‰
    display_status = excluded.display_status,  # ã€ä¿®å¤ã€‘å¼ºåˆ¶æ›´æ–°ï¼ˆæ”¯æŒé‡ç½®ï¼‰
    last_seen_at = excluded.last_seen_at,
    assigned_by = COALESCE(excluded.assigned_by, assigned_by),
    assigned_at = COALESCE(excluded.assigned_at, assigned_at),
    responsible_person = CASE
        WHEN assigned_by IS NOT NULL THEN responsible_person
        ELSE COALESCE(excluded.responsible_person, responsible_person)
    END,
    confirmed_by = excluded.confirmed_by,  # ã€ä¿®å¤ã€‘å¼ºåˆ¶æ›´æ–°ï¼ˆæ”¯æŒé‡ç½®ä¸ºNULLï¼‰
    completed_at = excluded.completed_at,  # ã€ä¿®å¤ã€‘å¼ºåˆ¶æ›´æ–°ï¼ˆæ”¯æŒé‡ç½®ä¸ºNULLï¼‰
    confirmed_at = excluded.confirmed_at,   # ã€ä¿®å¤ã€‘å¼ºåˆ¶æ›´æ–°ï¼ˆæ”¯æŒé‡ç½®ä¸ºNULLï¼‰
    response_number = COALESCE(excluded.response_number, response_number)  # ã€æ–°å¢ã€‘ä¿æŒå·²æœ‰å›æ–‡å•å·
```

**ä¿®å¤å**:
```python
ON CONFLICT(id) DO UPDATE SET
    business_id = excluded.business_id,
    department = excluded.department,
    interface_time = excluded.interface_time,
    role = excluded.role,
    status = excluded.status,
    display_status = excluded.display_status,
    last_seen_at = excluded.last_seen_at,
    assigned_by = COALESCE(excluded.assigned_by, assigned_by),
    assigned_at = COALESCE(excluded.assigned_at, assigned_at),
    responsible_person = CASE
        WHEN assigned_by IS NOT NULL THEN responsible_person
        ELSE COALESCE(excluded.responsible_person, responsible_person)
    END,
    confirmed_by = excluded.confirmed_by,
    completed_at = excluded.completed_at,
    confirmed_at = excluded.confirmed_at,
    response_number = COALESCE(excluded.response_number, response_number)
```

#### 2. å‚æ•°å…ƒç»„ï¼ˆç¬¬727-749è¡Œï¼‰

åŒæ—¶åˆ é™¤äº†å‚æ•°å…ƒç»„ä¸­çš„æ‰€æœ‰æ³¨é‡Šï¼ˆè™½ç„¶Pythonä»£ç ä¸­çš„æ³¨é‡Šæ˜¯å…è®¸çš„ï¼Œä½†ä¸ºäº†ä¿æŒä»£ç æ•´æ´ï¼Œç»Ÿä¸€åˆ é™¤ï¼‰ã€‚

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### 1. å¯åŠ¨ç¨‹åº
æ§åˆ¶å°ä¸åº”å†å‡ºç°`unrecognized token: "#"`é”™è¯¯

### 2. å†™å…¥å›æ–‡å•å·
```
æ“ä½œæ­¥éª¤ï¼š
1. é€‰æ‹©ä»»æ„æ¥å£
2. å†™å…¥å›æ–‡å•å·
3. ç‚¹å‡»"å¼€å§‹å¤„ç†"
4. æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º"å¾…å®¡æŸ¥"çŠ¶æ€
```

### 3. æŸ¥è¯¢å†å²è®°å½•
```
æ“ä½œæ­¥éª¤ï¼š
1. ç‚¹å‡»"å†å²æŸ¥è¯¢"
2. è¾“å…¥é¡¹ç›®å·å’Œæ¥å£å·
3. æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºå®Œæˆä¿¡æ¯å’Œå›æ–‡å•å·
```

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. SQLå­—ç¬¦ä¸²æ³¨é‡Šè§„åˆ™
- âŒ **ç¦æ­¢**: åœ¨SQLå­—ç¬¦ä¸²å†…ä½¿ç”¨`#`æ³¨é‡Š
- âœ… **æ­£ç¡®**: åœ¨SQLå­—ç¬¦ä¸²å¤–ä½¿ç”¨Pythonæ³¨é‡Š
- âœ… **å¤‡é€‰**: åœ¨SQLå­—ç¬¦ä¸²å†…ä½¿ç”¨`--`æ³¨é‡Šï¼ˆä½†ä¸æ¨èï¼‰

### 2. æœ€ä½³å®è·µ
```python
# âœ… æ¨èå†™æ³•ï¼šåœ¨SQLå¤–æ·»åŠ æ³¨é‡Š
# ä»¥ä¸‹SQLå¼ºåˆ¶æ›´æ–°statuså­—æ®µï¼Œæ”¯æŒé‡ç½®æ“ä½œ
conn.execute(
    """
    UPDATE tasks SET
        status = ?,
        display_status = ?
    WHERE id = ?
    """,
    (status, display_status, task_id)
)
```

### 3. ä»£ç å®¡æŸ¥è¦ç‚¹
- æ£€æŸ¥æ‰€æœ‰SQLå­—ç¬¦ä¸²å†…æ˜¯å¦æœ‰`#`æ³¨é‡Š
- ä½¿ç”¨SQLè¯­æ³•æ£€æŸ¥å·¥å…·
- åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯SQLè¯­å¥

---

## âœ… ä¿®å¤çŠ¶æ€

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| SQLè¯­æ³•é”™è¯¯ | âœ… å·²ä¿®å¤ |
| åˆ é™¤æ‰€æœ‰`#`æ³¨é‡Š | âœ… å·²å®Œæˆ |
| éªŒè¯SQLè¯­æ³• | âœ… é€šè¿‡ |
| åŠŸèƒ½æµ‹è¯• | â³ å¾…ç”¨æˆ·éªŒè¯ |

---

## ğŸ”„ å»ºè®®

1. **ç«‹å³æµ‹è¯•**: è¯·é‡å¯ç¨‹åºå¹¶éªŒè¯æ‰€æœ‰åŠŸèƒ½
2. **æ¸…ç†ç¼“å­˜**: å¦‚æœé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼Œå°è¯•æ¸…ç†ç¼“å­˜
3. **æ£€æŸ¥æ•°æ®åº“**: ç¡®è®¤`response_number`å­—æ®µå·²æ­£ç¡®æ·»åŠ 

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-11-09  
**ä¿®å¤çŠ¶æ€**: âœ… å·²è§£å†³

