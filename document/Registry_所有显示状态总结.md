# Registry模块 - 所有显示状态总结

## 📊 完整状态流转图

```
任务生命周期：
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  [创建] → [待完成] → [已完成] → [已确认] → [归档]           │
│   open     open     completed  confirmed   archived        │
│                                                             │
└─────────────────────────────────────────────────────────────┘

显示状态（display_status）变化：
┌────────────┬──────────────┬────────────────┬──────────┐
│  创建时    │   完成后     │    确认后      │  归档后  │
├────────────┼──────────────┼────────────────┼──────────┤
│ 📌 待完成  │ ⏳ 待确认    │  (不显示)      │ (不显示) │
└────────────┴──────────────┴────────────────┴──────────┘
```

---

## 🎯 所有显示状态详解

### 1. 📌 待完成

**触发条件**：
- ✅ 任务首次被处理（`on_process_done`）
- ✅ 任务被上级指派给设计人员（`on_assigned`）

**适用场景**：
- 场景A：设计人员自己职责内的任务（无上级指派）
- 场景B：上级指派给设计人员的任务

**显示对象**：
- 设计人员：看到自己需要完成的任务
- 上级角色（指派人）：看到指派出去但设计人员还未完成的任务

**消失时机**：
- 设计人员填写回文单号后 → 状态变为"待确认"

---

### 2. ⏳ 待上级确认

**触发条件**：
- ✅ 设计人员填写回文单号（`on_response_written`）
- ✅ 任务**无指派人**（即设计人员自己职责内的任务）

**适用场景**：
- 设计人员自己发现并完成的任务（非上级指派）

**显示对象**：
- 上级角色（室主任、接口工程师）：看到需要确认的任务
- 设计人员：看到自己完成但等待上级确认的任务

**消失时机**：
- 上级角色点击"已完成"勾选框 → 任务状态变为confirmed，display_status清空

---

### 3. ⏳ 待指派人确认

**触发条件**：
- ✅ 设计人员填写回文单号（`on_response_written`）
- ✅ 任务**有指派人**（即上级指派的任务）

**适用场景**：
- 上级指派给设计人员的任务，设计人员已完成

**显示对象**：
- 指派人（接口工程师/室主任）：看到自己指派的任务已完成，等待确认
- 设计人员：看到自己完成但等待指派人确认的任务

**消失时机**：
- 指派人点击"已完成"勾选框 → 任务状态变为confirmed，display_status清空

---

### 4. ⏳ 待确认（可自行确认）

**触发条件**：
- ❌ 目前代码中已定义但**未使用**

**预留用途**：
- 可能用于设计人员自己可以确认的特殊任务
- 或其他需要自行确认的场景

---

### 5. (不显示状态)

**触发条件**：
- ✅ 任务已确认（`status='confirmed'`且`confirmed_at`不为空）
- ✅ 任务已归档（`status='archived'`）

**适用场景**：
- 任务流程已完结，无需继续提醒

---

## 📋 不同角色看到的状态汇总

### 设计人员视角

| 任务类型 | 未完成 | 已完成未确认 | 已确认 |
|---------|--------|-------------|--------|
| **自己职责内的任务** | 📌 待完成 | ⏳ 待上级确认 | (不显示) |
| **上级指派的任务** | 📌 待完成 | ⏳ 待指派人确认 | (不显示) |

### 上级角色（室主任/接口工程师）视角

| 任务类型 | 设计人员未完成 | 设计人员已完成 | 已确认 |
|---------|---------------|---------------|--------|
| **自己指派出去的任务** | 📌 待完成 | ⏳ 待指派人确认 | (不显示) |
| **非自己指派的任务** | (不显示) | ⏳ 待上级确认 | (不显示) |

**重要说明**：
- 上级角色看到"📌 待完成"是为了**跟踪指派任务的进度**
- 上级角色不需要看到其他人指派的未完成任务
- 上级角色需要看到**所有**已完成待确认的任务（无论谁指派）

### 所领导视角

| 任务类型 | 状态 |
|---------|------|
| **所有任务** | 不显示状态（仅查看延期标记⚠️） |

**原因**：
- 所领导不参与具体任务确认
- 所领导主要关注延期情况，不需要Registry状态提醒

---

## 🔄 完整任务流程示例

### 场景1：设计人员自己职责内的任务（无指派）

```
1️⃣ 任务首次处理
   └─ 设计人员看到：📌 待完成
   └─ 上级角色看到：(无状态，仅延期时显示⚠️)

2️⃣ 设计人员填写回文单号
   └─ 设计人员看到：⏳ 待上级确认
   └─ 上级角色看到：⏳ 待上级确认

3️⃣ 上级角色点击"已完成"确认
   └─ 所有人看到：(不显示状态)
   └─ 任务状态：status=confirmed
```

### 场景2：上级指派的任务（有指派）

```
1️⃣ 上级指派任务给设计人员
   └─ 设计人员看到：📌 待完成
   └─ 指派人看到：📌 待完成（跟踪进度）

2️⃣ 设计人员填写回文单号
   └─ 设计人员看到：⏳ 待指派人确认
   └─ 指派人看到：⏳ 待指派人确认

3️⃣ 指派人点击"已完成"确认
   └─ 所有人看到：(不显示状态)
   └─ 任务状态：status=confirmed
```

---

## 🎨 UI显示规则

### Emoji图标规则

| Emoji | 含义 | 颜色语义 |
|-------|------|---------|
| 📌 | 待完成 | 提醒（蓝色系）|
| ⏳ | 待确认 | 等待（黄色系）|
| ⚠️ | 延期 | 警告（红色系）|

### 优先级规则

当一个任务同时满足多个显示条件时：

1. **最高优先级**：Registry状态（📌 待完成 / ⏳ 待确认）
2. **次优先级**：延期标记（⚠️）
3. **最低优先级**：无标记（空白）

**实现代码**（`window.py::display_excel_data`）：
```python
if idx in registry_status_map:
    # 有Registry状态提醒
    status_values.append(registry_status_map[idx])
elif time_str != '-' and is_date_overdue(time_str):
    # 延期标记
    status_values.append("⚠️")
else:
    # 正常无标记
    status_values.append("")
```

---

## 🔧 导出逻辑

### 导出时的过滤规则

**排除规则**（`base.py::_exclude_pending_confirmation_rows`）：
- ✅ 排除所有包含"待"字样的任务
  - 📌 待完成 → **不导出**
  - ⏳ 待上级确认 → **不导出**
  - ⏳ 待指派人确认 → **不导出**
  
**原因**：
- 设计人员的"待完成"任务不应导出（还未完成）
- 设计人员的"待确认"任务不应导出（还未被上级确认）

**特殊规则**：
- 已确认的任务（display_status=NULL）→ **可导出**
- 延期的任务（仅⚠️标记，无display_status）→ **可导出**

---

## 📊 数据库字段说明

### tasks表中的相关字段

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `status` | TEXT | 任务状态 | open / completed / confirmed / archived |
| `display_status` | TEXT | UI显示文本 | 待完成 / 待上级确认 / 待指派人确认 / NULL |
| `assigned_by` | TEXT | 指派人 | 王工（1818接口工程师）/ NULL |
| `assigned_at` | TEXT | 指派时间 | 2025-11-03T14:30:00 / NULL |
| `confirmed_by` | TEXT | 确认人 | 李主任 / NULL |
| `confirmed_at` | TEXT | 确认时间 | 2025-11-03T16:45:00 / NULL |
| `completed_at` | TEXT | 完成时间 | 2025-11-03T15:20:00 / NULL |

### 状态字段的关系

```
status (数据库状态)     display_status (UI显示)
─────────────────       ──────────────────────
open                 →  待完成
completed            →  待上级确认 / 待指派人确认
confirmed            →  NULL (不显示)
archived             →  NULL (不显示)
```

---

## ✅ 实现清单

### 已完成功能 ✅

- ✅ 所有新任务默认显示"📌 待完成"（无论是否指派）
- ✅ 有指派的任务完成后显示"⏳ 待指派人确认"
- ✅ 无指派的任务完成后显示"⏳ 待上级确认"
- ✅ 确认后清除display_status
- ✅ Emoji状态显示
- ✅ 导出时排除待确认任务
- ✅ 批量查询优化（避免N+1问题）

### 待实现功能 ⏳

- ⏳ 上级角色勾选"已完成"触发confirmed（UI集成）
- ⏳ 归档逻辑（任务消失7天后自动归档）
- ⏳ 历史视图UI（查看已确认/已归档任务）
- ⏳ 角色判断逻辑（区分设计人员和上级角色）

---

## 🧪 测试用例

### 单元测试覆盖

✅ **已有测试**（`tests/test_registry_status_reminder.py`）：
1. 任务创建时显示"待完成"
2. 指派任务后显示"待完成"
3. 设计人员完成后显示相应待确认状态
4. 确认后清除状态
5. 角色解耦测试

⏳ **待补充测试**：
1. 上级角色看到指派任务的状态
2. 多个上级角色的状态隔离
3. 导出时正确排除待确认任务

---

**文档创建时间**: 2025-11-04  
**文档版本**: v1.0  
**最后更新**: 2025-11-04  
**对应代码版本**: 阶段1完成 + 无指派任务状态修复

