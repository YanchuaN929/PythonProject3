# Registryæ¥å£å·ç»§æ‰¿åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚ç†è§£

### æ ¸å¿ƒæ¦‚å¿µæ¾„æ¸…

**æ¥å£**ï¼š
- Excelæ–‡ä»¶ä¸­çš„æ¯ä¸€è¡Œæ•°æ®å°±æ˜¯ä¸€ä¸ª"æ¥å£"
- æ¥å£å·ï¼ˆinterface_idï¼‰æ˜¯æ¥å£çš„å”¯ä¸€èº«ä»½æ ‡è¯†
- ä¾‹å¦‚ï¼š`S-SA---1JT-01-25C1-25E6`

**å®é™…ä½¿ç”¨åœºæ™¯**ï¼š
- **æ¯å‘¨æ›´æ–°**ï¼š6ä¸ªé¡¹ç›® Ã— 6ä¸ªæ–‡ä»¶ç±»å‹ = 36ä¸ªæºæ–‡ä»¶
- **æ–‡ä»¶åå˜åŒ–**ï¼šåŒ…å«æ—¥æœŸï¼Œæ¯å‘¨ä¸åŒ
  - æ—§ï¼š`2016æŒ‰é¡¹ç›®å¯¼å‡ºIDIæ‰‹å†Œ2025-08-01.xlsx`
  - æ–°ï¼š`2016æŒ‰é¡¹ç›®å¯¼å‡ºIDIæ‰‹å†Œ2025-08-08.xlsx`
- **æ¥å£å·ç›¸åŒ**ï¼šåŒä¸€ä¸ªæ¥å£åœ¨ä¸åŒå‘¨æ¬¡çš„æ–‡ä»¶ä¸­ï¼Œæ¥å£å·ç›¸åŒ
- **æ•°æ®å¯èƒ½å˜åŒ–**ï¼š
  - æ—¶é—´åˆ—ï¼ˆKåˆ—ã€Måˆ—ç­‰ï¼‰å¯èƒ½æ›´æ–°
  - æ–°å¢æ¥å£
  - åˆ é™¤æ¥å£

---

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

### 1. çŠ¶æ€ç»§æ‰¿

**è§„åˆ™**ï¼šå¦‚æœ`é¡¹ç›®å· + æ–‡ä»¶ç±»å‹ + æ¥å£å·`ç›¸åŒï¼Œåˆ™ç»§æ‰¿çŠ¶æ€

**ç¤ºä¾‹**ï¼š
```
æ—§æ–‡ä»¶ï¼ˆ2025-08-01ï¼‰ï¼š
  - æ¥å£å·ï¼šS-SA---1JT-01-25C1-25E6
  - é¡¹ç›®å·ï¼š2016
  - æ–‡ä»¶ç±»å‹ï¼š1
  - RegistryçŠ¶æ€ï¼šdisplay_status='å¾…å®¡æŸ¥', completed_at='2025-08-01 10:00'

æ–°æ–‡ä»¶ï¼ˆ2025-08-08ï¼‰ï¼š
  - æ¥å£å·ï¼šS-SA---1JT-01-25C1-25E6  â† ç›¸åŒï¼
  - é¡¹ç›®å·ï¼š2016
  - æ–‡ä»¶ç±»å‹ï¼š1
  - RegistryçŠ¶æ€ï¼šç»§æ‰¿æ—§çŠ¶æ€ âœ“
```

---

### 2. æ•°æ®æ›´æ–°æ£€æµ‹

#### æƒ…å†µ1ï¼šæ—¶é—´åˆ—å‘ç”Ÿå˜åŒ– â†’ é‡ç½®çŠ¶æ€

**æ£€æµ‹é€»è¾‘**ï¼š
- å¯¹äºæ–‡ä»¶ç±»å‹1ï¼šæ£€æŸ¥Kåˆ—ï¼ˆæ¥å£æ—¶é—´ï¼‰å’ŒMåˆ—ï¼ˆå›æ–‡æ—¶é—´ï¼‰
- å¦‚æœKåˆ—å˜åŒ–ï¼ˆå¦‚11.6 â†’ 12.30ï¼‰ï¼Œè¯´æ˜æ”¶åˆ°æ–°çš„ä¿¡æ¯å•
- **æˆ–è€…**Måˆ—å˜åŒ–ï¼ˆå¦‚11.7 â†’ ç©ºï¼‰ï¼Œè¯´æ˜å›æ–‡å•å·å¤±æ•ˆ
- **åŠ¨ä½œ**ï¼šé‡ç½®çŠ¶æ€
  - `status='open'`
  - `display_status='å¾…å®Œæˆ'`æˆ–`'è¯·æŒ‡æ´¾'`
  - `completed_at=NULL`
  - ä¿ç•™ï¼š`assigned_by`, `assigned_at`, `responsible_person`ï¼ˆæŒ‡æ´¾ä¿¡æ¯ä¿ç•™ï¼‰

**ç¤ºä¾‹**ï¼š
```
æ•°æ®åº“ä¸­ï¼š
  - Kåˆ—ï¼š11.06
  - Måˆ—ï¼š11.07
  - status='completed'
  - display_status='å¾…å®¡æŸ¥'

Excelæ–°æ–‡ä»¶ï¼š
  - Kåˆ—ï¼š12.30  â† å˜åŒ–ï¼
  - Måˆ—ï¼šç©º     â† å˜åŒ–ï¼

æ›´æ–°åçš„æ•°æ®åº“ï¼š
  - Kåˆ—ï¼š12.30  â† æ›´æ–°
  - Måˆ—ï¼šç©º     â† æ›´æ–°
  - status='open'  â† é‡ç½®
  - display_status='å¾…å®Œæˆ'  â† é‡ç½®
  - responsible_personï¼šä¿ç•™ï¼ˆå¦‚æœæœ‰ï¼‰
```

---

#### æƒ…å†µ2ï¼šæ–°çš„æ¥å£å· â†’ åˆ›å»ºæ–°è®°å½•

**æ£€æµ‹é€»è¾‘**ï¼š
- åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢ä¸åˆ°è¯¥`é¡¹ç›®å· + æ–‡ä»¶ç±»å‹ + æ¥å£å·`
- **åŠ¨ä½œ**ï¼šæŒ‰æ­£å¸¸æµç¨‹åˆ›å»ºæ–°ä»»åŠ¡

---

### 3. è§¦å‘æ—¶æœº

**æ—¶æœº**ï¼šæ¯æ¬¡"åˆ·æ–°æ–‡ä»¶åˆ—è¡¨"æ—¶æ‰§è¡Œ

**æµç¨‹**ï¼š
```
ç”¨æˆ·ç‚¹å‡»"åˆ·æ–°æ–‡ä»¶åˆ—è¡¨"
    â†“
è¯»å–Excelæ–‡ä»¶
    â†“
å¯¹æ¯ä¸ªæ¥å£ï¼ŒæŸ¥è¯¢Registryï¼š
  - æŒ‰ä¸šåŠ¡IDï¼ˆé¡¹ç›®å·+æ–‡ä»¶ç±»å‹+æ¥å£å·ï¼‰æŸ¥è¯¢
  - å¿½ç•¥source_fileå’Œrow_index
    â†“
å¦‚æœæ‰¾åˆ°æ—§ä»»åŠ¡ï¼š
  - æ£€æŸ¥æ—¶é—´åˆ—æ˜¯å¦å˜åŒ–
  - å¦‚æœå˜åŒ– â†’ é‡ç½®çŠ¶æ€
  - å¦‚æœæœªå˜åŒ– â†’ ç»§æ‰¿çŠ¶æ€
    â†“
å¦‚æœæœªæ‰¾åˆ° â†’ åˆ›å»ºæ–°ä»»åŠ¡
```

---

## ğŸ—ï¸ è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ·»åŠ ä¸šåŠ¡IDå­—æ®µï¼ˆæ¨èï¼‰â­

#### æ•°æ®åº“Schemaä¿®æ”¹

**æ–°å¢å­—æ®µ**ï¼š
```sql
ALTER TABLE tasks ADD COLUMN business_id TEXT;  -- ä¸šåŠ¡IDï¼ˆé¡¹ç›®å·+æ–‡ä»¶ç±»å‹+æ¥å£å·ï¼‰
CREATE INDEX IF NOT EXISTS idx_tasks_business_id ON tasks(business_id);
```

**business_idæ ¼å¼**ï¼š
```
business_id = f"{file_type}|{project_id}|{interface_id}"
ä¾‹å¦‚ï¼š1|2016|S-SA---1JT-01-25C1-25E6
```

**ä¸»é”®vsä¸šåŠ¡ID**ï¼š
- `id`ï¼ˆä¸»é”®ï¼‰ï¼šä»ç„¶æ˜¯`file_type|project_id|interface_id|source_file|row_index`çš„å“ˆå¸Œ
- `business_id`ï¼šç”¨äºè·¨æ–‡ä»¶åŒ¹é…

---

#### æ ¸å¿ƒå‡½æ•°ä¿®æ”¹

**1. `registry/util.py`æ–°å¢å‡½æ•°**ï¼š
```python
def make_business_id(file_type: int, project_id: str, interface_id: str) -> str:
    """ç”Ÿæˆä¸šåŠ¡IDï¼ˆä¸å«æ–‡ä»¶åå’Œè¡Œå·ï¼‰"""
    key_str = f"{file_type}|{project_id}|{interface_id}"
    return key_str  # ç›´æ¥è¿”å›ï¼Œä¸å“ˆå¸Œï¼ˆä¾¿äºè°ƒè¯•å’ŒæŸ¥è¯¢ï¼‰
```

**2. `registry/service.py`æ–°å¢å‡½æ•°**ï¼š
```python
def find_task_by_business_id(db_path, wal, file_type, project_id, interface_id):
    """æ ¹æ®ä¸šåŠ¡IDæŸ¥æ‰¾ä»»åŠ¡"""
    conn = get_connection(db_path, wal)
    business_id = make_business_id(file_type, project_id, interface_id)
    
    cursor = conn.execute("""
        SELECT id, source_file, row_index, interface_time, 
               status, display_status, responsible_person,
               assigned_by, assigned_at
        FROM tasks
        WHERE business_id = ?
        ORDER BY last_seen_at DESC
        LIMIT 1
    """, (business_id,))
    
    return cursor.fetchone()
```

**3. `registry/service.py`æ–°å¢å‡½æ•°**ï¼š
```python
def should_reset_task(old_interface_time, new_interface_time, old_completed_col, new_completed_col):
    """åˆ¤æ–­æ˜¯å¦éœ€è¦é‡ç½®ä»»åŠ¡çŠ¶æ€"""
    # å¦‚æœæ—¶é—´åˆ—å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦é‡ç½®
    if old_interface_time != new_interface_time:
        return True
    
    # å¦‚æœå·²å¡«å……åˆ—å˜ä¸ºç©ºï¼ˆå¦‚Måˆ—ä»æœ‰å€¼å˜ä¸ºç©ºï¼‰ï¼Œéœ€è¦é‡ç½®
    if old_completed_col and not new_completed_col:
        return True
    
    return False
```

**4. ä¿®æ”¹`upsert_task`å‡½æ•°**ï¼š
```python
def upsert_task(db_path, wal, key, fields, now):
    # ç”Ÿæˆä»»åŠ¡IDï¼ˆä¸»é”®ï¼‰
    tid = make_task_id(...)
    
    # ç”Ÿæˆä¸šåŠ¡ID
    business_id = make_business_id(key['file_type'], key['project_id'], key['interface_id'])
    
    # æŸ¥è¯¢æ˜¯å¦å­˜åœ¨æ—§ä»»åŠ¡ï¼ˆæŒ‰ä¸šåŠ¡IDï¼‰
    old_task = find_task_by_business_id(db_path, wal, key['file_type'], key['project_id'], key['interface_id'])
    
    if old_task:
        # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
        old_interface_time = old_task[3]
        new_interface_time = fields.get('interface_time', '')
        
        # å¯¹äºæ–‡ä»¶ç±»å‹1ï¼Œè¿˜éœ€è¦æ£€æŸ¥Måˆ—ï¼ˆè¿™ä¸ªé€»è¾‘éœ€è¦ä»Excelè¯»å–ï¼‰
        # å¦‚æœéœ€è¦é‡ç½®
        if should_reset_task(old_interface_time, new_interface_time, ...):
            # é‡ç½®çŠ¶æ€
            fields['status'] = 'open'
            fields['display_status'] = 'å¾…å®Œæˆ' if old_task[7] else 'è¯·æŒ‡æ´¾'  # æœ‰æŒ‡æ´¾äººåˆ™"å¾…å®Œæˆ"
            fields['completed_at'] = None
            # ä¿ç•™æŒ‡æ´¾ä¿¡æ¯
            if not fields.get('assigned_by'):
                fields['assigned_by'] = old_task[7]
                fields['assigned_at'] = old_task[8]
    
    # æ’å…¥æ–°ä»»åŠ¡ï¼ˆå¸¦business_idï¼‰
    conn.execute("""
        INSERT INTO tasks (..., business_id)
        VALUES (..., ?)
        ON CONFLICT(id) DO UPDATE SET ...
    """)
```

---

### æ–¹æ¡ˆBï¼šåŒå±‚æŸ¥è¯¢æœºåˆ¶ï¼ˆå¤‡é€‰ï¼‰

**ä¸ä¿®æ”¹æ•°æ®åº“Schema**ï¼Œåœ¨æŸ¥è¯¢æ—¶å®ç°åŒå±‚åŒ¹é…ï¼š

**ä¼ªä»£ç **ï¼š
```python
def smart_upsert_task(db_path, wal, key, fields, now):
    # 1. ç²¾ç¡®åŒ¹é…ï¼ˆå«æ–‡ä»¶åï¼‰
    tid = make_task_id(å®Œæ•´å‚æ•°)
    task = db.query("SELECT * FROM tasks WHERE id = ?", tid)
    
    if task:
        # ç²¾ç¡®åŒ¹é…æˆåŠŸï¼Œç›´æ¥æ›´æ–°
        update_task(...)
    else:
        # 2. æ¨¡ç³ŠåŒ¹é…ï¼ˆå¿½ç•¥æ–‡ä»¶åå’Œè¡Œå·ï¼‰
        similar_tasks = db.query("""
            SELECT * FROM tasks
            WHERE file_type = ? AND project_id = ? AND interface_id = ?
        """, (file_type, project_id, interface_id))
        
        if len(similar_tasks) == 1:
            # åªæœ‰ä¸€ä¸ªåŒ¹é…ï¼Œç»§æ‰¿çŠ¶æ€
            old_task = similar_tasks[0]
            # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®...
        
        # 3. åˆ›å»ºæ–°ä»»åŠ¡
        insert_task(...)
```

**ä¼˜ç‚¹**ï¼š
- ä¸éœ€è¦ä¿®æ”¹æ•°æ®åº“Schema
- å‘åå…¼å®¹

**ç¼ºç‚¹**ï¼š
- æŸ¥è¯¢é€»è¾‘å¤æ‚
- æ€§èƒ½ç¨å·®ï¼ˆéœ€è¦ä¸¤æ¬¡æŸ¥è¯¢ï¼‰
- å¯èƒ½å‡ºç°å¤šä¸ªåŒ¹é…ï¼ˆæ­§ä¹‰ï¼‰

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | æ–¹æ¡ˆAï¼ˆä¸šåŠ¡IDï¼‰ | æ–¹æ¡ˆBï¼ˆåŒå±‚æŸ¥è¯¢ï¼‰ |
|------|----------------|-----------------|
| **æ•°æ®åº“ä¿®æ”¹** | éœ€è¦ï¼ˆæ·»åŠ å­—æ®µï¼‰ | ä¸éœ€è¦ |
| **æŸ¥è¯¢æ€§èƒ½** | å¿«ï¼ˆæœ‰ç´¢å¼•ï¼‰ | è¾ƒæ…¢ï¼ˆä¸¤æ¬¡æŸ¥è¯¢ï¼‰ |
| **é€»è¾‘æ¸…æ™°åº¦** | æ¸…æ™° | å¤æ‚ |
| **æ­§ä¹‰å¤„ç†** | ä¸å­˜åœ¨ | å¯èƒ½å­˜åœ¨ |
| **å®ç°éš¾åº¦** | ä¸­ç­‰ | ä¸­ç­‰ |
| **å‘åå…¼å®¹** | éœ€è¦æ•°æ®åº“è¿ç§» | å®Œå…¨å…¼å®¹ |

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆA + è‡ªåŠ¨è¿ç§»

### å®æ–½æ­¥éª¤

#### ç¬¬1æ­¥ï¼šæ•°æ®åº“Schemaå‡çº§

**æ–‡ä»¶**ï¼š`registry/db.py::init_db`

**æ·»åŠ **ï¼š
```sql
ALTER TABLE tasks ADD COLUMN business_id TEXT;
CREATE INDEX IF NOT EXISTS idx_tasks_business_id ON tasks(business_id);
```

**è¿ç§»**ï¼š
```python
# ä¸ºç°æœ‰ä»»åŠ¡ç”Ÿæˆbusiness_id
UPDATE tasks SET business_id = file_type || '|' || project_id || '|' || interface_id
WHERE business_id IS NULL;
```

---

#### ç¬¬2æ­¥ï¼šä¿®æ”¹ä»»åŠ¡åˆ›å»ºé€»è¾‘

**æ–‡ä»¶**ï¼š`registry/service.py::upsert_task`

**æ ¸å¿ƒæ”¹åŠ¨**ï¼š
1. ç”Ÿæˆ`business_id`
2. æŸ¥è¯¢æ˜¯å¦å­˜åœ¨æ—§ä»»åŠ¡ï¼ˆæŒ‰business_idï¼‰
3. æ£€æµ‹æ—¶é—´åˆ—å˜åŒ–
4. å†³å®šç»§æ‰¿æˆ–é‡ç½®çŠ¶æ€

---

#### ç¬¬3æ­¥ï¼šæ·»åŠ æ¯”å¯¹é€»è¾‘

**æ–‡ä»¶**ï¼š`registry/hooks.py::on_process_done`

**æ–°å¢**ï¼šåœ¨æ‰¹é‡upsertå‰ï¼Œå…ˆæŸ¥è¯¢æ—§ä»»åŠ¡å¹¶æ¯”å¯¹

---

#### ç¬¬4æ­¥ï¼šä¿®æ”¹æ—¶é—´åˆ—æ£€æµ‹

**éœ€è¦çŸ¥é“çš„ä¿¡æ¯**ï¼š
- æ¯ä¸ªæ–‡ä»¶ç±»å‹çš„æ—¶é—´åˆ—ä½ç½®ï¼ˆKåˆ—ã€Måˆ—ç­‰ï¼‰
- æ¯ä¸ªæ–‡ä»¶ç±»å‹çš„å®Œæˆåˆ—ä½ç½®ï¼ˆMåˆ—ã€Nåˆ—ç­‰ï¼‰

**ä»ä»£ç ä¸­æå–**ï¼š
- æ–‡ä»¶1ï¼šKåˆ—ï¼ˆç´¢å¼•10ï¼‰æ¥å£æ—¶é—´ï¼ŒMåˆ—ï¼ˆç´¢å¼•12ï¼‰å®Œæˆæ ‡è®°
- æ–‡ä»¶2ï¼šNåˆ—ï¼ˆç´¢å¼•13ï¼‰å®Œæˆæ ‡è®°
- æ–‡ä»¶3ï¼šQåˆ—ã€Tåˆ—å®Œæˆæ ‡è®°
- ...

---

## ğŸ“ å…³é”®é—®é¢˜ç¡®è®¤

### é—®é¢˜1ï¼šæ—¶é—´åˆ—å˜åŒ–çš„åˆ¤æ–­æ ‡å‡†

**æ–‡ä»¶ç±»å‹1**ä¸ºä¾‹ï¼š
- Kåˆ—ï¼šæ¥å£æ—¶é—´ï¼ˆå¦‚11.06 â†’ 12.30ï¼‰
- Måˆ—ï¼šå›æ–‡æ—¶é—´ï¼ˆå¦‚11.07 â†’ ç©ºï¼‰

**éœ€è¦é‡ç½®çš„æ¡ä»¶**ï¼ˆè¯·ç¡®è®¤ï¼‰ï¼š
- âœ… Kåˆ—å˜åŒ–ï¼ˆæ¥å£æ—¶é—´æ›´æ–°ï¼‰
- âœ… Måˆ—ä»æœ‰å€¼å˜ä¸ºç©ºï¼ˆå›æ–‡å•å·å¤±æ•ˆï¼‰
- â“ Måˆ—ä»ç©ºå˜ä¸ºæœ‰å€¼ï¼Ÿï¼ˆè¿™åº”è¯¥æ˜¯è®¾è®¡äººå‘˜å¡«å†™çš„ï¼Œä¸åº”è¯¥é‡ç½®ï¼‰
- â“ Kåˆ—ä¸å˜ï¼ŒMåˆ—ä¸å˜ï¼Ÿï¼ˆä¿æŒçŠ¶æ€ï¼‰

---

### é—®é¢˜2ï¼šç»§æ‰¿å“ªäº›å­—æ®µ

**ç»§æ‰¿ï¼ˆä¿ç•™ï¼‰**ï¼š
- âœ… `assigned_by`ï¼ˆæŒ‡æ´¾äººï¼‰
- âœ… `assigned_at`ï¼ˆæŒ‡æ´¾æ—¶é—´ï¼‰
- âœ… `responsible_person`ï¼ˆè´£ä»»äººï¼‰
- â“ `display_status`ï¼Ÿï¼ˆæ ¹æ®æ—¶é—´åˆ—å˜åŒ–å†³å®šï¼‰
- â“ `completed_at`ï¼Ÿï¼ˆæ ¹æ®æ—¶é—´åˆ—å˜åŒ–å†³å®šï¼‰

**ä¸ç»§æ‰¿ï¼ˆé‡ç½®ä¸ºæ–°å€¼ï¼‰**ï¼š
- âœ… `source_file`ï¼ˆæ–°æ–‡ä»¶åï¼‰
- âœ… `row_index`ï¼ˆæ–°è¡Œå·ï¼‰
- âœ… `interface_time`ï¼ˆæ–°çš„Kåˆ—å€¼ï¼‰
- âœ… `first_seen_at`ï¼ˆä¿æŒæ—§å€¼ï¼‰
- âœ… `last_seen_at`ï¼ˆæ›´æ–°ä¸ºå½“å‰æ—¶é—´ï¼‰

---

### é—®é¢˜3ï¼šæ¯ä¸ªæ–‡ä»¶ç±»å‹çš„å…³é”®åˆ—

**è¯·ç¡®è®¤æ¯ä¸ªæ–‡ä»¶ç±»å‹çš„åˆ¤æ–­åˆ—**ï¼š

| æ–‡ä»¶ç±»å‹ | æ—¶é—´åˆ—ï¼ˆæ¥å£æ—¶é—´ï¼‰ | å®Œæˆåˆ—ï¼ˆåˆ¤æ–­æ˜¯å¦å¡«å†™ï¼‰ | å…¶ä»–å…³é”®åˆ— |
|---------|------------------|---------------------|-----------|
| 1 | Kåˆ—ï¼ˆç´¢å¼•10ï¼‰ | Måˆ—ï¼ˆç´¢å¼•12ï¼‰ | ? |
| 2 | Nåˆ—ï¼ˆç´¢å¼•13ï¼‰? | Nåˆ—ï¼ˆç´¢å¼•13ï¼‰ | ? |
| 3 | Måˆ—/Låˆ—? | Qåˆ—ã€Tåˆ— | ? |
| 4 | ? | Våˆ—ï¼ˆç´¢å¼•21ï¼‰ | ? |
| 5 | Låˆ—? | Nåˆ—ï¼ˆç´¢å¼•13ï¼‰ | ? |
| 6 | Iåˆ—? | Måˆ—ï¼ˆç´¢å¼•12ï¼‰ | ? |

**éœ€è¦æ‚¨ç¡®è®¤**ï¼š
- æ¯ä¸ªæ–‡ä»¶ç±»å‹ç”¨å“ªäº›åˆ—åˆ¤æ–­"æ˜¯å¦éœ€è¦é‡ç½®çŠ¶æ€"
- è¿™äº›åˆ—çš„å…·ä½“å«ä¹‰ï¼ˆæ¥å£æ—¶é—´ã€å®Œæˆæ ‡è®°ã€å…¶ä»–ï¼‰

---

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### æ ¸å¿ƒé€»è¾‘ä¼ªä»£ç 

```python
def smart_upsert_task(db_path, wal, key, fields, now):
    """æ™ºèƒ½æ›´æ–°ä»»åŠ¡ï¼ˆæ”¯æŒçŠ¶æ€ç»§æ‰¿å’Œé‡ç½®ï¼‰"""
    
    # 1. ç”Ÿæˆä¸šåŠ¡ID
    business_id = f"{key['file_type']}|{key['project_id']}|{key['interface_id']}"
    
    # 2. æŸ¥è¯¢æ—§ä»»åŠ¡
    old_task = db.query("""
        SELECT * FROM tasks WHERE business_id = ?
        ORDER BY last_seen_at DESC LIMIT 1
    """, business_id)
    
    if old_task:
        # 3. æ£€æµ‹å…³é”®åˆ—æ˜¯å¦å˜åŒ–
        time_col_changed = (old_task['interface_time'] != fields['interface_time'])
        completed_col_changed = check_completed_column_change(old_task, fields, file_type)
        
        if time_col_changed or completed_col_changed:
            # 4. éœ€è¦é‡ç½®çŠ¶æ€
            fields['status'] = 'open'
            fields['display_status'] = 'å¾…å®Œæˆ' if old_task['responsible_person'] else 'è¯·æŒ‡æ´¾'
            fields['completed_at'] = None
            fields['confirmed_at'] = None
            
            # ä¿ç•™æŒ‡æ´¾ä¿¡æ¯
            if old_task['assigned_by'] and not fields.get('assigned_by'):
                fields['assigned_by'] = old_task['assigned_by']
                fields['assigned_at'] = old_task['assigned_at']
                fields['responsible_person'] = old_task['responsible_person']
            
            print(f"[Registry] æ¥å£{interface_id}æ—¶é—´å˜åŒ–ï¼Œé‡ç½®çŠ¶æ€")
        else:
            # 5. ç»§æ‰¿æ—§çŠ¶æ€
            inherit_fields = ['status', 'display_status', 'completed_at', 'confirmed_at',
                            'assigned_by', 'assigned_at', 'responsible_person', 'confirmed_by']
            for field in inherit_fields:
                if not fields.get(field):
                    fields[field] = old_task[field]
            
            print(f"[Registry] æ¥å£{interface_id}æœªå˜åŒ–ï¼Œç»§æ‰¿çŠ¶æ€: {old_task['display_status']}")
    
    # 6. Upsertä»»åŠ¡ï¼ˆå¸¦business_idï¼‰
    tid = make_task_id(å®Œæ•´å‚æ•°)
    fields['business_id'] = business_id
    
    conn.execute("""
        INSERT INTO tasks (..., business_id)
        VALUES (..., ?)
        ON CONFLICT(id) DO UPDATE SET ...
    """)
```

---

## ğŸ“… å®æ–½è®¡åˆ’

### ç¬¬1é˜¶æ®µï¼šæ•°æ®åº“å‡çº§ï¼ˆ1å°æ—¶ï¼‰

1. âœ… æ·»åŠ `business_id`å­—æ®µ
2. âœ… æ·»åŠ ç´¢å¼•
3. âœ… ä¸ºç°æœ‰ä»»åŠ¡ç”Ÿæˆbusiness_id
4. âœ… æµ‹è¯•æ•°æ®åº“è¿ç§»

### ç¬¬2é˜¶æ®µï¼šæ ¸å¿ƒé€»è¾‘å®ç°ï¼ˆ2-3å°æ—¶ï¼‰

1. âœ… å®ç°`make_business_id`å‡½æ•°
2. âœ… å®ç°`find_task_by_business_id`å‡½æ•°
3. âœ… å®ç°æ—¶é—´åˆ—å˜åŒ–æ£€æµ‹é€»è¾‘
4. âœ… ä¿®æ”¹`upsert_task`å‡½æ•°
5. âœ… ä¿®æ”¹`batch_upsert_tasks`å‡½æ•°

### ç¬¬3é˜¶æ®µï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å°æ—¶ï¼‰

1. âœ… æµ‹è¯•çŠ¶æ€ç»§æ‰¿ï¼ˆæ–‡ä»¶åå˜åŒ–ï¼Œæ¥å£å·ç›¸åŒï¼‰
2. âœ… æµ‹è¯•çŠ¶æ€é‡ç½®ï¼ˆæ—¶é—´åˆ—å˜åŒ–ï¼‰
3. âœ… æµ‹è¯•æ–°æ¥å£åˆ›å»º
4. âœ… æµ‹è¯•6ç§æ–‡ä»¶ç±»å‹

---

## â“ éœ€è¦æ‚¨ç¡®è®¤çš„é—®é¢˜

### â˜‘ è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ—¶é—´åˆ—åˆ¤æ–­æ ‡å‡†**ï¼š
   - [ ] æ¯ä¸ªæ–‡ä»¶ç±»å‹ç”¨å“ªäº›åˆ—åˆ¤æ–­"éœ€è¦é‡ç½®çŠ¶æ€"ï¼Ÿ
   - [ ] æˆ‘çš„ç†è§£ï¼ˆæ–‡ä»¶1ï¼šKåˆ—ã€Måˆ—ï¼‰æ˜¯å¦æ­£ç¡®ï¼Ÿ

2. **çŠ¶æ€é‡ç½®è§„åˆ™**ï¼š
   - [ ] æ—¶é—´åˆ—å˜åŒ– â†’ é‡ç½®çŠ¶æ€ï¼Ÿ
   - [ ] å®Œæˆåˆ—ä»æœ‰å€¼å˜ä¸ºç©º â†’ é‡ç½®çŠ¶æ€ï¼Ÿ
   - [ ] ä¿ç•™æŒ‡æ´¾ä¿¡æ¯ï¼ˆassigned_byç­‰ï¼‰ï¼Ÿ

3. **ç»§æ‰¿è§„åˆ™**ï¼š
   - [ ] å¦‚æœæ—¶é—´åˆ—æœªå˜åŒ–ï¼Œç»§æ‰¿æ‰€æœ‰çŠ¶æ€ï¼Ÿ
   - [ ] åŒ…æ‹¬`display_status`, `completed_at`ç­‰ï¼Ÿ

4. **å®æ–½ä¼˜å…ˆçº§**ï¼š
   - [ ] ç«‹å³å®æ–½ï¼ˆæœ¬æ¬¡å¯¹è¯ï¼‰ï¼Ÿ
   - [ ] è¿˜æ˜¯å…ˆéªŒè¯å½“å‰åŠŸèƒ½ï¼Œä¸‹æ¬¡å†å®æ–½ï¼Ÿ

---

## ğŸ¯ æˆ‘çš„å»ºè®®

**æ¨èæ–¹æ¡ˆ**ï¼šæ–¹æ¡ˆAï¼ˆæ·»åŠ ä¸šåŠ¡IDå­—æ®µï¼‰

**å®æ–½å»ºè®®**ï¼š
1. **ç«‹å³å®æ–½**ï¼šå¦‚æœæ‚¨æ€¥éœ€æ­¤åŠŸèƒ½
2. **åˆ†é˜¶æ®µå®æ–½**ï¼š
   - æœ¬æ¬¡ï¼šå®Œæˆæ•°æ®åº“å‡çº§å’Œæ ¸å¿ƒé€»è¾‘
   - ä¸‹æ¬¡ï¼šå®Œå–„æ—¶é—´åˆ—æ£€æµ‹å’Œæµ‹è¯•

**é¢„è®¡Token**ï¼š15-20ä¸‡ï¼ˆå®Œæ•´å®æ–½ï¼‰

**è¯·ç¡®è®¤ä»¥ä¸Šé—®é¢˜åï¼Œæˆ‘ç«‹å³å¼€å§‹å®æ–½ï¼** ğŸš€

---

**æ–‡æ¡£æ—¶é—´**ï¼š2025-11-05  
**è®¾è®¡ç‰ˆæœ¬**ï¼šv1.0  
**çŠ¶æ€**ï¼šç­‰å¾…ç”¨æˆ·ç¡®è®¤

