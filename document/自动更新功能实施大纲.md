# 自动更新功能实施大纲

## 1. 目标与约束
- 在“开机自启自动运行”和“定时自动运行”两条现有自动流程 **开始前** 先做版本检查；若用户手动点击“开始处理”或其他需要执行批处理的操作，也在执行前先检查。
- 版本判断基于本地 `version.json` 与共享路径 `EXE/version.json`，当版本不一致即触发更新。
- 版本号采用日期规则 `YYYY.MM.DD.N`，初始值定为 `2025.11.21.1`（示例：2025 年 11 月 21 日的首个版本）。
- 更新过程需静默完成：若版本一致直接继续；若不一致先弹窗提示“检测到新版本，正在执行更新”，随后自动复制最新版本、重启并继续本次任务。
- 打包模式保持不变，但需新增 `update` 模块（Python 逻辑 + `update.exe` CLI），以支持自我复制更新。
- 共享路径由当前“第一个解析源文件的文件夹”（即 `folder_path`）派生：`<folder_path>/EXE` 中存放最新程序和 `version.json`；该路径可能是局域网 UNC。

## 2. 新模块结构（update/）
```
update/
  __init__.py
  versioning.py        # 读取/解析 version.json，比较版本
  manager.py           # 对外接口：检查、触发更新、重启
  updater_cli.py       # update.exe 的入口，实现复制覆盖逻辑
```
- `versioning.py`
  - `read_version(file_path) -> str`
  - `compare_versions(local, remote) -> int`
  - 兼容缺省/损坏文件（默认 `0.0.0`），支持 `major.minor.patch`。
- `manager.py`
  - `UpdateContext`: 保存本地路径、远程路径（`folder_path/EXE`）、main exe 名称、是否自动模式等。
  - `check_and_update(context)`: 对外主函数；返回 `True` 表示可继续执行，`False` 表示已触发更新（主程序需中止，等待重启）。
  - 内部逻辑：
    1. 读取本地、远程 version；
    2. 若一致→记录日志/监控→直接返回 `True`；
    3. 若远程版本更高→弹窗提示、写日志→调用 `launch_update_exe(context)`，随后退出主进程。
  - `launch_update_exe(context)`：
    - 构造 `update.exe` 所需参数（本地根目录、远程 EXE 目录、目标版本、原始命令行/是否需要自动继续）。
    - 使用 `subprocess.Popen` 启动 `update.exe`，然后 `sys.exit(0)`。
- `updater_cli.py`
  - 以独立进程运行，负责：
    1. 等待主程序完全退出（循环尝试重命名/打开 main exe，直到成功）；
    2. 复制远程 `EXE` 目录所有文件到本地目录（可先复制到临时目录再原子覆盖）；
    3. 将远程 `version.json` 同步到本地；
    4. 启动主程序（支持传递 `--auto-resume` 或特定环境变量，指示更新后需自动继续当前操作）；
    5. 自身退出。
  - 复制使用 `shutil.copy2` / `distutils.dir_util.copy_tree` / 自定义递归，需处理大文件和只读属性。

## 3. 本地与远程路径推导
- 本地安装目录：`app_dir = getattr(sys, '_MEIPASS', os.path.dirname(sys.executable or __file__))`；`version.json` 位于此目录。
- 远程目录：程序当前配置的 `folder_path`（UI 路径输入）为顶层，其中 `EXE` 子目录内包含完整程序与版本标记；远程版本文件为 `<folder_path>/EXE/version.json`。
- 如 `folder_path` 未配置、路径不存在或无 `EXE` 子目录，则版本检查直接返回通过（记录 warning）。

## 4. 与主程序的集成点
1. `ExcelProcessorApp.__init__` 完成配置加载后，初始化 `UpdateManager`（传入 `folder_path`、`auto_mode` 等）。
2. **自动流程前**：
   - 开机自启：`_run_auto_flow`（或触发前的 `self.root.after(...)`）先调用 `update_manager.check_and_update(auto_resume=True)`。
   - 定时任务：若存在内部计划器，同样在任务入口加检查。
3. **手动操作前**：
   - `_on_manual_start_processing`、`_on_manual_export_results` 等触发处理/导出的位置开头做检查。
   - 若 `check_and_update` 返回 `False`（已触发更新），直接返回并提示用户等待更新完成。
4. 弹窗提示：
   - 使用 `messagebox.showinfo("更新提示", "检测到新版本，正在执行更新")`。
   - 自动流程下避免阻塞：可在自动模式中改为 `print/Monitor.log` + 非模式提示（或先弹窗再立即继续）。
5. 日志记录：借助 `Monitor` 输出版本比较结果；如未找到 `version.json`，提示 fallback。

## 5. update.exe 工作流
1. 启动参数示例：
   ```
   update.exe --remote "\\10.102.2.81\\接口筛选\\测试文件\\EXE" --local "D:\\Programs\\接口筛选\\当前版本" --resume "auto_process"
   ```
2. 步骤：
   - `wait_for_process_exit(target_executable)`：轮询直到主程序文件可写。
   - `copytree(remote_dir, local_dir)`：可先复制到 `local_dir_tmp`，复制完成后替换。
   - `write_version(remote_version -> local version.json)`。
   - `restart_main(local_dir, resume_flag)`：`subprocess.Popen([main_exe_path, "--resume", resume_flag])`。
3. 错误处理：
   - 若远程路径不可访问 → 在 update.exe 控制台输出并回退（可写入日志）。
   - 复制失败 → 记录并退出，等待下次启动再尝试更新。

## 6. 打包与发布
- PyInstaller 现有 `excel_processor.spec` 需：
  - 将 `update/` 模块包含进主 exe（便于 `UpdateManager` 使用）。
  - 额外定义一个 `update_exe = EXE(pyz, scripts=['update\\updater_cli.py'], name='update', ...)`，在 `COLLECT` 阶段让 `update.exe` 与主程序同目录输出。
  - 将 `version.json` 列为 `datas`，确保打包时生成初始版本文件（版本号可来自配置/CI）。
- 发布：维护 `version.json`（例如 `{"version": "2025.11.20.1"}`）且确保共享路径 `EXE/` 下文件集齐全。

## 7. 测试方案（pytest）
1. `tests/test_update_manager.py`
   - 使用 `tmp_path` 构建本地/远程目录，写入不同的 `version.json`，验证：
     - 版本一致时不触发更新；
     - 版本落后时触发 `launch_update_exe`（可 monkeypatch 捕获）。
   - 模拟缺失/损坏版本文件。
2. `tests/test_updater_cli.py`
   - 通过 `monkeypatch` (或 subprocess) 验证复制逻辑：远程目录文件同步到本地且 `version.json` 更新。
3. `tests/test_auto_flow_update_integration.py`
   - 对 `ExcelProcessorApp` 关键入口打补丁，确保 `check_and_update` 被调用（可使用 `unittest.mock`）。
4. 现有测试回归
   - 运行 `pytest tests`（或关键子集）确保新增逻辑不破坏既有功能。

## 8. 风险与缓解
- **自我覆盖权限问题**：使用 `update.exe` 独立进程 + 等待主程序退出，避免文件占用。
- **网络不通**：若远程不可达，记录 warning 并允许继续执行，防止阻塞生产。
- **版本文件错误**：`versioning.py` 需具备容错解析（默认 `0.0.0`），防止程序崩溃。
- **更新中断**：复制过程中断会造成半更新；准备先复制到临时目录、完成后再替换，或使用文件校验（可后续增强）。
- **自动流程恢复**：通过参数/环境变量让主程序在更新后知道需要立刻执行原操作，避免用户再次手动点击。

---

以上大纲覆盖文件结构、流程、打包与测试计划。如有补充需求，请告知再迭代。

