# 接口筛选程序 - 文件功能与逻辑说明

> **版本**: 2025.11.25.13  
> **整合自**: 原有25份说明文档

---

## 1. 核心模块

### 1.1 base.py - 主程序控制器

**行数**: 5739行  
**职责**: 应用程序入口、GUI初始化、流程控制、事件处理

**核心功能**:
- 窗口创建与布局管理
- 配置加载与保存（config.json）
- 角色权限验证与过滤
- 处理流程调度（刷新→处理→导出）
- 定时任务管理（10:00、16:00自动处理）
- 系统托盘与开机自启动
- Registry钩子集成

**关键函数**:
| 函数 | 功能 |
|------|------|
| `__init__` | 初始化应用，加载配置 |
| `load_config` | 加载配置（含默认路径、角色时间窗口） |
| `refresh_file_list` | 扫描并识别6种文件 |
| `start_processing` | 开始数据处理（多线程） |
| `export_results` | 导出结果文件 |
| `_run_auto_flow` | 自动模式处理流程 |
| `_filter_by_single_role` | 单角色过滤（含时间窗口） |
| `apply_role_based_filter` | 应用角色权限过滤 |
| `apply_auto_role_date_window` | 自动模式日期窗口过滤 |
| `_collect_overdue_tasks` | 收集延期任务 |

---

### 1.2 window.py - 窗口管理器

**行数**: 1933行  
**职责**: GUI组件创建、数据显示、用户交互、**界面显示控制**

**核心功能**:
- 主窗口布局与自适应
- 6个选项卡的Treeview显示
- 滚动条支持（垂直+水平）
- 勾选框状态管理（从Registry读取）
- 列宽智能计算
- 元数据存储（用于点击事件）
- **版本号显示**（右下角）
- **数据库状态显示**（左下角，集成db_status.py）

**重要说明**: 界面显示由`window.py`的`WindowManager.create_widgets()`方法控制，`base.py`不应重复创建UI组件。

**勾选框逻辑**:
- 状态从Registry的`confirmed_at`字段读取
- 上级角色点击 → 确认/取消确认任务
- 设计人员点击 → 显示提示（无权限）
- 点击后100ms延迟刷新显示

**列宽算法**:
- 中文字符: 16px
- 英文字符: 8px
- 范围限制: 60-300px
- 1.2倍富余系数

---

### 1.3 main.py - 数据处理核心

**行数**: 3990行  
**职责**: 文件识别、数据筛选、结果导出

**核心功能**:
- 6种文件类型的正则识别
- 4步筛选逻辑（科室→日期→完成状态→作废标记）
- 责任人提取（中文字符/分隔符处理）
- 保持原始Excel格式的导出
- Registry状态同步

**6种文件的筛选逻辑**:

| 文件类型 | Process1(科室/类别) | Process2(日期) | Process3(条件) | Process4(排除/条件) |
|---------|---------------|---------------|-------------------|---------------|
| 1 | H列含25C1/2/3 | K列日期范围 | M列空且A列非空 | B列含"作废" |
| 2 | I列含"河北分公司-建筑结构所"或25C1/2/3 | M列日期范围 | N列空且A列非空 | 排除：AB列以4444开头且F列=传递（仅非1907/2016） |
| 3 | I列为"B" 且 AL列以"河北分公司-建筑结构所"开头 | 组1：M列日期范围<br>组2：L列日期范围 | 组1：T列空<br>组2：Q列空 | 最终=组1∪组2 |
| 4 | AF列以"河北分公司-建筑结构所"开头 | P列为"B"或P列为空且AC列为"B" | S列日期范围 | V列为空 |
| 5 | G列含25C1/2/3 | L列日期范围 | N列为空 | - |
| 6 | V列含"河北分公司.建筑结构所" | I列非空且日期≤14天（管理员跳过日期） | M列="尚未回复/超期未回复" | - |

**版本筛选（同一文件内，接口号重复时保留最高版次）**:
| 文件类型 | 版次列 | 规则 |
|---------|--------|------|
| 1 | - | 无版次筛选 |
| 2 | E列 | A < B < C < …，仅保留最高版次 |
| 3 | AC列 | A < B < C < …，仅保留最高版次 |
| 4 | I列 | A < B < C < …，仅保留最高版次 |
| 5 | - | 无版次筛选 |
| 6 | AC列 | A < B < C < …，仅保留最高版次 |

**责任人列映射**:
| 文件 | 列名 | 索引 | 提取方式 |
|------|------|------|---------|
| 1 | R | 17 | 正则提取中文 |
| 2 | AM | 38 | 正则提取中文 |
| 3 | AP | 41 | 正则提取中文 |
| 4 | AH | 33 | 正则提取中文 |
| 5 | K | 10 | 正则提取中文 |
| 6 | X | 23 | 分隔符拆分多人 |

---

### 1.4 Monitor.py - 处理监控器

**行数**: 422行  
**职责**: 实时显示处理日志、支持紧凑模式

**消息类型与颜色**:
| 类型 | 颜色 | 用途 |
|------|------|------|
| INFO | 黑色 | 常规信息 |
| SUCCESS | 绿色 | 成功完成 |
| WARNING | 橙色 | 警告提示 |
| ERROR | 红色 | 错误信息 |
| PROCESS | 蓝色 | 处理过程 |
| SYSTEM | 紫色 | 系统消息 |

**紧凑模式**: 过滤步骤级调试信息，只显示文件级重要日志

---

### 1.5 main2.py - 汇总生成

**行数**: 282行  
**职责**: 生成结果汇总TXT报告

**汇总结构**:
```
结果汇总 - YYYY-MM-DD
================================
涉及的项目号：xxxx, xxxx
项目 xxxx：内部需打开=N，内部需回复=N，...，合计=N
...
按科室与项目分类明细：
  科室：结构一室
    内部需打开接口
      xxxx项目：MM.DD需打开N个（提醒标签）
================================
```

**时间提醒标签**:
| 条件 | 标签 |
|------|------|
| 已过期 | （已延误！！） |
| ≤3天 | （下班前必须完成） |
| ≤7天 | （注意时间） |

---

## 2. 功能模块

### 2.1 db_status.py - 数据库状态显示器（新增）

**行数**: 356行  
**职责**: 在主界面左下角显示数据库连接状态

**状态类型**:
| 状态 | 图标 | 颜色 | 说明 |
|------|------|------|------|
| 未配置 | ⚠️ | 灰色 | 未设置数据文件夹 |
| 已连接 | ✅ | 绿色 | 数据库连接正常 |
| 同步中 | 🔄 | 蓝色 | 正在同步数据 |
| 等待锁定 | ⏳ | 橙色 | 等待其他用户释放锁 |
| 连接失败 | ❌ | 红色 | 数据库操作失败（弹窗提醒） |

**核心功能**:
- 实时状态显示
- 鼠标悬停显示详细信息（路径、任务数、最后同步时间）
- 连接失败时弹窗提醒用户

---

### 2.2 help_viewer.py - 帮助文档查看器（新增）

**行数**: 约450行  
**职责**: 显示使用说明文档，支持目录导航和文本复制

**核心功能**:
- Markdown文档解析与显示
- 左侧目录树导航
- 右侧内容区域（大字体14-18px）
- 支持选中复制（Ctrl+C、右键菜单）
- 根据用户角色自动定位到对应章节

**角色章节映射**:
| 角色 | 自动定位章节 |
|------|-------------|
| 设计人员 | 2. 设计人员使用指南 |
| 室主任（一室/二室/建筑总图室） | 3. 室主任使用指南 |
| 所领导 | 4. 所领导使用指南 |
| 管理员 | 5. 管理员使用指南 |

**使用方式**: 点击主界面右上角的 **❓** 按钮打开帮助窗口

---

### 2.3 distribution.py - 任务指派

**行数**: 813行  
**职责**: 批量任务指派、写入Excel责任人列

**核心功能**:
- 未指派任务收集
- 指派对话框（选择责任人）
- 批量指派处理
- Excel责任人列写入
- Registry状态更新

**写入列映射**:
```python
column_map = {
    1: 'R',   # 文件1责任人列
    2: 'AM',  # 文件2责任人列
    3: 'AP',  # 文件3责任人列
    4: 'AH',  # 文件4责任人列
    5: 'K',   # 文件5责任人列
    6: 'X',   # 文件6责任人列
}
```

---

### 2.4 input_handler.py - 回文单号输入

**行数**: 467行  
**职责**: 设计人员填写回文单号

**核心功能**:
- 回文单号输入对话框
- Excel完成列写入
- 签名列写入（当前用户姓名）
- Registry状态更新（open→completed）
- 缓存清除

**签名列映射**:
| 文件 | 签名列 | 索引 |
|------|--------|------|
| 1 | V | 21 |
| 2 | AL | 37 |
| 3 | BM | 64 |
| 4 | AT | 45 |
| 5 | W | 22 |
| 6 | N | 13 |

---
**选项卡映射**:
| 选项卡 | 接口类型 | 说明 |
|--------|----------|------|
| Tab 1 | 内部需打开接口 | 需要打开的内部接口任务 |
| Tab 2 | 内部需回复接口 | 需要回复的内部接口任务 |
| Tab 3 | 外部需打开接口 | 需要打开的外部接口任务 |
| Tab 4 | 外部需回复接口 | 需要回复的外部接口任务 |
| Tab 5 | 三维提资接口 | 三维模型相关的接口任务 |
| Tab 6 | 收发文函 | 收发文函记录 |

---

### 2.5 ignore_overdue_dialog.py - 忽略延期对话框

**行数**: 537行  
**职责**: 批量忽略延期任务（仅所领导/室主任可用）

**核心功能**:
- 延期任务列表显示
- 多选勾选框
- 忽略原因输入（预设+自定义）
- 排序功能（按列点击）
- 右键复制接口号
- Registry忽略标记

**忽略效果**:
- 不在主显示窗口显示
- 不在状态提醒中出现
- 不在导出结果中包含
- 预期时间变化时自动取消忽略

---

### 2.6 date_utils.py - 日期工具

**行数**: 318行  
**职责**: 日期解析、延期判断、工作日计算

**核心函数**:
| 函数 | 功能 |
|------|------|
| `is_date_overdue` | 判断日期是否已延期 |
| `parse_mmdd_to_date` | 解析mm.dd/yyyy.mm.dd格式 |
| `count_workdays` | 计算工作日天数 |
| `get_workday_difference` | 计算工作日差 |
| `get_date_warn_tag` | 生成提醒标签 |

**跨年智能判断**: 如果解析出的日期距今超过180天且在过去，判断为明年日期

---

### 2.7 file_manager.py - 文件管理器

**行数**: 599行  
**职责**: 文件缓存、版本追踪、文件操作

**核心功能**:
- Excel文件缓存
- 文件修改检测
- 缓存清除
- 结果目录管理

---

## 3. Registry模块

### 3.1 registry/db.py - 数据库管理

**职责**: 连接管理、表结构初始化

**核心功能**:
- 单例连接管理
- WAL模式支持
- 表结构创建（tasks, events, ignored_snapshots）
- 索引创建

---

### 3.2 registry/service.py - 服务层

**职责**: 核心业务逻辑

**核心函数**:
| 函数 | 功能 |
|------|------|
| `upsert_task` | 插入/更新任务 |
| `batch_upsert_tasks` | 批量更新（含状态继承） |
| `mark_completed` | 标记完成 |
| `mark_confirmed` | 标记确认 |
| `mark_unconfirmed` | 取消确认 |
| `mark_ignored_batch` | 批量忽略 |
| `get_display_status` | 批量查询显示状态 |
| `query_task_history` | 查询任务历史 |
| `run_archive_logic` | 执行归档逻辑 |

**状态继承逻辑**:
- 使用`business_id`匹配跨文件的相同接口
- 时间列不变 → 继承状态
- 时间列变化 → 重置状态，保留指派信息
- 完成列被清空 → 归档旧记录，创建新记录

**时间标准化**: 统一不同格式的时间字符串（2025.11.07 → 2025-11-07）

---

### 3.3 registry/hooks.py - 钩子函数

**职责**: 与主程序集成的接口层

**钩子函数**:
| 函数 | 触发时机 |
|------|---------|
| `on_process_done` | 处理完成后 |
| `on_response_written` | 回文单号写入后 |
| `on_confirmed_by_superior` | 上级确认后 |
| `on_unconfirmed_by_superior` | 上级取消确认后 |
| `get_display_status` | 获取显示状态 |

---

### 3.4 registry/history_ui.py - 历史查询

**职责**: 历史记录查询界面

**核心功能**:
- 项目号+接口号查询
- 多版本记录显示（含已归档）
- 状态信息展示
- Excel导出

---

### 3.5 registry/migrate.py - 数据库迁移

**职责**: Schema升级、字段迁移

**自动迁移字段**:
- `business_id` (接口号继承)
- `display_status` (状态显示)
- `assigned_by`, `assigned_at` (指派信息)
- `ignored`相关字段 (忽略功能)
- `archived_at` (归档时间)

---

## 4. Update模块

### 4.1 update/manager.py - 更新管理器

**职责**: 版本检查、更新触发

**核心功能**:
- 检测本地/远程版本差异
- 弹窗提示用户
- 启动update.exe
- 支持resume参数（更新后继续操作）

---

### 4.2 update/versioning.py - 版本比较

**职责**: 版本号解析与比较

**版本格式**: `YYYY.MM.DD.N` (如 2025.11.25.11)

**比较规则**: 四段整数逐位比较

---

### 4.3 update/updater_cli.py - 更新器

**职责**: 独立进程执行文件复制

**更新流程**:
1. 等待主程序退出
2. 复制远程文件到临时目录
3. 原子替换本地目录
4. 更新version.json
5. 重启主程序

**特殊处理**:
- 跳过正在运行的update.exe自身
- 跳过被占用的DLL文件
- 详细日志记录到update_log.txt

---

## 5. 配置文件

### config.json 主配置

```json
{
  "folder_path": "",
  "export_folder_path": "",
  "user_name": "",
  "auto_startup": false,
  "minimize_to_tray": true,
  "dont_ask_again": false,
  "hide_previous_months": false,
  "simple_export_mode": false,

  "defaults": {
    "folder_path": "//10.102.2.7/文件服务器/建筑结构所/接口文件/各项目内外部接口手册",
    "export_path": "D:/jilu"
  },

  "role_export_days": {
    "一室主任": 7,
    "二室主任": 7,
    "建筑总图室主任": 7,
    "所领导": 2,
    "管理员": null,
    "设计人员": null
  }
}
```

**说明**: `role_export_days`同时控制显示和导出的时间窗口（工作日计算）。`null`表示无限制。延期任务始终保留。

### version.json 版本标记

```json
{
  "version": "2025.11.25.11"
}
```

---

## 6. 关键算法

### 6.1 日期筛选范围

```
当前日期 1~19号: 当年1月1日 ~ 当月末
当前日期 20~31号: 当年1月1日 ~ 次月末
```

### 6.2 角色过滤 + 时间窗口

```
所领导 → 全部数据，2个工作日内（含延期）
室主任 → 本室数据，7个工作日内（含延期）
设计人员 → 责任人包含自己姓名的数据
管理员 → 全部数据（无时间限制）
```

### 6.3 任务ID生成

```python
task_id = SHA1(f"{file_type}:{project_id}:{interface_id}:{source_file}:{row_index}")
business_id = f"{file_type}|{project_id}|{interface_id}"
```

---

*文档更新时间: 2025-11-25*
