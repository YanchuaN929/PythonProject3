# 接口筛选程序 - 程序框架

> **版本**: 2025.11.25  
> **整合自**: 原有25份说明文档

---

## 1. 项目概述

**接口筛选程序**是一个企业级Excel数据自动化处理工具，服务于建筑设计院的接口管理工作流程。

### 核心功能
- 6种接口类型批量识别与筛选
- 多项目并行处理（基于项目号自动分组）
- 角色权限管理（基于姓名角色表）
- 任务状态跟踪（Registry模块）
- 自动化定时处理
- 结果导出（保持原始Excel格式）
- 自动更新机制
- 系统托盘与开机自启动

---

## 2. 技术栈

| 类别 | 技术 | 版本 | 用途 |
|-----|------|------|------|
| 语言 | Python | 3.13 | 主开发语言 |
| GUI | Tkinter | 内置 | 图形界面 |
| 数据处理 | pandas | 2.2.3 | Excel数据处理 |
| Excel读写 | openpyxl | 3.1.5 | xlsx格式操作 |
| 系统托盘 | pystray | 0.19.4 | 后台运行 |
| 图像处理 | Pillow | 11.2.1 | 图标处理 |
| 数据库 | SQLite | 内置 | Registry状态存储 |
| 打包 | PyInstaller | 6.13.0 | 可执行文件打包 |

---

## 3. 架构层次

```
┌─────────────────────────────────────────────────────────────────┐
│                      用户交互层 (UI Layer)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │  窗口管理器   │  │  监控器窗口   │  │  对话框模块           │   │
│  │ (window.py)  │  │ (Monitor.py) │  │ (ignore_overdue_     │   │
│  │              │  │              │  │  dialog.py等)        │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓↑
┌─────────────────────────────────────────────────────────────────┐
│                    业务逻辑层 (Logic Layer)                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │        应用程序控制器 (base.py - 5596行)                  │   │
│  │  事件处理 | 角色权限 | 定时器 | 配置管理 | 流程控制         │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  数据处理核心 (main.py - 3990行)                          │   │
│  │  文件识别 → 筛选逻辑 → 数据处理 → 结果导出                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ 汇总生成     │  │ 任务指派     │  │ 输入处理              │  │
│  │ (main2.py)   │  │(distribution)│  │ (input_handler.py)   │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓↑
┌─────────────────────────────────────────────────────────────────┐
│                    服务层 (Service Layer)                        │
│  ┌─────────────────────────┐  ┌─────────────────────────────┐  │
│  │   Registry模块           │  │   Update模块                 │  │
│  │   registry/              │  │   update/                   │  │
│  │   - db.py (数据库)       │  │   - manager.py (版本检查)    │  │
│  │   - service.py (服务)    │  │   - versioning.py (版本比较) │  │
│  │   - hooks.py (钩子)      │  │   - updater_cli.py (更新器)  │  │
│  │   - history_ui.py (历史) │  │                             │  │
│  └─────────────────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓↑
┌─────────────────────────────────────────────────────────────────┐
│                    数据层 (Data Layer)                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐   │
│  │ Excel源   │  │ 配置文件  │  │ Registry │  │ 结果文件     │   │
│  │  (6类)    │  │  (JSON)  │  │ (SQLite) │  │  (xlsx)     │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 目录结构

```
PythonProject3/
├── base.py                    # 主程序控制器 (5596行)
├── main.py                    # 数据处理核心 (3990行)
├── main2.py                   # 结果汇总生成 (282行)
├── window.py                  # 窗口管理器 (1902行)
├── Monitor.py                 # 处理监控器 (422行)
├── file_manager.py            # 文件管理器 (599行)
├── distribution.py            # 任务指派模块 (813行)
├── input_handler.py           # 回文单号输入处理 (467行)
├── ignore_overdue_dialog.py   # 忽略延期对话框 (537行)
├── date_utils.py              # 日期工具函数 (318行)
├── verify_package.py          # 打包验证脚本 (235行)
│
├── registry/                  # Registry模块（任务状态管理）
│   ├── __init__.py
│   ├── config.py              # 配置加载
│   ├── db.py                  # 数据库连接与初始化
│   ├── service.py             # 核心服务函数
│   ├── hooks.py               # 钩子函数（与主程序集成）
│   ├── util.py                # 工具函数
│   ├── models.py              # 数据模型
│   ├── migrate.py             # 数据库迁移
│   └── history_ui.py          # 历史查询界面
│
├── update/                    # 自动更新模块
│   ├── __init__.py
│   ├── manager.py             # 更新管理器
│   ├── versioning.py          # 版本比较
│   └── updater_cli.py         # 更新器CLI (update.exe)
│
├── config.json                # 主配置文件
├── version.json               # 版本标记
├── excel_processor.spec       # PyInstaller打包配置
├── requirements.txt           # 生产依赖
├── requirements-dev.txt       # 开发依赖
│
├── ico_bin/                   # 图标资源
│   └── tubiao.ico
│
├── excel_bin/                 # Excel资源
│   └── 姓名角色表.xlsx
│
├── tests/                     # 测试套件
│   └── *.py
│
├── document/                  # 说明文档
│   └── *.md
│
└── dist_new/                  # 打包输出
    └── 接口筛选/
        ├── 接口筛选.exe
        ├── update.exe
        └── _internal/
```

---

## 5. 六种文件类型

| 类型 | 名称 | 文件名正则 | 科室列 | 时间列 | 完成列 | 责任人列 |
|------|------|-----------|--------|--------|--------|---------|
| 1 | 内部需打开接口 | `(\d{4})按项目导出IDI手册.*` | H列(7) | K列(10) | M列(12) | R列(17) |
| 2 | 内部需回复接口 | `内部接口信息单报表(\d{4}).*` | I列(8) | M列(12) | N列(13) | AM列(38) |
| 3 | 外部需打开接口 | `外部接口ICM报表(\d{4}).*` | L列(11) | Q列(16) | T列(19) | AP列(41) |
| 4 | 外部需回复接口 | `外部接口单报表(\d{4}).*` | I列(8) | M列(12) | V列(21) | AH列(33) |
| 5 | 三维提资接口 | `三维设计提资接口单报表(\d{4}).*` | K列(10) | O列(14) | R列(17) | K列(10) |
| 6 | 收发文函 | `收发文清单(\d{4})?.*` | W列(22)主办室 | I列(8) | J列(9) | X列(23) |

---

## 6. 角色权限体系

| 角色 | 权限范围 | 特殊功能 |
|------|---------|---------|
| 所长/管理员 | 查看所有数据 | 忽略延期任务 |
| 一室主任 | 查看结构一室(25C1)数据 | 确认任务、忽略延期 |
| 二室主任 | 查看结构二室(25C2)数据 | 确认任务、忽略延期 |
| 建筑总图室主任 | 查看建筑总图室(25C3)数据 | 确认任务、忽略延期 |
| 接口工程师 | 查看本室数据 | 确认任务 |
| 设计人员 | 仅查看责任人为自己的数据 | 填写回文单号 |

---

## 7. 核心工作流

```
┌─────────────────┐
│  启动程序       │
│  检查更新       │
└────────┬────────┘
         ↓
┌─────────────────┐
│  加载配置       │
│  初始化界面     │
└────────┬────────┘
         ↓
┌─────────────────┐      ┌─────────────────┐
│  刷新文件列表   │ ───→ │  识别6种文件    │
│  (自动/手动)    │      │  提取项目号     │
└────────┬────────┘      └─────────────────┘
         ↓
┌─────────────────┐
│  开始处理       │
│  (多线程)       │
└────────┬────────┘
         ↓
┌─────────────────────────────────────────────────────────────┐
│ FOR 每种文件类型 & 每个项目号:                               │
│   1. 读取Excel → 2. 4步筛选逻辑 → 3. 生成DataFrame          │
│   4. Registry记录状态 → 5. 应用角色过滤                      │
└────────────────────────────────────────────────────────────┬┘
         ↓
┌─────────────────┐      ┌─────────────────┐
│  显示结果       │      │  过滤已确认任务  │
│  更新GUI        │ ←─── │  过滤已忽略任务  │
└────────┬────────┘      └─────────────────┘
         ↓
┌─────────────────┐
│  导出结果       │
│  生成汇总报告   │
└─────────────────┘
```

---

## 8. Registry模块架构

### 任务状态流转
```
发现任务(open) → 完成(completed) → 确认(confirmed) → 归档(archived)
       ↓              ↓                 ↓
    待完成         待审查            已审查
```

### 数据库表结构（tasks表核心字段）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT | 任务唯一ID (SHA1) |
| business_id | TEXT | 业务ID (用于跨文件继承) |
| file_type | INTEGER | 文件类型(1-6) |
| project_id | TEXT | 项目号 |
| interface_id | TEXT | 接口号 |
| status | TEXT | 状态(open/completed/confirmed/archived) |
| display_status | TEXT | 显示状态(待完成/待审查/已审查) |
| responsible_person | TEXT | 责任人 |
| completed_at | TEXT | 完成时间 |
| confirmed_at | TEXT | 确认时间 |
| ignored | INTEGER | 是否忽略(0/1) |
| interface_time | TEXT | 预期时间 |

---

## 9. 自动更新机制

```
┌─────────────────┐
│  程序启动       │
│  /操作前检查    │
└────────┬────────┘
         ↓
┌─────────────────┐      ┌─────────────────┐
│  读取本地版本   │ ←──→ │  读取远程版本   │
│  version.json   │      │  EXE/version.json│
└────────┬────────┘      └─────────────────┘
         ↓
    版本比较 (YYYY.MM.DD.N)
         ↓
┌─────────────────┐      ┌─────────────────┐
│  版本一致       │      │  版本落后       │
│  继续执行       │      │  触发更新       │
└─────────────────┘      └────────┬────────┘
                                  ↓
                         ┌─────────────────┐
                         │  启动update.exe │
                         │  等待主程序退出 │
                         │  复制新版本文件 │
                         │  重启主程序     │
                         └─────────────────┘
```

---

## 10. 打包配置

### 打包产物
- `接口筛选.exe` - 主程序（无控制台窗口）
- `update.exe` - 更新器（有控制台窗口）
- `_internal/` - 依赖文件目录

### 打包命令
```bash
pyinstaller excel_processor.spec --noconfirm
```

### 验证命令
```bash
python verify_package.py --pre   # 打包前检查
python verify_package.py --post  # 打包后检查
```

---

## 11. 代码行数统计

| 文件 | 行数 | 功能 |
|------|------|------|
| base.py | 5596 | 主程序控制器 |
| main.py | 3990 | 数据处理核心 |
| window.py | 1902 | 窗口管理器 |
| distribution.py | 813 | 任务指派 |
| file_manager.py | 599 | 文件管理 |
| ignore_overdue_dialog.py | 537 | 忽略延期对话框 |
| input_handler.py | 467 | 输入处理 |
| Monitor.py | 422 | 监控器 |
| date_utils.py | 318 | 日期工具 |
| main2.py | 282 | 汇总生成 |
| registry/*.py | ~800 | Registry模块 |
| update/*.py | ~500 | 自动更新模块 |
| **总计** | **~16,000+** | |

---

*文档生成时间: 2025-11-25*

