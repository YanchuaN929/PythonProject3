## 专利申报技术特点总结（软件发明方向）

### 一、技术领域
- 本发明涉及有限链接条件下多用户协作的数据处理与任务流转技术，具体为面向核电站等涉核项目内部“接口处理”业务的多来源数据识别、去耦持久化管理与全流程管理的控制方法与系统。

### 二、背景技术与技术问题
- 现有系统仅对接口流程中的来往过程做记录，面对庞大的资料单接口记录数据。目前设计人员与各级领导均无法收到明确的提醒，且无部署在本地的缓存一体化显示处理方式。对于设计人员完成的接口、数据处理与任务流转，无法实现上级角色（接口工程师/室主任/所领导）的持续追踪和确认，造成流程断点与管理困难。
- 过期数据在现有的接口信息中大量存在，且无法通过界面过滤，单纯依赖人工筛选的方式效率低下且增加大量的额外工作。
- 目前的各类接口流程管理系统多通过网页服务器形式运行，无法实现关联本地计算机的弹窗提醒、每日监控等功能。

本发明拟解决的核心技术问题可以概括为四点：
- 其一，用一个稳定、可回溯的部署“数据库备份”方式刻录接口系统数据库，支持全格式接口管理系统，避免对单一系统的过分依赖和安全漏洞；
- 其二，实现查找—筛选—展示—导出的工作流程以及全过程的“待确认/待完成”的提醒与闭环；
- 其三，考虑仅从接口系统获取原始数据后，通过局域网数据库以及本地部署应用端做到多人并发的安全读写与数据稳定且可恢复；
- 其四，为全接口管理角色：设计人员-接口工程师-室主任-所领导提供合适的数据展示与流程管理方式，并把数据保存在服务器中数据库中，方便后续查询与统计。同时对于在接口系统中存在的大量过期项既能被妥善记录，也不会长期占满默认界面。

### 三、整体方案与系统分层
这套程序并不是一个“网页端大系统”，而是一款部署在每位员工电脑上的桌面工具。核心思路很朴素：把按照某一方式投放在公共盘的某几类某类型文件（例如.xlsx、.csv等）快速、准确地筛出来并把简洁的信息推到应处理的人手里，并把完成和确认的痕迹稳定留下来用来追踪流程，直到确认接口完成。为此，代码按职责划分为几层：

1) 应用与编排层（`base.py`）：负责窗口初始化、自动/手动流程编排、文件扫描、批量处理与导出、弹窗与系统托盘、定时任务、自启动（Windows 注册表）等。这里串起了“找文件→并发读取→按规则筛选→界面展示→导出统计”的主流程。
2) 处理与识别层（`main.py`）：面向 6 类“待处理文件”，逐类实现筛选规则与字段构建，统一输出带有“原始行号/接口时间/责任人/科室/source_file”的 DataFrame，便于后续显示与定位。
3) 界面与交互层（`window.py`）：负责表格展示、列宽与排序、延期高亮、行内勾选、“接口号”点击弹出回文单号输入框等。针对“文件6”做了防重复重绘处理，切换页签不会闪烁或回退。
4) 回填与表单层（`input_handler.py`）：提供回文单号输入弹窗，正确写回源 Excel，并与事实层联动（设计人员回填后即记为“已完成”）。
5) 任务指派层（`distribution.py`）：读取姓名表，发现“未指派/指派不规范”记录时给出集中处理对话框，支持快速检索与一键保存。
6) 工具与支撑层（`date_utils.py`/`file_manager.py`/`main2.py`/`Monitor.py` 等）：包括日期解析与延期判断、轻量级行勾选状态、导出统计 TXT、过程日志等。旧的“缓存”功能已彻底移除，避免在多人环境下造成状态混乱。
7) 事实登记簿（可选子系统，`registry/`）：用于把“完成/确认/归档”等事实从 Excel 解耦出来。它通过一组合适的钩子在恰当的节点入库，而不干扰原有使用节奏。

### 四、文件的识别与筛选方法（仅针对我司需求）
对于不同来类型的表格，我方通过为其制定特殊的筛选方式来完成信息的筛选，具体细节可在 `main.py` 对应函数中见到：

- 文件类型1（内部需打开接口）：依据 H 列“25C1/25C2/25C3”、K 列日期窗口、M 列空值与 B 列“作废”排除综合筛选，保留真实的 Excel 原始行号，便于回写。
- 文件类型2（内部需回复接口）：项目号 1907、2016按标准逻辑，其余项目在 P1&P2&P4 的基础上排除特定的“处理3”（AB 列前缀与 F 列“传递”的组合），更贴近当前管理口径。
- 文件类型3（外部需打开接口）：以 I 列“B”、AL 列“河北分公司-建筑结构所”开头为入围，再结合 M/L 两个日期路径分组求并，保留来源列标记以支持后续精确回写。
- 文件类型4（外部需回复接口）：AF 列（同上开头）、P 列“B”、S 列日期窗口、V 列为空综合判定。
- 文件类型5（三维提资接口）：G 列“25C1/25C2/25C3”、L 列日期、N 列空值三要素合并。
- 文件类型6（收发文函）：V 列机构匹配、I 列必须为有效日期，普通模式限定“今天及未来 14 天”，管理员/所领导模式放开日期上限但仍要求 I 列非空；M 列“尚未回复/超期未回复”为必要条件；责任人支持从多分隔符中提取并与姓名表交叉过滤。

文件识别阶段对文件名采取正则匹配，提取项目号等关键信息；对 `.xlsx/.xls` 兼容读取，并尽量在只读模式下以并发方式加速扫描。

### 五、日期、延期与角色视图
日期并不总是整齐的“yyyy-mm-dd”。`date_utils.py` 增强了多种格式的解析，结合工作日差计算与跨年处理，最终把“是否超期”的判断变成一个稳定的工具函数。在界面上，延期以显眼但克制的方式提示（深红色、加粗、斜体），避免喧宾夺主。

角色只影响“看见什么”和“默认如何排序/过滤”，不影响回填/导出等动作本身。设计人员完成后，该条目在他们自己这里可以淡出，但在上级那里依然可见，直到上级做出确认。一位上级确认即可闭环。

### 六、导出与统计
导出尽量忠实于源表：表头样式、列宽等都会按源表复制；当源表为 `.xls` 时，回退为值复制，保证兼容性。多项目时自动按项目建文件夹，避免文件拥挤。导出后生成一份简明的 TXT 汇总（`main2.py`），把重点信息归纳出来，便于快速通报。

### 七、事实登记簿（中心注册与状态提醒）
为了让“完成与确认”不再受制于每周的 Excel 变化，引入了一个轻量、可选的中心登记簿：

- 存储：使用 SQLite，默认开启 WAL，结合超时设置，应对公共盘并发。数据按“任务维度”和“事件维度”组织：前者写明状态（open/completed/confirmed/archived）及时间戳，后者记录“处理/回填/确认/导出/扫描结束”等关键行为，便于追溯。
- 唯一性：以“文件类型、项目号、接口号、源文件名（基名）、原始行号”组成的五元组，经哈希映射为 `task_id`，保证更新周次不同、行位移发生时依然对得上。
- 接入：`on_process_done` 在批处理后统一更新“看见过”的事实；`on_response_written` 在成功回填后稳态落库；`on_confirmed_by_superior` 完成上级闭环；`on_scan_finalize` 把本轮未再出现的“开放项”标记可能缺失并按策略归档。界面只做“覆盖式标注”，不改变用户的原有操作习惯。

### 八、使用体验与健壮性细节
程序支持开机自启动与后台计时器；最小化到托盘，消息不打扰但也不缺席。文件切换时不做无意义重绘（尤其是“文件6”页签），表格排序、复制、右键菜单等都做了打磨。异常不应成为用户的问题：读取失败会降级、导出样式复制失败会退回到仅复制值，日志清晰地写出发生了什么。

### 九、关键技术要点与可保护点（更贴近日常表述）
如果要用几句话描述本项目的“硬骨头”，大概是这几件事：
1) 把“事实”从易变的 Excel 中拿出来，做成独立登记簿；
2) 用一套钩子在合适的动作上落地这些事实，但不影响任何既有用法；
3) 在共享盘这种并不完美的环境里，仍然做到并发可用；
4) 尊重每类文件的差异，又尽量把输出“抹平”，让后续工作顺着走；
5) 让不同角色“看到该看到的”，同时把过期噪声控制在合理范围内。

把它翻译成更正式的专利语言，可以对应到以下权利要求支撑点：
- 一种任务事实管理方法：基于五元组生成唯一标识，按“处理/回填/确认/导出/扫描结束”这些时点更新事实与事件；
- 一种界面覆盖显示方法：以事实层状态覆盖界面呈现并参与导出过滤，上级确认前条目持续可见；
- 一种在共享盘环境下的轻量协同方案：SQLite WAL + 超时 + 批量插入/更新，保证稳定可用；
- 一种长期过期治理方法：把“界面过滤”与“事实归档”明确分离，既好用又可追溯。

### 十、工业化落地
该方案适合一切“按周期从公共盘获取多类清单、多人分工推进并留痕”的场景。它不要求上线一整套服务器，只需在办公电脑上安装即可；Excel 仍是事实来源之一，但不再是唯一真相。配合登记簿后，制度和工具就真正接上了。

### 十一、附图建议
如需配图，建议包含：系统架构图（应用主干 + 登记簿子系统 + 公共盘）、关键时序（处理/回填/确认/导出/扫描结束）、数据模型（任务与事件字段）、状态机（open→completed→confirmed→archived）、界面叠加标注示意。

### 十二、撰写提示
最终文件可按“方法 + 系统/装置 + 存储介质”的结构组织。独立权利要求聚焦唯一标识、钩子式接入、界面覆盖、并发策略与过期治理；从属权利要求承接到角色确认细则、日期窗口、导出过滤、批量查询与事件枚举等。

——以上为对全仓库功能的连贯性总结，保持了你在开头部分对行业背景与问题的表述风格，同时把具体实现和可保护点尽量用自然语言串起来，便于后续撰写与沟通。

### 附：逻辑流程说明（可直接落地实施）
1) 启动与配置加载：读取配置与角色表，初始化 GUI、托盘、自启动检查。
2) 路径确认与扫描：选择（或自动定位）公共盘目录，按正则识别目标文件并提取项目号。
3) 并发读取：以只读方式并发加载 `.xlsx/.xls` 首个工作表，异常降级不阻断。
4) 分类处理：对识别出的各类文件调用 `main.py` 的对应处理函数，生成包含“原始行号/接口时间/责任人/科室/source_file”的结果集。
5) 角色与日期窗口：在 `base.py/window.py` 应用角色视图与日期策略，并对超期项进行醒目标注。
6) 界面展示与交互：表格列宽/排序/复制；行内“是否已完成”可勾选；点击“接口号”弹出回文单号输入（`input_handler.py`）并写回 Excel。
7) 事实登记簿（可选）：在处理、回填、确认、导出、扫描收尾等节点触发钩子，写入 `registry/` 的任务与事件，供追踪与提醒。
8) 导出与汇总：按项目自动分文件夹导出结果表，生成 TXT 汇总（`main2.py`），用于通报与留存。
9) 扫描收尾与归档：标记本轮未再出现的开放项为“缺失”，按策略归档（仅事实层），更新界面提示。
10) 后台运行与提示：定时器与托盘维持轻量提醒；故障与样式复制失败时采取降级策略，并记录日志（`Monitor.py`）。

### 技术方案
为更贴合日常使用与管理诉求，本方案从数据获取、筛选判定、界面呈现、事实留痕与导出交付五个方面组织：

1) 数据获取与兼容
- 支持公共盘投放的 `.xlsx/.xls`（必要时可扩展 `.csv`）；以只读方式读取首个工作表，避免锁定源文件。
- 通过正则匹配文件名提取项目号与文件类型；文件名不标准时采取“宽进严出”的兼容策略（可读即处理，缺项保留为空值但不阻断流程）。

2) 规则筛选与标准输出
- 针对 6 类清单分别实现筛选规则（列条件、日期窗口、状态字段、排除项等），同时统一输出口径：`原始行号/接口时间/责任人/科室/source_file/项目号`，便于回写与导出。
- 日期解析支持多格式与跨年；延期判断采用工作日差/自然日差的可配置策略，确保提醒可信且稳定。

3) 角色视图与交互
- 角色只影响“看见什么”和“默认如何提醒/排序”，不改变用户能做的动作；设计人员回填后，上级仍可见并可确认，直到闭环。
- 表格支持排序、复制、右键菜单；“是否已完成”行内勾选与“接口号”点击回填均为就地交互，尽量减少打断。

4) 事实登记簿与提醒（可选）
- 通过 `registry/hooks.py` 在处理完成、回填成功、上级确认、导出完成、扫描结束等关键节点落库事件，形成“事实层”。
- 事实层以 `task_id = sha1(file_type|project_id|interface_id|source_file_basename|row_index)` 唯一标识任务，并以状态机（open/completed/confirmed/archived）与时间戳构成可追溯链路；界面优先显示事实层状态，过期提醒为次级覆盖。

5) 导出与交付
- 导出文件忠实复制表头样式与列宽（`.xls` 场景回退为值复制），多项目自动分文件夹；同时生成 TXT 汇总供汇报与归档。
- 导出前可按事实层状态排除“待确认”等干扰项，保证交付物信噪比。

6) 并发与稳定性
- 在公共盘环境使用并发读取与异常降级；可选 SQLite WAL + 超时策略承载事实层的多人写入。
- 任何失败不应阻断主路径：样式复制失败退回值复制；文件读取失败仅跳过该文件并记录日志。

7) 可配置与部署
- 基础配置由 `config.json` 管理（用户姓名、路径、角色偏好等）；可按需扩展 YAML/ENV。
- Windows 环境支持注册表自启动、系统托盘与定时任务；可使用 `excel_processor.spec` 进行打包分发。

### 程序框架
按“职责单一、边界清晰”的原则组织模块：

- `base.py`：应用主控与流程编排
  - 启动/托盘/自启动；文件识别（并发预加载）；统一的处理与导出入口；弹窗与汇总；角色/日期视图应用；异常降级与日志。
- `main.py`：六类清单的筛选实现
  - 每类文件提供 find/process/export 三段式能力；输出统一字段；特殊分支（如文件2的项目差异、文件3的 L/M 路径等）。
- `window.py`：GUI 呈现与交互
  - 表格列宽/排序/复制；行内勾选；接口号点击回填；延期高亮；“文件6”页签防重复重绘；状态覆盖（结合登记簿）。
- `input_handler.py`：回文单号写入
  - 弹窗输入；定位写回源表正确列；成功后触发登记簿 `on_response_written`；就地刷新界面勾选状态。
- `distribution.py`：任务指派
  - 读取姓名表；发现未指派记录后集中指派；保存回写。
- `date_utils.py`：日期与提醒
  - 多格式解析；工作日/自然日计算；延期判定；提醒标签生成。
- `main2.py`：导出汇总
  - 生成 TXT 摘要（含项目、条数与简要提醒），用于快速通报。
- `registry/`（可选）：事实登记簿
  - `db.py/models.py/service.py/hooks.py/util.py/config.py`；WAL/超时；任务/事件表；批量查询与状态映射；钩子容错。
- 其他：
  - `file_manager.py` 勾选状态的轻量持久化；`Monitor.py` 过程日志；`excel_processor.spec` 打包。

关键数据结构（统一列口径）：
- `原始行号`（Excel 行，便于回写）；`接口时间`（yyyy.mm.dd，空值“–”）；`责任人`（空值“无”）；`科室`（三室映射/请室主任确认）；`source_file`、`_source_column`（追踪来源）；`项目号`（文件名解析/必要时为空）。

扩展与演进建议：
- 以 DataFrame 为中心的“输入—规则—输出”保持不变；新增文件类型只需补齐 find/process/export 与列映射；
- 登记簿与界面覆盖解耦，前者先行完成“记账”，后者再做“显示偏好”，保证可回溯与可配置并存；
- 导出层可扩展 CSV/HTML 摘要，满足多渠道通报需求。
