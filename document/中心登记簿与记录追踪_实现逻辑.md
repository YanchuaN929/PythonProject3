## ç›®æ ‡

- åœ¨ä¸ç ´åç°æœ‰ findâ†’processâ†’export æµç¨‹ä¸ç•Œé¢é€»è¾‘çš„å‰æä¸‹ï¼Œæ–°å¢â€œä¸­å¿ƒç™»è®°ç°¿ + è®°å½•è¿½è¸ªâ€ï¼Œè§£å†³ï¼š
  - è®¾è®¡äººå‘˜å›å¡«åï¼Œä¸Šçº§ä»å¯è§å¹¶å¯ç¡®è®¤ï¼›
- æ‰€æœ‰è§’è‰²ï¼ˆå«è®¾è®¡äººå‘˜ï¼‰å‡å¯æŒ‰éœ€éšè—é•¿æœŸè¿‡æœŸé¡¹ï¼Œé»˜è®¤ä¸ºä¸Šçº§è§’è‰²å¼€å¯ï¼›è®¾è®¡äººå‘˜ä¹Ÿæä¾›åŒæ ·çš„è¿‡æ»¤å¼€å…³ï¼ˆå¯é…ç½®é»˜è®¤å€¼ï¼‰ï¼ˆç¬¬ä¸€æ­¥ä»…è®°å½•ï¼Œç¬¬äºŒæ­¥å†æ¥UIï¼‰ã€‚
- æ‰€æœ‰æ–°å¢é€»è¾‘æ”¾å…¥æ–°ç›®å½•ï¼Œä¸æ”¹è€å‡½æ•°è¯­ä¹‰ï¼›ä»…åœ¨æ˜ç¡®ä½ç½®è°ƒç”¨é’©å­ã€‚

## å®Œæ•´ä»»åŠ¡é€»è¾‘æè¿°

### 1. ä»»åŠ¡åˆ›å»ºä¸æ›´æ–°

**æ¯æ¬¡å¤„ç†æ–‡ä»¶æ—¶**ï¼ˆ`on_process_done` é’©å­ï¼‰ï¼š
- ç¨‹åºæ‰«æå¤„ç†åçš„ç»“æœ DataFrame
- **é€è¡Œåˆ›å»ºæˆ–æ›´æ–°ä»»åŠ¡è®°å½•**åˆ° SQLite æ•°æ®åº“
- æ¯ä¸ªä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†æ˜¯ï¼š`file_type + project_id + interface_id + source_file + row_index`
- **é¦–æ¬¡è§åˆ°**ï¼šè®°å½• `first_seen_at = å½“å‰æ—¶é—´`
- **æ¯æ¬¡è§åˆ°**ï¼šæ›´æ–° `last_seen_at = å½“å‰æ—¶é—´`ï¼Œæ›´æ–° `department`ã€`interface_time` ç­‰å­—æ®µ
- åˆå§‹çŠ¶æ€ï¼š`status = 'open'`ï¼ˆå¾…å¤„ç†ï¼‰

### 2. ä»»åŠ¡çŠ¶æ€æµè½¬

ä»»åŠ¡æœ‰ 4 ç§çŠ¶æ€ï¼š

#### open â†’ completedï¼ˆè®¾è®¡äººå‘˜å›å¡«ï¼‰
- è§¦å‘æ—¶æœºï¼šè®¾è®¡äººå‘˜åŒå‡»æ¥å£å·ï¼Œè¾“å…¥å›æ–‡å•å·åæˆåŠŸå†™å…¥ Excel
- è°ƒç”¨é’©å­ï¼š`on_response_written`
- çŠ¶æ€å˜åŒ–ï¼š`status = 'completed'`ï¼Œè®°å½• `completed_at = å½“å‰æ—¶é—´`
- å†™å…¥äº‹ä»¶ï¼š`response_written`
- **ä¸ç°æœ‰åŠŸèƒ½é›†æˆ**ï¼šè‡ªåŠ¨å‹¾é€‰è¯¥è¡Œçš„"æ˜¯å¦å·²å®Œæˆ"å¤é€‰æ¡†ï¼ˆ`file_manager.set_row_completed()`ï¼‰

#### completed â†’ confirmedï¼ˆä¸Šçº§ç¡®è®¤ï¼‰
- è§¦å‘æ—¶æœºï¼šä¸Šçº§ï¼ˆæ‰€é¢†å¯¼/å®¤ä¸»ä»»ï¼‰ç‚¹å‡»è¯¥è¡Œçš„"æ˜¯å¦å·²å®Œæˆ"å¤é€‰æ¡†
- è°ƒç”¨é’©å­ï¼š`on_confirmed_by_superior`
- çŠ¶æ€å˜åŒ–ï¼š`status = 'confirmed'`ï¼Œè®°å½• `confirmed_at = å½“å‰æ—¶é—´`
- å†™å…¥äº‹ä»¶ï¼š`confirmed`
- **ä¸ç°æœ‰åŠŸèƒ½é›†æˆ**ï¼šå¤ç”¨ç°æœ‰çš„"æ˜¯å¦å·²å®Œæˆ"å‹¾é€‰é€»è¾‘ï¼Œä¸Šçº§å‹¾é€‰æ—¶è§¦å‘ç¡®è®¤æµç¨‹

#### ä»»æ„çŠ¶æ€ â†’ archivedï¼ˆå½’æ¡£ï¼‰
- è§¦å‘æ—¶æœºï¼šä»»åŠ¡ä»æºæ–‡ä»¶æ¶ˆå¤±è¶…è¿‡ä¸€å®šå¤©æ•°ï¼ˆè§ä¸‹æ–¹"æ¶ˆå¤±ä¸å½’æ¡£"ï¼‰
- çŠ¶æ€å˜åŒ–ï¼š`status = 'archived'`ï¼Œè®°å½• `archive_reason = 'missing_from_source'`
- å†™å…¥äº‹ä»¶ï¼š`archived`
- **é‡è¦è¯´æ˜**ï¼š
  - âŒ **completed æˆ– confirmed çŠ¶æ€çš„ä»»åŠ¡ä¸ä¼šè‡ªåŠ¨å½’æ¡£**
  - âœ… **åªæœ‰ä»æºæ–‡ä»¶æ¶ˆå¤±è¶…è¿‡ 7 å¤©çš„ä»»åŠ¡æ‰ä¼šå½’æ¡£**
  - ğŸ“¦ å·²å®Œæˆå¹¶ç¡®è®¤çš„ä»»åŠ¡ä¼šæ°¸ä¹…ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤éæ‰‹åŠ¨æ¸…ç†

### 3. ä»»åŠ¡æ¶ˆå¤±ä¸å½’æ¡£

**æ¯æ¬¡æ‰«æç»“æŸæ—¶**ï¼ˆ`on_scan_finalize` é’©å­ï¼‰ï¼š

#### é˜¶æ®µ1ï¼šæ ‡è®°æ¶ˆå¤±
- éå†æ‰€æœ‰ `status = 'open'`ï¼ˆæœªå®Œæˆï¼‰çš„ä»»åŠ¡
- å¦‚æœæŸä¸ªä»»åŠ¡çš„ `last_seen_at` **ä¸æ˜¯æœ¬æ¬¡æ‰«ææ—¶é—´**ï¼ˆè¯´æ˜æœ¬æ¬¡æ²¡è§åˆ°ï¼‰
- **ä¸”** `missing_since` ä¸ºç©ºï¼ˆä¹‹å‰æ²¡æ ‡è®°è¿‡ï¼‰
- **åˆ™** æ ‡è®° `missing_since = å½“å‰æ—¶é—´`
- **å«ä¹‰**ï¼šè¿™ä¸ªä»»åŠ¡ä» Excel æºæ–‡ä»¶ä¸­æ¶ˆå¤±äº†ï¼Œå¼€å§‹è®¡æ—¶
- **æ³¨æ„**ï¼š`completed` å’Œ `confirmed` çŠ¶æ€çš„ä»»åŠ¡ä¸å‚ä¸æ­¤æ£€æŸ¥ï¼Œå³ä½¿æ¶ˆå¤±ä¹Ÿä¸ä¼šè¢«æ ‡è®° missing

#### é˜¶æ®µ2ï¼šè‡ªåŠ¨å½’æ¡£
- éå†æ‰€æœ‰å·²æ ‡è®° `missing_since` çš„ä»»åŠ¡
- å¦‚æœ `missing_since` è·ç¦»ç°åœ¨è¶…è¿‡äº† **`missing_keep_days` å¤©**ï¼ˆé»˜è®¤ 7 å¤©ï¼‰
- **åˆ™** å½’æ¡£è¯¥ä»»åŠ¡ï¼š
  - `status = 'archived'`
  - `archive_reason = 'missing_from_source'`
  - å†™å…¥äº‹ä»¶ `archived`
- **å«ä¹‰**ï¼šä»»åŠ¡æ¶ˆå¤±è¶…è¿‡ 7 å¤©ï¼Œè®¤ä¸ºæ°¸ä¹…æ¶ˆå¤±ï¼Œä¸å†è¿½è¸ª
- **é‡è¦**ï¼šç”±äºåªæœ‰ `open` çŠ¶æ€ä»»åŠ¡æ‰ä¼šè¢«æ ‡è®° missingï¼Œå› æ­¤ `completed` å’Œ `confirmed` çš„ä»»åŠ¡æ°¸è¿œä¸ä¼šè¢«è‡ªåŠ¨å½’æ¡£

### 4. ä¸¤ä¸ªç‹¬ç«‹çš„"å¤©æ•°"é…ç½®

#### é…ç½®1ï¼š`registry_missing_keep_days`ï¼ˆé»˜è®¤ 7 å¤©ï¼‰
- **ç”¨é€”**ï¼šå½’æ¡£é€»è¾‘
- **å«ä¹‰**ï¼šä»»åŠ¡ä»æºæ–‡ä»¶æ¶ˆå¤±åï¼Œä¿æŒå¤šå°‘å¤©æ‰è‡ªåŠ¨å½’æ¡£
- **å¯é…ç½®**ï¼šåœ¨ `config.json` ä¸­è®¾ç½® `"registry_missing_keep_days": 7`
- **ç”¨æˆ·å¯é€šè¿‡è°ƒç”¨ `on_scan_finalize` æ—¶ä¼ å‚è¦†ç›–**

#### é…ç½®2ï¼š`view_overdue_days_threshold`ï¼ˆé»˜è®¤ 30 å¤©ï¼‰
- **ç”¨é€”**ï¼šUI ç•Œé¢è¿‡æ»¤
- **å«ä¹‰**ï¼šä»€ä¹ˆæ˜¯"é•¿æœŸè¿‡æœŸ"çš„é˜ˆå€¼
- **åº”ç”¨åœºæ™¯**ï¼šè®¾è®¡äººå‘˜/ä¸Šçº§å¯ä»¥é€‰æ‹©"éšè—é•¿æœŸè¿‡æœŸé¡¹"ï¼Œé¿å…å¹²æ‰°
  - ä¾‹å¦‚ï¼šè¶…æœŸ 30 å¤©ä»¥ä¸Šçš„ä»»åŠ¡å¯ä»¥è¢«è¿‡æ»¤æ‰ä¸æ˜¾ç¤º
- **ä¸å½±å“**ï¼šåº•å±‚æ•°æ®å¤„ç†ã€å¯¼å‡ºã€ä»»åŠ¡çŠ¶æ€ï¼Œçº¯ UI è¿‡æ»¤
- **å¯é…ç½®**ï¼šåœ¨ `config.json` ä¸­è®¾ç½® `"view_overdue_days_threshold": 30`

### 5. äº‹ä»¶è¿½è¸ª

æ‰€æœ‰å…³é”®æ“ä½œéƒ½ä¼šå†™å…¥ `events` è¡¨ï¼š
- `process_done`ï¼šå¤„ç†å®Œæˆï¼ŒåŒ…å«è¡Œæ•°ã€é¡¹ç›®å·ç­‰
- `export_done`ï¼šå¯¼å‡ºå®Œæˆï¼ŒåŒ…å«å¯¼å‡ºæ–‡ä»¶è·¯å¾„ã€è¡Œæ•°
- `response_written`ï¼šå›æ–‡å•å·å†™å…¥ï¼ŒåŒ…å«å›æ–‡å·ã€æ“ä½œäºº
- `confirmed`ï¼šä¸Šçº§ç¡®è®¤ï¼ŒåŒ…å«ç¡®è®¤äºº
- `archived`ï¼šä»»åŠ¡å½’æ¡£ï¼ŒåŒ…å«å½’æ¡£åŸå› 

è¿™äº›äº‹ä»¶æä¾›äº†å®Œæ•´çš„å†å²è¿½è¸ªèƒ½åŠ›ã€‚

### 6. å¤šç”¨æˆ·åä½œåœºæ™¯

#### åœºæ™¯Aï¼šè®¾è®¡äººå‘˜å›å¡«åï¼Œä¸Šçº§ä»å¯è§
- **ç°çŠ¶é—®é¢˜**ï¼šè®¾è®¡äººå‘˜å›å¡«åï¼ŒExcel æ–‡ä»¶ä¸­è¯¥è¡Œå¯èƒ½ä¸å†ç¬¦åˆè¿‡æ»¤æ¡ä»¶ï¼Œä¸Šçº§çœ‹ä¸åˆ°
- **æ–°æ–¹æ¡ˆ**ï¼š
  - ä»»åŠ¡è®°å½•åœ¨æ•°æ®åº“ä¸­ï¼Œ`status = 'completed'`
  - ä¸Šçº§å¯ä»¥åœ¨ UI ä¸­çœ‹åˆ°"å·²å®Œæˆä½†æœªç¡®è®¤"çš„ä»»åŠ¡åˆ—è¡¨
  - ä¸Šçº§å¯ä»¥ç‚¹å‡»"ç¡®è®¤"ï¼Œä»»åŠ¡å˜ä¸º `confirmed`

#### åœºæ™¯Bï¼šè¿‡æ»¤é•¿æœŸè¿‡æœŸé¡¹
- **ç°çŠ¶é—®é¢˜**ï¼šæ‰€æœ‰è¿‡æœŸä»»åŠ¡éƒ½æ˜¾ç¤ºï¼Œå¹²æ‰°æŸ¥çœ‹
- **æ–°æ–¹æ¡ˆ**ï¼š
  - UI æä¾›å¼€å…³ï¼š"éšè—è¶…æœŸ 30 å¤©ä»¥ä¸Šçš„ä»»åŠ¡"
  - é»˜è®¤å¯¹ä¸Šçº§è§’è‰²å¼€å¯ï¼Œè®¾è®¡äººå‘˜å¯é€‰
  - ä»…å½±å“ç•Œé¢æ˜¾ç¤ºï¼Œä¸å½±å“æ•°æ®å®Œæ•´æ€§

### 7. "å·²å®Œæˆ"å‹¾é€‰åŠŸèƒ½ä¸Registryç³»ç»Ÿé›†æˆ

ç°æœ‰ç³»ç»Ÿå·²æœ‰å®Œæ•´çš„"å·²å®Œæˆ"å‹¾é€‰ä½“ç³»ï¼ˆ`file_manager.completed_rows`ï¼‰ï¼Œæ–°ç³»ç»Ÿå°†å¤ç”¨å¹¶æ‰©å±•æ­¤åŠŸèƒ½ï¼š

#### ç°æœ‰åŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰
- **å­˜å‚¨ç»“æ„**ï¼š`{user_name: {file_path: {row_index: True}}}`
- **æ˜¾ç¤ºé€»è¾‘**ï¼šåœ¨ç•Œé¢æ˜¾ç¤º â˜‘ï¼ˆå·²å®Œæˆï¼‰æˆ– â˜ï¼ˆæœªå®Œæˆï¼‰
- **ç”¨æˆ·éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·çš„å‹¾é€‰çŠ¶æ€ç‹¬ç«‹å­˜å‚¨
- **å¯¼å‡ºå½±å“**ï¼šå¯¼å‡ºæ—¶ä¼šæ’é™¤å·²å‹¾é€‰çš„è¡Œ

#### æ–°å¢é›†æˆé€»è¾‘

**è®¾è®¡äººå‘˜å›å¡«æ—¶ï¼ˆè‡ªåŠ¨å‹¾é€‰ï¼‰**ï¼š
```python
# input_handler.py çš„ InterfaceInputDialog.on_confirm ä¸­
if write_response_to_excel(...):  # å†™å…¥æˆåŠŸ
    # 1. è°ƒç”¨ registry é’©å­ï¼ˆçŠ¶æ€ open â†’ completedï¼‰
    hooks.on_response_written(...)
    
    # 2. è‡ªåŠ¨å‹¾é€‰"å·²å®Œæˆ"ï¼ˆä»…è®¾è®¡äººå‘˜ï¼‰
    if is_designer_role(self.user_name):
        self.file_manager.set_row_completed(
            self.file_path, 
            self.row_index, 
            True, 
            self.user_name
        )
```

**ä¸Šçº§ç¡®è®¤æ—¶ï¼ˆæ‰‹åŠ¨å‹¾é€‰ï¼‰**ï¼š
```python
# window.py çš„ _bind_checkbox_click_event ä¸­
def on_click(event):
    # ... åŸæœ‰é€»è¾‘ï¼šåˆ‡æ¢å‹¾é€‰çŠ¶æ€ ...
    file_manager.set_row_completed(source_file, original_row, new_state, user_name)
    
    # æ–°å¢ï¼šå¦‚æœæ˜¯ä¸Šçº§è§’è‰²å‹¾é€‰ï¼Œè§¦å‘ confirmed æµç¨‹
    if is_superior_role(user_name) and new_state == True:
        hooks.on_confirmed_by_superior(
            file_type=get_file_type(tab_name),
            file_path=source_file,
            row_index=original_row,
            user_name=user_name,
            project_id=get_project_id(original_df, item_index),
            now=safe_now()
        )
```

#### é€»è¾‘æµç¨‹å›¾

```
è®¾è®¡äººå‘˜æµç¨‹ï¼š
  åŒå‡»æ¥å£å· â†’ è¾“å…¥å›æ–‡å· â†’ å†™å…¥ExcelæˆåŠŸ
    â†“
  [è‡ªåŠ¨] open â†’ completed (registry)
    â†“
  [è‡ªåŠ¨] å‹¾é€‰"å·²å®Œæˆ"âœ“ (file_manager)

ä¸Šçº§æµç¨‹ï¼š
  çœ‹åˆ°å·²å®Œæˆçš„ä»»åŠ¡ â†’ æ‰‹åŠ¨ç‚¹å‡»"å·²å®Œæˆ"å‹¾é€‰æ¡†
    â†“
  [ä¿å­˜] å‹¾é€‰çŠ¶æ€ (file_manager)
    â†“
  [è§¦å‘] completed â†’ confirmed (registry)
```

#### å®ç°è¦ç‚¹
1. **è§’è‰²åˆ¤æ–­**ï¼šéœ€è¦åœ¨ `window.py` ä¸­è·å–å½“å‰ç”¨æˆ·è§’è‰²ï¼ŒåŒºåˆ†è®¾è®¡äººå‘˜å’Œä¸Šçº§
2. **file_type æ˜ å°„**ï¼šéœ€è¦ä» tab_name åæ¨ file_typeï¼ˆ1-6ï¼‰
3. **project_id è·å–**ï¼šéœ€è¦ä» DataFrame è¡Œæ•°æ®ä¸­æå–é¡¹ç›®å·
4. **å‘åå…¼å®¹**ï¼šç°æœ‰çš„å‹¾é€‰é€»è¾‘å®Œå…¨ä¿æŒä¸å˜ï¼Œregistry ä½œä¸ºé™„åŠ åŠŸèƒ½

## æ–°å¢ç›®å½•ä¸æ–‡ä»¶

- æ–°å»ºç›®å½•ï¼š`registry/`
  - `registry/db.py`ï¼šSQLite è¿æ¥ã€å»ºè¡¨ã€WAL å¼€å¯ã€åŸºç¡€CRUD
  - `registry/models.py`ï¼šæ•°æ®æ¨¡å‹ï¼ˆTaskã€Eventï¼‰ä¸æšä¸¾/å¸¸é‡
  - `registry/service.py`ï¼šé«˜é˜¶ä¸šåŠ¡ï¼šå†™ä»»åŠ¡ã€å†™äº‹ä»¶ã€ç¼ºå¤±æ£€æµ‹ã€å½’æ¡£
  - `registry/hooks.py`ï¼šä¾›ç°æœ‰ç¨‹åºè°ƒç”¨çš„ç»Ÿä¸€é’©å­APIï¼ˆæ— å‰¯ä½œç”¨è¿”å›ï¼Œä¸æŠ›å¼‚å¸¸ï¼‰
  - `registry/config.py`ï¼šé»˜è®¤é…ç½®è¯»å–ï¼ˆå¤ç”¨ `config.json`ï¼Œé”®ä¸å­˜åœ¨èµ°é»˜è®¤ï¼‰
  - `registry/util.py`ï¼štask_id ç”Ÿæˆã€å­—æ®µæå–å·¥å…·ï¼ˆæ¥å£å·/é¡¹ç›®å·/æ–‡ä»¶åç­‰ï¼‰

## æ•°æ®æ¨¡å‹ï¼ˆSQLiteï¼‰

- è¡¨ tasksï¼ˆä»»åŠ¡äº‹å®çŠ¶æ€ï¼‰
  - id TEXT PRIMARY KEYï¼ˆtask_idï¼Œè§ä¸‹èŠ‚ï¼‰
  - file_type INTEGER NOT NULL
  - project_id TEXT NOT NULL  ï¼ˆæ–‡ä»¶6è‹¥ç¼ºå››ä½å·ï¼Œä¿å­˜ä¸ºâ€œæœªçŸ¥é¡¹ç›®â€ä»¥æ»¡è¶³éç©ºï¼‰
  - interface_id TEXT NOT NULLï¼ˆç»Ÿä¸€â€œæ¥å£å·â€ï¼‰
  - source_file TEXT NOT NULL  ï¼ˆbasenameï¼‰
  - row_index INTEGER NOT NULL  ï¼ˆExcelåŸå§‹è¡Œå·ï¼‰
  - department TEXT DEFAULT ''
  - interface_time TEXT DEFAULT ''  ï¼ˆmm.dd æˆ– yyyy.mm.ddï¼‰
  - status TEXT NOT NULL DEFAULT 'open'  in ['open','completed','confirmed','archived']
  - completed_at TEXT NULL
  - confirmed_at TEXT NULL
  - first_seen_at TEXT NOT NULL
  - last_seen_at TEXT NOT NULL
  - missing_since TEXT NULL
  - archive_reason TEXT NULL
  - UNIQUE(file_type, project_id, interface_id, source_file, row_index)
  - ç´¢å¼•ï¼šfile_type+project_idã€statusã€last_seen_at

- è¡¨ eventsï¼ˆè¡Œä¸ºè¿½è¸ªï¼‰
  - id INTEGER PRIMARY KEY AUTOINCREMENT
  - ts TEXT NOT NULL
  - event TEXT NOT NULL in ['hit','miss','process_done','export_done','response_written','confirmed','archived','invalidate','clear']
  - file_type INTEGER
  - project_id TEXT
  - interface_id TEXT
  - source_file TEXT
  - row_index INTEGER
  - extra JSON TEXT

- è¿æ¥è®¾ç½®ï¼šPRAGMA journal_mode=WAL; PRAGMA busy_timeout=5000; PRAGMA synchronous=NORMAL;

## task_id ç”Ÿæˆ

- è§„åˆ™ï¼š`sha1(f"{file_type}|{project_id}|{interface_id}|{source_file_basename}|{row_index}")`
- å…³é”®å­—æ®µæ¥æºï¼š
  - file_typeï¼š1~6ï¼ˆç”±è°ƒç”¨ç‚¹ä¼ å…¥ï¼‰
  - project_idï¼šå– DataFrame çš„â€œé¡¹ç›®å·â€ï¼›è‹¥æ–‡ä»¶6ç¼ºå››ä½å·ï¼Œç»Ÿä¸€å†™å…¥â€œæœªçŸ¥é¡¹ç›®â€
  - interface_idï¼šå…­ç±»ç»Ÿä¸€æŠ½å–â€œæ¥å£å·â€ï¼ˆè¯¦è§ utilï¼‰
  - source_file_basenameï¼šä»å¤„ç†å‡½æ•°æ”¶åˆ°çš„åŸæ–‡ä»¶è·¯å¾„å– basename
  - row_indexï¼šDataFrame ä¸­â€œåŸå§‹è¡Œå·â€

## é’©å­APIï¼ˆregistry/hooks.pyï¼‰

- çº¦å®šï¼šæ‰€æœ‰é’©å­å†…éƒ¨ try/exceptï¼Œä¸å‘å¤–æŠ›å¼‚å¸¸ï¼›å¤±è´¥ä»…å†™æ—¥å¿—ã€‚
- API åˆ—è¡¨ä¸å…¥å‚ï¼š
  - `on_process_done(file_type:int, project_id:str, source_file:str, result_df:pd.DataFrame, now:datetime)`
    - é€è¡Œ upsert tasksï¼šæ›´æ–° interface_time/department/last_seen_atï¼›é¦–æ¬¡è§åˆ°å†™ first_seen_at
    - å†™ event process_doneï¼ˆextra: è¡Œæ•°/é¡¹ç›®ç­‰ï¼‰
  - `on_export_done(file_type:int, project_id:str, export_path:str, count:int, now:datetime)`
    - å†™ event export_done
  - `on_response_written(file_type:int, file_path:str, row_index:int, interface_id:str, response_number:str, user_name:str, project_id:str, source_column:Optional[str], now:datetime)`
    - ä½¿ç”¨ä¼ å…¥çš„ interface_id ç²¾ç¡®å®šä½ taskï¼›status=openâ†’completedï¼Œå†™ completed_atï¼Œå†™ event response_written
  - `on_confirmed_by_superior(file_type:int, file_path:str, row_index:int, user_name:str, project_id:str, now:datetime)`
    - ä»»æ„ä¸Šçº§è°ƒç”¨ï¼›status=completedâ†’confirmedï¼Œå†™ confirmed_atï¼Œå†™ event confirmed
  - `on_scan_finalize(batch_tag:str, now:datetime, missing_keep_days:int=7)`
    - æ‰¹æ¬¡ç»“æŸè°ƒç”¨ï¼šæ ‡è®°æœªå‡ºç°ä¸”æœªå®Œæˆçš„ä»»åŠ¡ missing_sinceï¼›è¶…è¿‡ N å¤©è‡ªåŠ¨å½’æ¡£ï¼Œå†™ event archived

## å·¥å…·å‡½æ•°ï¼ˆregistry/util.pyï¼‰

- `extract_interface_id(df_row:pd.Series, file_type:int) -> str`
  - æŒ‰æ˜ å°„å–â€œæ¥å£å·â€æ‰€åœ¨åˆ—ï¼ˆä¸ window.py/distribution.py ä¿æŒä¸€è‡´ï¼‰ï¼š
    - 1:A(0), 2:R(17), 3:C(2), 4:E(4), 5:A(0), 6:E(4)
  - è‹¥å·²æœ‰â€œæ¥å£å·â€åˆ—åˆ™ä¼˜å…ˆï¼Œå¦åˆ™æŒ‰ç´¢å¼•å›é€€
- `normalize_project_id(pid:str, file_type:int) -> str`
  - è¿”å› `pid.strip()`ï¼›è‹¥ file_type==6 ä¸”ç©ºï¼Œè¿”å› â€œæœªçŸ¥é¡¹ç›®â€
- `get_source_basename(path:str) -> str`
- `safe_now() -> datetime`

## æ¥å…¥ç‚¹ä¸æ’å…¥ä½ç½®ï¼ˆä»…æ–°å¢è°ƒç”¨ï¼Œä¸æ”¹åŸé€»è¾‘ï¼‰

- `base.py`
  - åœ¨æ‰¹é‡å¤„ç†å†…éƒ¨ï¼Œå¤„ç†å®Œæ¯ä¸€ç±»å¹¶å¾—åˆ° DataFrame åï¼Œç«‹å³ä¸ŠæŠ¥ï¼š
    - æ–‡ä»¶1ï¼šåœ¨åˆå¹¶ `self.processing_results_multi1` ä¹‹åã€è¿›å…¥æ˜¾ç¤º/å¯¼å‡ºä¹‹å‰ï¼š
      - `from registry import hooks`
      - `hooks.on_process_done(1, project_id, file_path, result, self.current_datetime)`
    - æ–‡ä»¶2~6ï¼šåŒç†ï¼Œåœ¨å„ç±»çš„â€œæœ‰ç»“æœåˆ™å†™å…¥ `processing_results_multiX`â€ä¹‹åè°ƒç”¨ã€‚
  - `export_results()` â†’ do_export æ¯ä¸€ç±»å¯¼å‡ºå®Œæˆåï¼š
    - `hooks.on_export_done(file_type, project_id, output_path, len(df), self.current_datetime)`
  - ä¸€æ¬¡å®Œæ•´æ‰«æåï¼ˆæ‰€æœ‰ç±»å‹è¯†åˆ«ä¸å¤„ç†å‡ç»“æŸï¼‰ï¼š
    - åœ¨æœ¬è½®å¤„ç†çº¿ç¨‹å›è°ƒçš„æœ«å°¾ï¼ˆä¸ Monitor/å¼¹çª—ä¹‹åï¼‰ï¼Œè°ƒç”¨ï¼š
      - `hooks.on_scan_finalize(batch_tag, self.current_datetime, missing_keep_days=7)`
      - `batch_tag = self.current_datetime.strftime('%Y%m%d%H%M%S')`

- `input_handler.py`
  - åœ¨ `InterfaceInputDialog.on_confirm` ä¸­ï¼Œ`write_response_to_excel(...)` æˆåŠŸè¿”å› True åè°ƒç”¨ï¼ˆåˆ©ç”¨ç°æœ‰ `self.interface_id`ï¼‰ï¼š
    - `from registry import hooks`
    - `hooks.on_response_written(file_type=self.file_type, file_path=self.file_path, row_index=self.row_index, interface_id=self.interface_id, response_number=response_number, user_name=self.user_name, project_id=self.project_id, source_column=self.source_column, now=safe_now())`
  - **åŒæ—¶è‡ªåŠ¨å‹¾é€‰"å·²å®Œæˆ"**ï¼š
    - å¦‚æœå½“å‰ç”¨æˆ·æ˜¯è®¾è®¡äººå‘˜ï¼Œè°ƒç”¨ `self.file_manager.set_row_completed(self.file_path, self.row_index, True, self.user_name)`
    - è¿™æ ·è®¾è®¡äººå‘˜å›å¡«åï¼Œè¯¥è¡Œè‡ªåŠ¨æ ‡è®°ä¸ºå·²å®Œæˆ

- `window.py`
  - åœ¨ `_bind_checkbox_click_event` çš„ `on_click` å¤„ç†å‡½æ•°ä¸­ï¼Œå‹¾é€‰çŠ¶æ€åˆ‡æ¢åï¼š
    - åˆ¤æ–­å½“å‰ç”¨æˆ·è§’è‰²ï¼šå¦‚æœæ˜¯ä¸Šçº§è§’è‰²ï¼ˆæ‰€é¢†å¯¼/å®¤ä¸»ä»»ï¼‰ï¼Œä¸”æ–°çŠ¶æ€ä¸º `True`ï¼ˆå‹¾é€‰ï¼‰
    - è°ƒç”¨ `hooks.on_confirmed_by_superior(file_type, source_file, original_row, user_name, project_id, safe_now())`
    - **æ³¨æ„**ï¼šéœ€è¦ä» DataFrame æˆ–å…¶ä»–é€”å¾„è·å– `file_type` å’Œ `project_id`
  - **å®ç°ç»†èŠ‚**ï¼š
    - ç°æœ‰çš„ `file_manager.set_row_completed()` ä¿æŒä¸å˜ï¼Œç»§ç»­è´Ÿè´£å‹¾é€‰çŠ¶æ€çš„æŒä¹…åŒ–
    - registry é’©å­ä½œä¸ºé™„åŠ é€»è¾‘ï¼Œä»…åœ¨ä¸Šçº§å‹¾é€‰æ—¶è§¦å‘
    - è®¾è®¡äººå‘˜å‹¾é€‰ï¼šä»…ä¿å­˜å‹¾é€‰çŠ¶æ€ï¼ˆå·²ç”± input_handler è‡ªåŠ¨å®Œæˆï¼‰
    - ä¸Šçº§å‹¾é€‰ï¼šä¿å­˜å‹¾é€‰çŠ¶æ€ + è°ƒç”¨ confirmed é’©å­

- `distribution.py`ï¼ˆå¯é€‰ï¼‰
  - `save_assignment` æˆåŠŸåè®°ä¸€æ¡ `assigned` äº‹ä»¶ï¼ˆä¸æ”¹ä»»åŠ¡çŠ¶æ€ï¼‰ï¼š
    - `hooks.write_event_only('assigned', {'file_type': file_type, 'project_id': project_id, 'interface_id': interface_id, 'source_file': file_path, 'row_index': row_index, 'extra': {'assignee': assigned_name}})`

## é…ç½®ï¼ˆregistry/config.pyï¼‰

- æ–°å¢é”®ï¼ˆè‹¥ç¼ºç”¨é»˜è®¤å€¼ï¼‰ï¼š
  - `registry_enabled`ï¼ˆboolï¼Œé»˜è®¤ Trueï¼‰
  - `registry_db_path`ï¼ˆå­—ç¬¦ä¸²ï¼Œé»˜è®¤ `result_cache/registry.db` æˆ–å…¬å…±ç›˜è·¯å¾„ï¼‰
  - `registry_missing_keep_days`ï¼ˆintï¼Œé»˜è®¤7ï¼‰
  - `registry_wal`ï¼ˆboolï¼Œé»˜è®¤ Trueï¼‰
- è§†å›¾è¿‡æ»¤ç›¸å…³ï¼ˆç¬¬äºŒæ­¥UIä½¿ç”¨ï¼‰ï¼š
  - `view_hide_overdue_for_designer_default`ï¼ˆboolï¼Œé»˜è®¤ Trueï¼Œè®¾è®¡äººå‘˜æ˜¯å¦é»˜è®¤éšè—é•¿æœŸè¿‡æœŸé¡¹ï¼‰
  - `view_overdue_days_threshold`ï¼ˆintï¼Œé»˜è®¤30ï¼Œç”¨äºâ€œé•¿æœŸè¿‡æœŸâ€çš„ç•Œé¢è¿‡æ»¤é˜ˆå€¼ï¼›ä¸å½±å“ç°æœ‰æ ‡çº¢/å¯¼å‡ºé€»è¾‘ï¼‰
- hooks é¦–è¡Œæ£€æŸ¥ `registry_enabled`ï¼Œå…³é—­åˆ™ç›´æ¥ returnã€‚

## å¹¶å‘ä¸æ€§èƒ½

- SQLite WAL + busy_timeoutï¼›å•è¿›ç¨‹å†…å…±äº«è¿æ¥ + çº¿ç¨‹é”ï¼›æ‰¹é‡å†™ process_done æ—¶ç”¨äº‹åŠ¡ã€‚

## è¿ç§»ä¸åˆå§‹åŒ–

- é¦–æ¬¡è¿è¡Œè‡ªåŠ¨å»ºåº“å»ºè¡¨ï¼›ä¸åšå†å²è¡¥å½•ã€‚
- æ–‡ä»¶6é¡¹ç›®å·ç©ºå€¼ä¸€å¾‹å­˜â€œæœªçŸ¥é¡¹ç›®â€ã€‚

## éªŒæ”¶ç‚¹

- å›æ–‡å•å·å†™å…¥åï¼Œtasks.status=completedï¼›ä¸Šçº§ç¡®è®¤åå˜ confirmedã€‚
- å‘¨æ›´ç¼ºå¤±ï¼štasks.missing_since æ ‡è®°ï¼›è¶…è¿‡ 7 å¤©è‡ªåŠ¨å½’æ¡£ï¼›events è®°å½•å®Œæ•´ã€‚
- è®¾è®¡äººå‘˜è§†å›¾ï¼šæ”¯æŒä¸€é”®éšè—â€œé•¿æœŸè¿‡æœŸâ€å¹²æ‰°é¡¹çš„è¿‡æ»¤å¼€å…³ï¼ˆé»˜è®¤å¼€å¯ï¼Œå¯å…³é—­ï¼‰ï¼›è¯¥è¿‡æ»¤ä»…ä½œç”¨äºç•Œé¢å±•ç¤ºï¼Œä¸æ”¹å˜åº•å±‚ç­›é€‰/å¯¼å‡ºä¸ä»»åŠ¡çŠ¶æ€ã€‚

---

## æ–°å¢æ–‡ä»¶éª¨æ¶ï¼ˆå‡½æ•°ç­¾å + ç©ºå®ç°ï¼‰

> è¯´æ˜ï¼šä»¥ä¸‹ä¸ºæœ€å°å¯è¯»éª¨æ¶ï¼Œå¦ä¸€ä¸ªAIæ®æ­¤è¡¥å…¨å®ç°å³å¯ã€‚

```python
# registry/config.py
import json
import os

DEFAULTS = {
    "registry_enabled": True,
    "registry_db_path": os.path.join("result_cache", "registry.db"),
    "registry_missing_keep_days": 7,
    "registry_wal": True,
}

def load_config(config_path: str = "config.json") -> dict:
    try:
        if os.path.exists(config_path):
            with open(config_path, "r", encoding="utf-8") as f:
                data = json.load(f) or {}
        else:
            data = {}
    except Exception:
        data = {}
    # å¹³é“ºè·å–ï¼Œç¼ºå¤±èµ°é»˜è®¤
    cfg = DEFAULTS.copy()
    for k in DEFAULTS:
        if k in data:
            cfg[k] = data[k]
    return cfg
```

```python
# registry/db.py
import os
import sqlite3
from typing import Optional

_CONN: Optional[sqlite3.Connection] = None

def get_connection(db_path: str, wal: bool = True) -> sqlite3.Connection:
    global _CONN
    if _CONN is not None:
        return _CONN
    os.makedirs(os.path.dirname(db_path), exist_ok=True)
    conn = sqlite3.connect(db_path, check_same_thread=False)
    conn.row_factory = sqlite3.Row
    if wal:
        try:
            conn.execute("PRAGMA journal_mode=WAL;")
        except Exception:
            pass
    try:
        conn.execute("PRAGMA busy_timeout=5000;")
        conn.execute("PRAGMA synchronous=NORMAL;")
    except Exception:
        pass
    init_db(conn)
    _CONN = conn
    return conn

def init_db(conn: sqlite3.Connection) -> None:
    cur = conn.cursor()
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS tasks (
            id TEXT PRIMARY KEY,
            file_type INTEGER NOT NULL,
            project_id TEXT NOT NULL,
            interface_id TEXT NOT NULL,
            source_file TEXT NOT NULL,
            row_index INTEGER NOT NULL,
            department TEXT DEFAULT '',
            interface_time TEXT DEFAULT '',
            status TEXT NOT NULL DEFAULT 'open',
            completed_at TEXT NULL,
            confirmed_at TEXT NULL,
            first_seen_at TEXT NOT NULL,
            last_seen_at TEXT NOT NULL,
            missing_since TEXT NULL,
            archive_reason TEXT NULL,
            UNIQUE(file_type, project_id, interface_id, source_file, row_index)
        );
        """
    )
    cur.execute("CREATE INDEX IF NOT EXISTS idx_tasks_ft_pid ON tasks(file_type, project_id);")
    cur.execute("CREATE INDEX IF NOT EXISTS idx_tasks_status ON tasks(status);")
    cur.execute("CREATE INDEX IF NOT EXISTS idx_tasks_last_seen ON tasks(last_seen_at);")
    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS events (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            ts TEXT NOT NULL,
            event TEXT NOT NULL,
            file_type INTEGER,
            project_id TEXT,
            interface_id TEXT,
            source_file TEXT,
            row_index INTEGER,
            extra TEXT
        );
        """
    )
    conn.commit()
```

```python
# registry/models.py
from dataclasses import dataclass

class Status:
    OPEN = "open"
    COMPLETED = "completed"
    CONFIRMED = "confirmed"
    ARCHIVED = "archived"

class EventType:
    PROCESS_DONE = "process_done"
    EXPORT_DONE = "export_done"
    RESPONSE_WRITTEN = "response_written"
    CONFIRMED = "confirmed"
    ARCHIVED = "archived"
    ASSIGNED = "assigned"

@dataclass
class TaskKey:
    file_type: int
    project_id: str
    interface_id: str
    source_file: str
    row_index: int
```

```python
# registry/util.py
import hashlib
import os
from datetime import datetime

def get_source_basename(path: str) -> str:
    try:
        return os.path.basename(path or "")
    except Exception:
        return ""

def normalize_project_id(pid: str, file_type: int) -> str:
    s = (pid or "").strip()
    if file_type == 6 and not s:
        return "æœªçŸ¥é¡¹ç›®"
    return s

def extract_interface_id(row, file_type: int) -> str:
    try:
        # ä¼˜å…ˆåˆ—å
        if hasattr(row, 'get') and 'æ¥å£å·' in row.index:
            v = row.get('æ¥å£å·')
            return str(v).strip() if v is not None else ""
        # å›é€€ç´¢å¼•æ˜ å°„
        idx_map = {1:0, 2:17, 3:2, 4:4, 5:0, 6:4}
        idx = idx_map.get(file_type, 0)
        if idx < len(row):
            v = row.iloc[idx]
            return str(v).strip() if v is not None else ""
        return ""
    except Exception:
        return ""

def make_task_id(file_type: int, project_id: str, interface_id: str, source_file: str, row_index: int) -> str:
    raw = f"{file_type}|{project_id}|{interface_id}|{source_file}|{row_index}"
    return hashlib.sha1(raw.encode('utf-8')).hexdigest()

def safe_now() -> datetime:
    return datetime.utcnow()
```

```python
# registry/service.py
from typing import Optional, Dict, Any
from datetime import datetime
import json
from .db import get_connection
from .models import Status, EventType
from .util import make_task_id

def upsert_task(db_path: str, wal: bool, key: Dict[str, Any], fields: Dict[str, Any], now: datetime) -> None:
    """æŒ‰å”¯ä¸€é”®(file_type, project_id, interface_id, source_file, row_index) upsert ä»»åŠ¡ã€‚"""
    conn = get_connection(db_path, wal)
    tid = make_task_id(key['file_type'], key['project_id'], key['interface_id'], key['source_file'], key['row_index'])
    conn.execute(
        """
        INSERT INTO tasks (id, file_type, project_id, interface_id, source_file, row_index, department, interface_time, status, first_seen_at, last_seen_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ON CONFLICT(id) DO UPDATE SET
          department=excluded.department,
          interface_time=excluded.interface_time,
          last_seen_at=excluded.last_seen_at
        """,
        (
            tid,
            key['file_type'], key['project_id'], key['interface_id'], key['source_file'], key['row_index'],
            fields.get('department', ''), fields.get('interface_time', ''), fields.get('status', Status.OPEN),
            now.isoformat(), now.isoformat()
        )
    )
    conn.commit()

def write_event(db_path: str, wal: bool, event: str, payload: Dict[str, Any], now: datetime) -> None:
    conn = get_connection(db_path, wal)
    conn.execute(
        "INSERT INTO events (ts, event, file_type, project_id, interface_id, source_file, row_index, extra) VALUES (?,?,?,?,?,?,?,?)",
        (
            now.isoformat(), event,
            payload.get('file_type'), payload.get('project_id'), payload.get('interface_id'),
            payload.get('source_file'), payload.get('row_index'), json.dumps(payload.get('extra') or {})
        )
    )
    conn.commit()

def mark_completed(db_path: str, wal: bool, key: Dict[str, Any], now: datetime) -> None:
    conn = get_connection(db_path, wal)
    tid = make_task_id(key['file_type'], key['project_id'], key['interface_id'], key['source_file'], key['row_index'])
    conn.execute("UPDATE tasks SET status=?, completed_at=? WHERE id=?", (Status.COMPLETED, now.isoformat(), tid))
    conn.commit()

def mark_confirmed(db_path: str, wal: bool, key: Dict[str, Any], now: datetime) -> None:
    conn = get_connection(db_path, wal)
    tid = make_task_id(key['file_type'], key['project_id'], key['interface_id'], key['source_file'], key['row_index'])
    conn.execute("UPDATE tasks SET status=?, confirmed_at=? WHERE id=?", (Status.CONFIRMED, now.isoformat(), tid))
    conn.commit()

def finalize_scan(db_path: str, wal: bool, now: datetime, missing_keep_days: int) -> None:
    """æ ‡è®°ç¼ºå¤±å¹¶å¯¹è¶…æœŸ missing è¿›è¡Œå½’æ¡£ï¼ˆmissing_from_sourceï¼‰ã€‚"""
    # éª¨æ¶ï¼šç”±å¦ä¸€ä¸ªAIè¡¥å……åŸºäº last_seen_at/missing_since çš„è®¡ç®—ä¸å½’æ¡£
    pass
```

```python
# registry/hooks.py
from typing import Optional
from datetime import datetime
import pandas as pd
from .config import load_config
from .service import upsert_task, write_event, mark_completed, mark_confirmed, finalize_scan
from .models import EventType, Status
from .util import extract_interface_id, normalize_project_id, get_source_basename, safe_now

def _cfg():
    return load_config()

def _enabled(cfg: dict) -> bool:
    return bool(cfg.get('registry_enabled', True))

def on_process_done(file_type: int, project_id: str, source_file: str, result_df: pd.DataFrame, now: Optional[datetime] = None) -> None:
    try:
        cfg = _cfg()
        if not _enabled(cfg):
            return
        now = now or safe_now()
        db_path = cfg['registry_db_path']; wal = bool(cfg.get('registry_wal', True))
        basename = get_source_basename(source_file)
        # è¡Œçº§ upsert
        for _, row in (result_df or pd.DataFrame()).iterrows():
            pid = normalize_project_id(str(row.get('é¡¹ç›®å·', project_id)), file_type)
            iid = extract_interface_id(row, file_type)
            if not iid:
                continue
            key = {
                'file_type': file_type,
                'project_id': pid,
                'interface_id': iid,
                'source_file': basename,
                'row_index': int(row.get('åŸå§‹è¡Œå·', 0) or 0),
            }
            fields = {
                'department': str(row.get('ç§‘å®¤', '') or ''),
                'interface_time': str(row.get('æ¥å£æ—¶é—´', '') or ''),
                'status': Status.OPEN,
            }
            upsert_task(db_path, wal, key, fields, now)
        write_event(db_path, wal, EventType.PROCESS_DONE, {
            'file_type': file_type, 'project_id': project_id, 'source_file': basename,
            'extra': {'rows': int(len(result_df) if result_df is not None else 0)}
        }, now)
    except Exception:
        pass

def on_export_done(file_type: int, project_id: str, export_path: str, count: int, now: Optional[datetime] = None) -> None:
    try:
        cfg = _cfg()
        if not _enabled(cfg):
            return
        now = now or safe_now()
        db_path = cfg['registry_db_path']; wal = bool(cfg.get('registry_wal', True))
        write_event(db_path, wal, EventType.EXPORT_DONE, {
            'file_type': file_type, 'project_id': project_id,
            'source_file': get_source_basename(export_path), 'extra': {'count': int(count)}
        }, now)
    except Exception:
        pass

def on_response_written(file_type: int, file_path: str, row_index: int, interface_id: str, response_number: str, user_name: str, project_id: str, source_column: Optional[str] = None, now: Optional[datetime] = None) -> None:
    try:
        cfg = _cfg()
        if not _enabled(cfg):
            return
        now = now or safe_now()
        db_path = cfg['registry_db_path']; wal = bool(cfg.get('registry_wal', True))
        key = {
            'file_type': file_type,
            'project_id': normalize_project_id(project_id, file_type),
            'interface_id': (interface_id or "").strip(),
            'source_file': get_source_basename(file_path),
            'row_index': int(row_index or 0),
        }
        mark_completed(db_path, wal, key, now)
        write_event(db_path, wal, EventType.RESPONSE_WRITTEN, {
            'file_type': file_type, 'project_id': key['project_id'], 'source_file': key['source_file'], 'row_index': key['row_index'],
            'extra': {'response_number': response_number, 'user_name': user_name, 'source_column': source_column}
        }, now)
    except Exception:
        pass

def on_confirmed_by_superior(file_type: int, file_path: str, row_index: int, user_name: str, project_id: str, now: Optional[datetime] = None) -> None:
    try:
        cfg = _cfg()
        if not _enabled(cfg):
            return
        now = now or safe_now()
        db_path = cfg['registry_db_path']; wal = bool(cfg.get('registry_wal', True))
        key = {
            'file_type': file_type,
            'project_id': normalize_project_id(project_id, file_type),
            'interface_id': "",  # åŒä¸Šï¼šå®Œå–„å®ç°æ—¶è¡¥é½
            'source_file': get_source_basename(file_path),
            'row_index': int(row_index or 0),
        }
        mark_confirmed(db_path, wal, key, now)
        write_event(db_path, wal, EventType.CONFIRMED, {
            'file_type': file_type, 'project_id': key['project_id'], 'source_file': key['source_file'], 'row_index': key['row_index'],
            'extra': {'user_name': user_name}
        }, now)
    except Exception:
        pass

def on_scan_finalize(batch_tag: str, now: Optional[datetime] = None, missing_keep_days: Optional[int] = None) -> None:
    try:
        cfg = _cfg()
        if not _enabled(cfg):
            return
        now = now or safe_now()
        db_path = cfg['registry_db_path']; wal = bool(cfg.get('registry_wal', True))
        days = int(missing_keep_days if missing_keep_days is not None else int(cfg.get('registry_missing_keep_days', 7)))
        finalize_scan(db_path, wal, now, days)
    except Exception:
        pass

def write_event_only(event: str, payload: dict) -> None:
    try:
        cfg = _cfg()
        if not _enabled(cfg):
            return
        db_path = cfg['registry_db_path']; wal = bool(cfg.get('registry_wal', True))
        write_event(db_path, wal, event, payload, safe_now())
    except Exception:
        pass
```

---

## å¦ä¸€AIçš„æ‰§è¡Œé¡ºåºï¼ˆåˆ†æ­¥æ¸…å•ï¼‰

1) åˆ›å»ºç›®å½• `registry/` å¹¶æ–°å¢ 6 ä¸ªæ–‡ä»¶ï¼š`db.py` `models.py` `service.py` `hooks.py` `config.py` `util.py`ï¼›ç²˜è´´ä¸Šè¿°éª¨æ¶ã€‚
2) åœ¨ `base.py` çš„æ‰¹é‡å¤„ç†å¤„ï¼ˆæ¯ä¸€ç±»åˆå¹¶ `processing_results_multiX` åï¼‰å¢è°ƒç”¨ï¼š`hooks.on_process_done(...)`ã€‚
3) åœ¨ `base.py` çš„ `export_results()` ä¸­æ¯ä¸ªå¯¼å‡ºå®Œæˆåå¢ï¼š`hooks.on_export_done(...)`ã€‚
4) åœ¨å¤„ç†çº¿ç¨‹ç»“æŸï¼ˆæ‰€æœ‰ç±»åˆ«å¤„ç†åï¼‰è°ƒç”¨ï¼š`hooks.on_scan_finalize(batch_tag, now)`ã€‚
5) åœ¨ `input_handler.write_response_to_excel` æˆåŠŸè¿”å› True å‰å¢ï¼š`hooks.on_response_written(...)`ã€‚
6) å¯é€‰ï¼š`distribution.save_assignment` æˆåŠŸåå†™ä¸€ä¸ª `assigned` äº‹ä»¶ï¼ˆ`hooks.write_event_only(...)`ï¼‰ã€‚
7) è‹¥éœ€è¦ï¼Œå°† `registry_db_path` æŒ‡å‘å…¬å…±ç›˜å…±äº«è·¯å¾„ï¼›å¦åˆ™é»˜è®¤ä½¿ç”¨ `result_cache/registry.db`ã€‚


