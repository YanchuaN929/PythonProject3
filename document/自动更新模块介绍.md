# 自动更新模块介绍

## 1. 功能概述
- **目的**：确保客户端在开机自启、定时任务或手动执行前自动比对服务器端版本，发现差异即静默更新，以减少人工发版操作并保持一致性。
- **版本识别**：通过本地 `version.json` 与共享盘 `EXE/version.json` 对比（版本号格式 `YYYY.MM.DD.N`，示例 `2025.11.23.1`）。服务器路径当前示例：`D:\Programs\接口筛选\测试文件\EXE`。
- **更新流程**：
  1. 在 GUI 入口、自动流程 `_run_auto_flow`、手动 `start_processing`、`export_results` 等关键节点统一调用 `UpdateManager.check_and_update()`。
  2. 若版本一致，立即返回继续后续逻辑；若落后，则弹窗提示（自动模式仅打印日志）、记录监控日志。
  3. 自动启动 `update.exe`（PyInstaller 产物），复制共享盘 `EXE` 全量文件到本地程序目录（先复制到临时目录，再原子覆盖），写入最新 `version.json`，最后通过 `post_update_stub.bat`（调试用）或真实主程序重新拉起并附带 `--resume` 参数，以便更新后继续未完成操作。

## 2. 模块架构
```
update/
  __init__.py         # 暴露 UpdateManager 等对外 API
  versioning.py       # version.json 的读取、解析、比较
  manager.py          # 面向 GUI 的版本检查逻辑、通知、update.exe 调用器
  updater_cli.py      # update.exe 的 CLI 脚本，负责等待主程序退出、复制覆盖、重启
post_update_stub.bat  # 测试阶段代替主程序的重启入口，仅记录参数
version.json          # 本地版本标记，PyInstaller datas 打包输出
```

### 2.1 `versioning.py`
- `read_version(path)`：返回指定文件内版本号，容错（文件缺失/损坏返回 `0.0.0.0`）。
- `compare_versions(local, remote)` / `parse_version()`：统一以四段整数 `[Year, Month, Day, Build]` 比较，兼容日期规则。

### 2.2 `manager.py`
- `UpdateManager` 封装：
  - `_detect_app_root()`：兼容开发环境/打包环境。
  - `_resolve_remote_dir(folder_path)`：根据配置计算共享盘 `EXE` 路径，并避免本地/远程同路径导致死循环。
  - `_notify_user()`：GUI 模式弹窗提示，自动模式仅日志。
  - `_launch_update_exe()`：优先调用打包后的 `update.exe`，开发环境退回 `python update/updater_cli.py`。
  - `_ensure_up_to_date(reason, resume_action)`：供 `base.py` 在核心操作前统一调用。
- `UpdateReason`：枚举（`AUTO_FLOW`, `START_PROCESSING`, `EXPORT_RESULTS`）用于 resume 场景识别。

### 2.3 `updater_cli.py`
- CLI 参数：`--remote、--local、--version、--resume、--main-exe、--auto-mode`。
- 步骤：
  1. `wait_for_main_exit()`：轮询直到主程序可写（避免文件占用）。
  2. `copy_directory_atomic()`：先复制到临时目录，再使用 `sync_directory()` 原子替换，保障完整性。
  3. 覆盖 `version.json`、`server_marker.txt` 等资源。
  4. `restart_main_program()`：重新启动主程序或 `post_update_stub.bat`，自动模式附加 `--auto`、`--resume` 参数以恢复流程。

### 2.4 GUI 集成 (`base.py`/`window.py`)
- `ExcelProcessorApp` 在初始化阶段计算 `current_version` 并传递给 `WindowManager`，GUI 右下角显示“版本：xxxx”。
- 自动/手动操作前均调用 `_ensure_up_to_date()`：若返回 `False`，说明已经触发更新，此次操作中止，待更新完成后通过 `--resume` 自动恢复。
- `post_update_log.txt` 记录每次模拟重启的参数，便于调试。

## 3. 打包配置
- `excel_processor.spec` 中：
  - 将 `update/` 模块及 `version.json` 加入主程序 datas/hiddenimports。
  - 新增 `update_analysis` / `update_exe`，保证 PyInstaller 输出 `update.exe` 与主程序同目录。
- `tests/test_build_spec_integrity.py`：在 CI/本地执行 `pytest` 时验证 spec 是否包含 `update`、`registry`、`version.json` 等关键条目，防止打包遗漏。

## 4. 测试结果
### 4.1 Pytest
- `tests/test_update_manager.py`：使用 `tmp_path` 模拟本地/远程版本，验证更新触发条件、缺失版本文件时的容错、resume 参数等。
- `tests/test_updater_cli.py`：在临时目录下模拟复制流程，确保 update CLI 会复制文件并重新启动主程序。
- `tests/test_build_spec_integrity.py`：自动检查 `excel_processor.spec` 是否含有 `version.json`、`registry`、`update_exe` 等片段。
  - 命令示例：`pytest tests/test_update_manager.py tests/test_updater_cli.py tests/test_build_spec_integrity.py`
  - 结果：全部通过，仅残留 pandas 对 distutils 的 DeprecationWarning（因 Win7 兼容依赖，属预期）。

### 4.2 真实环境模拟
- **服务器目录**：`D:\Programs\接口筛选\测试文件\EXE`（网络共享盘场景可映射 UNC 路径）。
- **手动流程**（`reason=START_PROCESSING`）：
  - 本地 `2025.11.21.1` → 服务器 `2025.11.22.1`。
  - 运行临时脚本调用 `UpdateManager` 后，`version.json` 成功升级，`post_update_stub.bat` 记录 `--resume start_processing`。
- **自动流程**（`reason=AUTO_FLOW`，`auto_mode=True`）：
  - 服务器版本继续提升至 `2025.11.23.1`。
  - 再次运行自动脚本，`update.exe` 带 `--auto-mode` 参数重启，`post_update_stub.bat` 记录 `--auto --resume auto_flow`。
- **验证项**：
  - 本地 `version.json` 逐步提升至 23.1，与服务器保持一致。
  - `server_marker.txt` 中的版本号与本地复制物一致，可用作追踪当前 EXE 来源。
  - 整个过程中 GUI 未被真实拉起（通过 `post_update_stub.bat` 替代），但流程与生产环境一致，可放心切换。

## 5. 使用建议
1. **发布流程**：在服务器 `EXE` 目录准备最新版本（含 `version.json`、`update.exe`、`post_update_stub.bat` 或真实主程序），然后手动触发一次 `start_processing`/自动任务即可完成自更新。
2. **调试/排障**：
   - 查看 `post_update_log.txt`、`server_marker.txt`、`version.json` 判断是否已完成复制。
   - 若需跳过更新，可临时将 `version.json` 同步，或在离线环境下确保 `_ensure_up_to_date` 返回 `True`。
3. **扩展**：若未来需要跨域同步或签名校验，可在 `updater_cli.py` 中扩充校验逻辑，或在 `manager.py` 中加密通信。

以上即自动更新模块的逻辑、架构及测试汇总，后续如需新的部署规范或 CI 集成，可在此文基础上扩展。 

