# æ¥å£ç­›é€‰ç¨‹åº - é—ç•™é—®é¢˜ä¸ä¼˜åŒ–æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: 2025.12.08 v3  
> **çŠ¶æ€**: éƒ¨åˆ†å®Œæˆ

---

## ä¸€ã€ç°æœ‰ä¼˜åŒ–æªæ–½ï¼ˆå·²å®ç°ï¼‰

ä»¥ä¸‹åŠŸèƒ½**å·²ç»å®ç°**ï¼Œæ— éœ€é‡å¤å¼€å‘ï¼š

| åŠŸèƒ½ | å®ç°ä½ç½® | è¯´æ˜ |
|------|----------|------|
| âœ… å¹¶è¡Œæ–‡ä»¶è¯»å– | `base.py:165` | `ThreadPoolExecutor` å¹¶å‘è¯»å–Excel |
| âœ… æ–‡ä»¶ç¼“å­˜æœºåˆ¶ | `file_manager.py` | åŸºäºæ–‡ä»¶å“ˆå¸Œçš„pklç¼“å­˜ |
| âœ… æ•°æ®åº“ç´¢å¼• | `registry/db.py:311-360` | 5ä¸ªä»»åŠ¡è¡¨ç´¢å¼• + 3ä¸ªäº‹ä»¶è¡¨ç´¢å¼• |
| âœ… WALæ¨¡å¼è‡ªåŠ¨åˆ‡æ¢ | `registry/db.py:220` | æœ¬åœ°ç”¨WALï¼Œç½‘ç»œç›˜ç”¨DELETE |
| âœ… é‡è¯•æœºåˆ¶ | `registry/hooks.py:25` | é”å®šæ—¶æŒ‡æ•°é€€é¿é‡è¯• |

---

## äºŒã€âœ… æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ ç´¢å¼•ï¼ˆå·²å®Œæˆï¼‰

### 2.1 é—®é¢˜æè¿°

å½“å‰ç´¢å¼•ä¸å¤Ÿï¼Œ**æ‰€æœ‰6ä¸ªæ–‡ä»¶ç±»å‹**ï¼ˆ`process_target_file` åˆ° `process_target_file6`ï¼‰çš„ Registry æŸ¥è¯¢éƒ½è¾ƒæ…¢ã€‚

### 2.2 è§£å†³æ–¹æ¡ˆï¼ˆå·²å®æ–½ï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `registry/db.py`

åœ¨ `init_db()` å‡½æ•°ä¸­æ·»åŠ äº†3ä¸ªæ–°ç´¢å¼•ï¼š

```python
# 2025-12-08: æ–°å¢ç´¢å¼•ä¼˜åŒ– Registry æŸ¥è¯¢æ€§èƒ½
cur.execute("CREATE INDEX IF NOT EXISTS idx_tasks_interface_id ON tasks(interface_id);")
cur.execute("CREATE INDEX IF NOT EXISTS idx_tasks_display_status ON tasks(display_status);")
cur.execute("CREATE INDEX IF NOT EXISTS idx_tasks_lookup ON tasks(file_type, project_id, interface_id);")
```

**é¢„æœŸæ•ˆæœ**ï¼šRegistryæŸ¥è¯¢é€Ÿåº¦æå‡ 50%+

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼ˆ2025-12-08ï¼‰

---

## ä¸‰ã€çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆ

### 3.1 ç“¶é¢ˆåˆ†æ

| ç“¶é¢ˆ | åŸå›  | å½±å“ |
|------|------|------|
| **Registryå†™å…¥ä¸²è¡ŒåŒ–** | æ‰€æœ‰ç”¨æˆ·çš„å†™å…¥æ“ä½œæ’é˜Ÿç­‰å¾… | ğŸ”´ é«˜ |
| **ç½‘ç»œç›˜æ–‡ä»¶é”ä¸å¯é ** | SMB/CIFSåè®®å›ºæœ‰é™åˆ¶ | ğŸ”´ é«˜ |
| **RegistryæŸ¥è¯¢åœ¨æ˜¾ç¤ºæ—¶** | æ¯æ¬¡æ˜¾ç¤ºéƒ½æŸ¥è¯¢æ•°æ®åº“ | ğŸŸ¡ ä¸­ |

### 3.2 å·²æœ‰ç¼“å­˜ä¸ºä½•ä¸ç”Ÿæ•ˆï¼Ÿ

**åˆ†æ**ï¼š
1. `FileIdentityManager` çš„ç¼“å­˜æ˜¯**é’ˆå¯¹Excelè¯»å–ç»“æœ**çš„
2. **RegistryæŸ¥è¯¢æ²¡æœ‰è¢«ç¼“å­˜**
3. æ¯æ¬¡ `get_display_status` éƒ½ä¼šæŸ¥è¯¢ç½‘ç»œç›˜æ•°æ®åº“

**è¯æ®**ï¼šæŸ¥çœ‹ `registry/service.py` çš„ `get_display_status` å‡½æ•°ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½æ‰§è¡Œ SQL æŸ¥è¯¢ã€‚

---

## å››ã€ä¼˜åŒ–æ–¹æ¡ˆï¼šRegistry æŸ¥è¯¢ç¼“å­˜

### 4.1 è®¾è®¡æ€è·¯

```
å½“å‰æµç¨‹ï¼š
    æ˜¾ç¤ºæ•°æ® â†’ æŸ¥è¯¢Registryï¼ˆç½‘ç»œIOï¼‰â†’ è¿”å›çŠ¶æ€
    
ä¼˜åŒ–åï¼š
    æ˜¾ç¤ºæ•°æ® â†’ æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ â†’ å‘½ä¸­åˆ™è¿”å›
                      â†“ æœªå‘½ä¸­
               æŸ¥è¯¢Registry â†’ æ›´æ–°ç¼“å­˜ â†’ è¿”å›
```

### 4.2 å®ç°æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**: `registry/service.py`

```python
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ 
_display_status_cache = {}
_cache_timestamp = 0
_CACHE_TTL = 60  # ç¼“å­˜æœ‰æ•ˆæœŸ60ç§’

def _is_cache_valid() -> bool:
    """æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ"""
    import time
    return time.time() - _cache_timestamp < _CACHE_TTL

def invalidate_display_cache():
    """ä½¿ç¼“å­˜å¤±æ•ˆï¼ˆå†™å…¥æ“ä½œåè°ƒç”¨ï¼‰"""
    global _cache_timestamp
    _cache_timestamp = 0

def get_display_status_with_cache(
    db_path: str,
    wal: bool,
    file_type: int,
    project_id: str,
    df_interface_ids: list,
    current_user_name: str,
    user_roles: list,
    source_file: str
) -> dict:
    """å¸¦ç¼“å­˜çš„çŠ¶æ€æŸ¥è¯¢"""
    global _display_status_cache, _cache_timestamp
    
    cache_key = f"{file_type}|{project_id}|{source_file}"
    
    # æ£€æŸ¥ç¼“å­˜
    if _is_cache_valid() and cache_key in _display_status_cache:
        cached = _display_status_cache[cache_key]
        # æ ¹æ®å½“å‰ç”¨æˆ·è§’è‰²è¿‡æ»¤
        return _filter_by_role(cached, current_user_name, user_roles)
    
    # ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡ŒæŸ¥è¯¢
    result = get_display_status(
        db_path, wal, file_type, project_id,
        df_interface_ids, current_user_name, user_roles, source_file
    )
    
    # æ›´æ–°ç¼“å­˜
    _display_status_cache[cache_key] = result
    _cache_timestamp = time.time()
    
    return result
```

### 4.3 é›†æˆä¿®æ”¹

**ä¿®æ”¹æ–‡ä»¶**: `registry/hooks.py`

```python
# åœ¨ on_process_done æˆåŠŸåæ·»åŠ 
from registry.service import invalidate_display_cache
invalidate_display_cache()
```

**é¢„æœŸæ•ˆæœ**ï¼š
- é¦–æ¬¡æŸ¥è¯¢ï¼šæ­£å¸¸é€Ÿåº¦
- 60ç§’å†…é‡å¤æŸ¥è¯¢ï¼šç¬é—´è¿”å›ï¼ˆ<10msï¼‰
- å†™å…¥åï¼šç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ

---

## äº”ã€UI å“åº”ä¼˜åŒ–

### 5.1 é—®é¢˜æè¿°

ç‚¹å‡»"å¼€å§‹å¤„ç†"åï¼ŒUI ä¼šå¡é¡¿ç›´åˆ°å¤„ç†å®Œæˆã€‚

### 5.2 å½“å‰çŠ¶æ€

`start_processing` ä½¿ç”¨ `root.after` è°ƒåº¦ï¼Œä½†å¤„ç†é€»è¾‘æœ¬èº«**ä»åœ¨ä¸»çº¿ç¨‹**æ‰§è¡Œã€‚

### 5.3 ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰ï¼‰

å¦‚æœå¡é¡¿ä¸¥é‡ï¼Œå¯ä»¥å°†å¤„ç†é€»è¾‘æ”¾åˆ°åå°çº¿ç¨‹ï¼š

```python
def start_processing_async(self):
    """å¼‚æ­¥å¼€å§‹å¤„ç†"""
    import threading
    
    # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
    self.process_btn.config(state='disabled')
    self.status_label.config(text="æ­£åœ¨å¤„ç†...")
    
    def _worker():
        try:
            self._do_processing()  # å®é™…å¤„ç†é€»è¾‘
        finally:
            # å›åˆ°ä¸»çº¿ç¨‹æ›´æ–°UI
            self.root.after(0, self._on_processing_done)
    
    thread = threading.Thread(target=_worker, daemon=True)
    thread.start()

def _on_processing_done(self):
    """å¤„ç†å®Œæˆå›è°ƒï¼ˆä¸»çº¿ç¨‹ï¼‰"""
    self.process_btn.config(state='normal')
    self.status_label.config(text="å¤„ç†å®Œæˆ")
```

---

## å…­ã€é—ç•™é—®é¢˜æ¸…å•

### 6.1 âœ… "å¹»è§‰"é—®é¢˜ï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜**ï¼š**æ‰€æœ‰6ä¸ªæ–‡ä»¶ç±»å‹**éƒ½ä¼šå‡ºç°ä¸åº”è¯¥æ˜¾ç¤ºçš„æ•°æ®ï¼ˆ2024å¹´ã€å…¶ä»–ç§‘å®¤ã€æ— æ—¥æœŸï¼‰

**ä¿®å¤å†…å®¹**ï¼ˆ2025-12-08ï¼‰ï¼š
1. **é™åˆ¶æŸ¥è¯¢èŒƒå›´**ï¼šRegistry æŸ¥è¯¢åªè¿”å› `display_status IN ('å¾…å®¡æŸ¥', 'å¾…æŒ‡æ´¾äººå®¡æŸ¥')` çš„ä»»åŠ¡
2. **å¢åŠ ç§‘å®¤ç­›é€‰**ï¼šåŠ å›ä»»åŠ¡æ—¶å¿…é¡»é€šè¿‡ `process1_rows` æ£€æŸ¥
3. **æ–°å¢3ä¸ªç´¢å¼•**ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

**ä¿®å¤çš„æ–‡ä»¶**ï¼š
- `main.py`: 6ä¸ª `process_target_file*` å‡½æ•°
- `registry/db.py`: æ·»åŠ 3ä¸ªæ–°ç´¢å¼•

**æµ‹è¯•**ï¼š`tests/test_registry_phantom_fix.py` (14ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡)

---

### 6.2 âœ… ç®¡ç†å‘˜è§’è‰²çŠ¶æ€æ˜¾ç¤ºï¼ˆå·²ç¡®è®¤æ­£ç¡®ï¼‰

**ç°è±¡**ï¼šç®¡ç†å‘˜æŸ¥çœ‹æ— è´£ä»»äººä»»åŠ¡æ—¶æ˜¾ç¤º"å¾…å®Œæˆ"ï¼Œè€Œé"è¯·æŒ‡æ´¾"

**è®¾è®¡å†³ç­–**ï¼ˆ2025-12-08 ç”¨æˆ·ç¡®è®¤ï¼‰ï¼š
- ç®¡ç†å‘˜ç»Ÿä¸€æ˜¾ç¤º"å¾…å®Œæˆ"ï¼Œä¸éœ€è¦çœ‹åˆ°"è¯·æŒ‡æ´¾"
- åªæœ‰æ‰€é¢†å¯¼/å®¤ä¸»ä»»/æ¥å£å·¥ç¨‹å¸ˆéœ€è¦çœ‹åˆ°"è¯·æŒ‡æ´¾"æç¤º

**çŠ¶æ€**ï¼šâœ… æ— éœ€ä¿®å¤ï¼Œå½“å‰è¡Œä¸ºæ­£ç¡®

---

### 6.3 ğŸŸ¢ æ‡’äººç®¡ç†æ¨¡å¼ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**éœ€æ±‚**ï¼šç”¨æˆ·å¯é€‰æ‹©éšè—è¶…è¿‡30å¤©å»¶æœŸçš„æ¥å£æ•°æ®

**ç°æœ‰åŠŸèƒ½**ï¼š`hide_previous_months` é…ç½®é¡¹ï¼ˆåŠŸèƒ½ä¸åŒï¼Œæ— æ³•å¤ç”¨ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šè§ `document/7_Registryæ¶æ„å‡çº§æ–¹æ¡ˆ.md` ç¬¬åä¸€èŠ‚

---

## ä¸ƒã€æ‰§è¡Œä¼˜å…ˆçº§

| é¡ºåº | ä»»åŠ¡ | è€—æ—¶ | æ•ˆæœ | çŠ¶æ€ |
|------|------|------|------|------|
| 1 | æ·»åŠ 3ä¸ªæ–°ç´¢å¼• | 10åˆ†é’Ÿ | æŸ¥è¯¢æé€Ÿ50% | âœ… å·²å®Œæˆ |
| 2 | ä¿®å¤"å¹»è§‰"é—®é¢˜ | 2å°æ—¶ | æ¶ˆé™¤é”™è¯¯æ•°æ® | âœ… å·²å®Œæˆ |
| 3 | ç®¡ç†å‘˜è§’è‰²æ˜¾ç¤º | - | - | âœ… æ— éœ€ä¿®å¤ |
| 4 | å®ç° Registry æŸ¥è¯¢ç¼“å­˜ | 1å°æ—¶ | é‡å¤æŸ¥è¯¢ç¬é—´è¿”å› | â³ å¾…æ‰§è¡Œ |
| 5 | (å¯é€‰) UI å¼‚æ­¥åŒ– | 3å°æ—¶ | ç•Œé¢ä¸å¡é¡¿ | â³ å¾…æ‰§è¡Œ |

---

## å…«ã€ç‰ˆæœ¬æ›´æ–°è®°å½•

### 2025.12.08 v4
- âœ… **æ–°å¢**ï¼šæœ¬åœ°åªè¯»ç¼“å­˜ `registry/local_cache.py`
- âœ… **æ–°å¢**ï¼šå†™å…¥é˜Ÿåˆ—åŒ– `registry/write_queue.py`
- âœ… **æ–°å¢**ï¼šè¯»å†™åˆ†ç¦»å‡½æ•°ï¼ˆ`registry/db.py`ï¼‰
- âœ… **æ–°å¢**ï¼šé…ç½®é¡¹ï¼ˆæœ¬åœ°ç¼“å­˜ã€å†™å…¥é˜Ÿåˆ—ã€æŸ¥è¯¢ç¼“å­˜ï¼‰
- âœ… **æ–°å¢**ï¼šæµ‹è¯•ç”¨ä¾‹ `tests/test_registry_cache_queue.py` (15ä¸ªæµ‹è¯•)

### 2025.12.08 v3
- âœ… **ä¿®å¤**ï¼š"å¹»è§‰"é—®é¢˜ï¼ˆæ–¹æ¡ˆAï¼Œæ‰€æœ‰6ä¸ªæ–‡ä»¶ç±»å‹ï¼‰
- âœ… **æ–°å¢**ï¼š3ä¸ªæ–°ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- âœ… **æ–°å¢**ï¼šæµ‹è¯•ç”¨ä¾‹ `tests/test_registry_phantom_fix.py` (14ä¸ªæµ‹è¯•)

### 2025.12.05 v2
- **ä¿®æ­£**ï¼šåˆ é™¤é”™è¯¯çš„"å¹¶è¡Œè¯»å–"å’Œ"ç¼“å­˜æœºåˆ¶"å»ºè®®ï¼ˆå·²å®ç°ï¼‰
- **æ–°å¢**ï¼šçœŸæ­£çš„ç“¶é¢ˆåˆ†æ
- **æ–°å¢**ï¼šRegistry æŸ¥è¯¢ç¼“å­˜æ–¹æ¡ˆ
- **æ•´ç†**ï¼šæ‰§è¡Œä¼˜å…ˆçº§

### 2025.12.05 v1
- æ•´åˆæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ
- æ·»åŠ é›†æˆæµ‹è¯•æ‰§è¡Œè®¡åˆ’

### 2025.12.01.1
- âœ… æ•°æ®åº“é”å®šé—®é¢˜ä¿®å¤
- âœ… è‡ªåŠ¨æ›´æ–°ç¨‹åºå¡ä½é—®é¢˜ä¿®å¤

---

*æ–‡æ¡£æ›´æ–°æ—¶é—´: 2025-12-08*
