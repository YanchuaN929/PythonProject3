# 接口筛选程序 - 遗留问题与待优化项

> **版本**: 2025.11.25.13  
> **整合自**: 原有25份说明文档中的问题分析

---

## 1. 已知遗留问题

### 1.1 🟡 并发竞争条件（中风险）

**问题描述**:  
两个用户同时操作同一任务时可能出现竞争条件（TOCTOU问题）

**场景**:
```
T0: 设计人员填写回文单号 → status = completed
T1: 上级打开界面，读取状态 → 权限检查通过
T2: 设计人员清空回文单号 → status = open
T3: 上级点击确认 → 错误地确认了open状态的任务
```

**影响**: 未完成的任务被错误标记为已确认

**建议修复方案**: 
- 方案1：添加`version`字段实现乐观锁
- 方案2：在`mark_confirmed`中二次验证状态

**当前状态**: 未修复（发生概率低，需多用户同时操作）

---

### 1.2 🟡 刷新延迟导致状态不一致（中风险）

**问题描述**:  
勾选框点击后100ms延迟刷新期间，用户快速连续点击可能导致状态混乱

**场景**:
```
T0: 上级点击确认
T50ms: 用户误以为未生效，再次点击
T100ms: 第一次刷新执行
结果: 确认→取消确认，与用户意图相反
```

**影响**: UI闪烁、操作混乱

**建议修复方案**:
- 添加防抖（debounce）机制
- 或：点击后禁用勾选框，刷新后恢复

**当前状态**: 未修复

---

### 1.3 🟢 设计人员完成后勾选框状态不直观（低风险）

**问题描述**:  
设计人员填写回文单号后，勾选框仍为空（☐），用户可能困惑

**现状**:
- 设计人员完成任务 → 勾选框仍为☐
- 只有上级确认后 → 勾选框才变☑

**影响**: 用户体验，不影响功能

**建议修复方案**: 
- 可考虑显示半勾选状态（如☐▸）
- 或添加"待审查"标签提示

**当前状态**: 设计决策，非Bug

---

## 2. 待实现功能（Registry模块剩余5%）

### 2.1 历史视图UI（约2%工作量）

**功能描述**:
- 独立查看已完成、已确认、已归档的任务
- 支持按项目号、时间范围筛选
- 可导出历史记录

**现状**: 已有`history_ui.py`基础查询功能，可按需扩展

**优先级**: 🟡 中

---

### 2.2 长期过期项UI过滤（约1%工作量）

**功能描述**:
- 隐藏超期30天以上的任务（仅UI显示）
- 设置中可配置开关和天数阈值

**现状**: 未实现

**优先级**: 🟢 低

---

### 2.3 性能索引优化（约1%工作量）

**可添加的索引**:
```sql
CREATE INDEX idx_tasks_interface_id ON tasks(interface_id);
CREATE INDEX idx_tasks_completed_at ON tasks(completed_at);
CREATE INDEX idx_tasks_confirmed_at ON tasks(confirmed_at);
CREATE INDEX idx_tasks_missing_since ON tasks(missing_since);
```

**现状**: 当前性能已足够，数据量增大后可按需添加

**优先级**: 🟢 低

---

### 2.4 完整集成测试（约1%工作量）

**功能描述**:
- 端到端测试完整工作流
- 模拟真实用户操作

**现状**: 已有单元测试，覆盖核心功能

**优先级**: 🟡 中

---

## 3. 已修复的历史问题（供参考）

### 3.1 ✅ 室主任显示时间限制不统一

**原问题**: 室主任显示没有时间限制，但导出有7天限制

**修复内容**: 统一使用`role_export_days`配置，显示和导出都应用相同的时间窗口

**修复日期**: 2025-11-25

---

### 3.2 ✅ 配置参数分散在代码中

**原问题**: 默认路径、角色时间窗口等参数硬编码在`base.py`中

**修复内容**: 
- 创建完整的`config.json`结构
- 将默认路径、角色时间窗口等提取到配置文件
- 代码通过`self.config`读取

**修复日期**: 2025-11-25

---

### 3.3 ✅ 界面显示代码重复

**原问题**: `base.py`和`window.py`都有版本显示代码

**修复内容**: 
- 界面显示统一由`window.py`的`WindowManager`控制
- 移除`base.py`中多余的UI代码

**修复日期**: 2025-11-25

---

### 3.4 ✅ 数据库状态无法实时查看

**原问题**: 用户无法知道数据库连接状态

**修复内容**: 
- 新增`db_status.py`模块
- 在主界面左下角显示数据库状态
- 连接失败时弹窗提醒

**修复日期**: 2025-11-25

---

### 3.5 ✅ 自动更新闪退问题

**原问题**: update.exe控制台窗口闪现后立即关闭

**修复内容**:
- 添加全局异常捕获
- 添加详细日志（update_log.txt）
- 跳过正在运行的可执行文件
- 失败时暂停窗口显示错误

**修复日期**: 2025-11-25

---

### 3.6 ✅ 打包缺失模块问题

**原问题**: 以下模块未包含在打包配置中
- `ignore_overdue_dialog.py`
- `date_utils.py`
- `input_handler.py`
- `distribution.py`
- `db_status.py`

**修复内容**: 更新`excel_processor.spec`，添加所有缺失模块

**修复日期**: 2025-11-25

---

### 3.7 ✅ 时间格式误判重置

**原问题**: `2025.11.07`和`2025-11-07`被判断为不同时间，触发状态重置

**修复内容**: 添加`normalize_time`函数统一格式

**修复日期**: 2025-11-12

---

### 3.8 ✅ 完成列清空时缺少归档逻辑

**原问题**: 已审查任务完成列被清空时，直接覆盖旧数据，无归档

**修复内容**: 在`batch_upsert_tasks`中添加归档逻辑

**修复日期**: 2025-11-12

---

### 3.9 ✅ 任务状态与角色耦合

**原问题**: 任务状态判断与角色过滤混在一起，导致非当前角色的任务无法被正确记录到Registry

**修复内容**: 
- Registry写入使用原始未过滤的DataFrame
- 角色过滤仅用于显示

**修复日期**: 2025-11-25

---

## 4. 潜在风险

### 4.1 数据库文件锁定

**场景**: 多用户同时访问共享盘上的registry.db

**风险**: SQLite并发写入可能导致锁等待

**缓解措施**: 已启用WAL模式，显著改善并发性能；添加数据库状态显示器提示用户

---

### 4.2 大文件处理性能

**场景**: 单个Excel文件超过10000行

**风险**: 处理时间较长，界面可能卡顿

**缓解措施**: 已使用多线程处理，UI保持响应

---

### 4.3 网络路径不可用

**场景**: 共享盘网络中断

**风险**: 自动更新失败、源文件无法读取

**缓解措施**: 已添加容错处理，记录警告日志并继续

---

## 5. 优化建议

### 5.1 代码层面

| 建议 | 说明 | 优先级 |
|------|------|--------|
| 矢量化筛选 | 用pandas向量运算替代逐行遍历 | 🟡 |
| 批量读取 | 使用chunksize分批读取大文件 | 🟢 |
| 缓存机制 | 缓存已读取的DataFrame | 🟢 |
| 并行处理 | 多项目用concurrent.futures并行 | 🟢 |

### 5.2 用户体验

| 建议 | 说明 | 优先级 |
|------|------|--------|
| 进度条 | 处理大文件时显示进度 | 🟡 |
| 通知弹窗 | 自动取消忽略时提示用户 | 🟢 |
| 快捷键 | 添加常用操作快捷键 | 🟢 |

### 5.3 运维层面

| 建议 | 说明 | 优先级 |
|------|------|--------|
| 日志归档 | 定期清理超过30天的日志 | 🟢 |
| 数据库备份 | 定期备份registry.db | 🟡 |
| 性能监控 | 添加处理耗时统计 | 🟢 |

---

## 6. 测试覆盖情况

### 当前测试统计

| 类别 | 测试数 | 状态 |
|------|--------|------|
| Registry核心功能 | 36 | ✅ 通过 |
| 接口号继承 | 8 | ✅ 通过 |
| 自动归档 | 4 | ✅ 通过 |
| 上级确认 | 2 | ✅ 通过 |
| 真实场景模拟 | 4 | ✅ 通过 |
| 自动更新 | 6 | ✅ 通过 |
| 中文路径 | 6 | ✅ 通过 |
| 配置加载 | 11 | ✅ 通过 |
| 数据库状态显示器 | 23 | ✅ 通过 |
| 文件锁定检测 | 10 | ✅ 通过 |
| 帮助文档查看器 | 38 | ✅ 通过 |

### 未覆盖场景

- 多用户并发操作（需手动测试）
- 超大文件处理（>10000行）
- 网络中断恢复

---

## 7. 部署注意事项

### 7.1 首次部署

1. 确保共享盘路径可访问
2. 配置`config.json`中的`folder_path`
3. 首次运行会自动创建registry.db并迁移

### 7.2 版本升级

1. 更新共享盘`EXE`目录下的文件
2. 更新`version.json`版本号
3. 客户端下次运行时自动更新

### 7.3 回滚方案

1. 保留旧版本EXE备份
2. 如需回滚，替换共享盘文件并降低版本号

---

## 8. 配置说明

### 8.1 角色时间窗口配置

在`config.json`的`role_export_days`中配置各角色的时间窗口：

```json
"role_export_days": {
    "一室主任": 7,      // 7个工作日
    "二室主任": 7,
    "建筑总图室主任": 7,
    "所领导": 2,        // 2个工作日
    "管理员": null,     // 无限制
    "设计人员": null
}
```

**说明**:
- 时间窗口同时控制显示和导出
- 使用工作日计算（排除周六周日）
- `null`表示无限制
- 延期任务（负数工作日差）始终保留

---

## 9. 联系与支持

**问题反馈**: 通过Git仓库Issues反馈

**日志位置**:
- 更新日志: `update_log.txt`
- 监控日志: Monitor窗口可保存

**配置位置**:
- 主配置: `config.json`（项目根目录为默认值，用户目录为个人配置）
- 版本: `version.json`
- 数据库: `registry.db`（在`folder_path`下的`result_cache`目录）

---

---

## 10. 版本更新记录

### 2025.11.25.13

**新增功能**:
- ✅ 帮助文档查看器（`help_viewer.py`）
  - 主界面右上角添加 **❓** 帮助按钮
  - 支持Markdown格式文档显示
  - 左侧目录树导航，右侧内容区显示
  - 大字体（14-18px）便于阅读
  - 支持选中复制（Ctrl+C、右键菜单）
  - 根据用户角色自动定位到对应章节
- ✅ 用户使用说明文档（`document/4_使用说明.md`）
  - 按角色分级：设计人员、室主任、所领导、管理员
  - 包含通用功能和常见问题解答

### 2025.11.25.12

**新增功能**:
- ✅ 文件占用时显示占用用户名（从Excel临时锁定文件读取）
- ✅ 室主任显示时间范围与导出统一（使用`role_export_days`配置）

### 2025.11.25.11

**新增功能**:
- ✅ 数据库状态实时显示（左下角状态指示器）
- ✅ 配置参数整合至`config.json`

---

*文档更新时间: 2025-11-26*
