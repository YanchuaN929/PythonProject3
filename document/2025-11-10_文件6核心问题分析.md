# æ–‡ä»¶6æ ¸å¿ƒé—®é¢˜åˆ†æ

**æŠ¥å‘Šæ—¥æœŸ**: 2025-11-10  
**ç”¨æˆ·åé¦ˆ**: "æ–‡ä»¶1~4éƒ½æ˜¯æ­£å¸¸çš„ï¼Œä»”ç»†æ£€æŸ¥å¯¹æ¯”å·®è·"

---

## ğŸ” ç”¨æˆ·é—®é¢˜æè¿°

### æ˜ç¡®çš„ç—‡çŠ¶

1. **Excelæ²¡æœ‰å†™å…¥**ï¼šç”¨æˆ·å¡«å†™å›æ–‡å•å·åï¼ŒExcelæ–‡ä»¶Lã€Jã€Nåˆ—éƒ½æ˜¯ç©ºçš„
2. **å†å²æŸ¥è¯¢å‡ºç°ä¸¤æ¡è®°å½•**ï¼š
   - è®°å½•1ï¼šçŠ¶æ€="è¯·æŒ‡æ´¾"ï¼Œæœ‰å›æ–‡å•å·
   - è®°å½•2ï¼šçŠ¶æ€="å¾…å®Œæˆ"ï¼Œæ— å›æ–‡å•å·
3. **ä¸»æ˜¾ç¤ºçª—çŠ¶æ€é”™è¯¯**ï¼šæ¥å£çŠ¶æ€å˜æˆ"è¯·æŒ‡æ´¾"ï¼ˆåº”è¯¥æ˜¯"å¾…å®Œæˆ"ï¼‰
4. **æ¸…é™¤ç¼“å­˜æ— æ•ˆ**ï¼šæ¸…é™¤ç¼“å­˜åä¾ç„¶ä¸¤æ¡è®°å½•

### å…³é”®çº¿ç´¢

> "ç°åœ¨excelæ–‡ä»¶ä¸­ä»€ä¹ˆéƒ½æ²¡æœ‰å¡«å†™"

è¿™è¯´æ˜ï¼š
- `write_response_to_excel`å‡½æ•°**æ ¹æœ¬æ²¡æœ‰æˆåŠŸæ‰§è¡Œ**
- æˆ–è€…å†™å…¥çš„æ–‡ä»¶è·¯å¾„ä¸å¯¹
- æˆ–è€…å†™å…¥çš„è¡Œå·ä¸å¯¹

---

## ğŸ†š æ–‡ä»¶1-4 vs æ–‡ä»¶6 å¯¹æ¯”åˆ†æ

### 1. é¡¹ç›®å·æå–é€»è¾‘å·®å¼‚

#### æ–‡ä»¶1-4
```python
# æ­£å¸¸æå–ï¼Œä¸åšç‰¹æ®Šå¤„ç†
def extract_project_id(df_row, file_type):
    if "é¡¹ç›®å·" in df_row.index:
        return str(df_row["é¡¹ç›®å·"]).strip()
    # ä»filenameæå–
    return project_id_from_filename
```

#### æ–‡ä»¶6ï¼ˆé—®é¢˜æ‰€åœ¨ï¼ï¼‰
```python
# registry/util.py ç¬¬132-135è¡Œ
if file_type == 6 and (not project_id or project_id.lower() in ['nan', 'none', '']):
    return "æœªçŸ¥é¡¹ç›®"  # âŒ ç‰¹æ®Šå¤„ç†
```

**å½±å“**ï¼š
- å¦‚æœé¡¹ç›®å·ä¸ºç©ºï¼Œä¼šè®¾ç½®ä¸º"æœªçŸ¥é¡¹ç›®"
- è¿™ä¼šå¯¼è‡´`business_id`ä¸ä¸€è‡´
- å¯èƒ½åˆ›å»ºå¤šæ¡è®°å½•

---

### 2. è´£ä»»äººåˆ—å¤„ç†å·®å¼‚

#### æ–‡ä»¶1-4
```python
# main.pyä¸­æ¸…æ™°æå–
# æ–‡ä»¶1: Råˆ—ï¼ˆç´¢å¼•17ï¼‰
df.iloc[idx, 17]

# æ–‡ä»¶2: AMåˆ—ï¼ˆç´¢å¼•38ï¼‰
df.iloc[idx, 38]
```

#### æ–‡ä»¶6
```python
# main.py ç¬¬3718-3737è¡Œ
# Xåˆ—ï¼ˆç´¢å¼•23ï¼‰æŒ‰åˆ†éš”ç¬¦æ‹†åˆ†
owners = []
for idx in result_df.index:
    cell_val = df.iloc[idx, 23]
    s = str(cell_val)
    # åˆ†éš”ç¬¦ï¼š, ï¼Œ ; ï¼› / ã€
    for sep in [',', 'ï¼Œ', ';', 'ï¼›', '/', 'ã€']:
        s = s.replace(sep, ',')
    tokens = [t.strip() for t in s.split(',')]
    names_str = ','.join(tokens)
    
    # ã€æ–°å¢ã€‘è¿‡æ»¤è´£ä»»äºº
    if valid_names_set:
        names_str = filter_valid_names(names_str, valid_names_set)
    
    owners.append(names_str)
```

**é—®é¢˜**ï¼š
- è´£ä»»äººåˆ—å¯èƒ½åŒ…å«**å¤šä¸ªå§“å**
- ç»è¿‡`filter_valid_names`è¿‡æ»¤åï¼Œå¯èƒ½å˜æˆ**ç©ºå­—ç¬¦ä¸²**
- ç©ºå­—ç¬¦ä¸²ä¼šå¯¼è‡´`display_status = "è¯·æŒ‡æ´¾"`

---

### 3. Registryè®°å½•é€»è¾‘ï¼ˆå…³é”®å·®å¼‚ï¼‰

#### æ‰€æœ‰æ–‡ä»¶ç±»å‹éƒ½ç›¸åŒ
```python
# registry/hooks.py ç¬¬111-117è¡Œ
for _, row in result_df.iterrows():
    key = build_task_key_from_row(row, file_type, source_file)
    fields = build_task_fields_from_row(row, file_type)
    tasks_data.append({'key': key, 'fields': fields})

count = batch_upsert_tasks(db_path, wal, tasks_data, now)
```

**ä½†æ•°æ®åº“å”¯ä¸€æ€§çº¦æŸæ˜¯**ï¼š
```sql
UNIQUE(file_type, project_id, interface_id, source_file, row_index)
```

**é—®é¢˜åœºæ™¯**ï¼š
1. ç¬¬ä¸€æ¬¡å¤„ç†ï¼šæ¥å£Xåœ¨Excelç¬¬10è¡Œ â†’ åˆ›å»ºè®°å½•A
2. ç”¨æˆ·åˆ é™¤äº†ä¸€äº›è¡Œ
3. ç¬¬äºŒæ¬¡å¤„ç†ï¼šæ¥å£Xåœ¨Excelç¬¬8è¡Œ â†’ åˆ›å»ºè®°å½•Bï¼ˆrow_indexä¸åŒï¼ï¼‰
4. **ç»“æœ**ï¼šæ•°æ®åº“ä¸­æœ‰ä¸¤æ¡è®°å½•

---

## ğŸ”´ æ ¹æœ¬åŸå› åˆ†æ

### åŸå› 1ï¼šExcelæœªå†™å…¥

**å¯èƒ½çš„åŸå› **ï¼š
1. `source_file`è·¯å¾„ä¸å¯¹
   - å¦‚æœ`result_df['source_file']`æ˜¯ç›¸å¯¹è·¯å¾„è€Œä¸æ˜¯ç»å¯¹è·¯å¾„
   - `write_response_to_excel`ä¼šæ‰¾ä¸åˆ°æ–‡ä»¶
   
2. `row_index`ä¸å¯¹
   - å¦‚æœ"åŸå§‹è¡Œå·"å­—æ®µé”™è¯¯
   - ä¼šå†™å…¥é”™è¯¯çš„è¡Œï¼ˆæˆ–è¶Šç•Œï¼‰
   
3. æ–‡ä»¶è¢«é”å®š
   - å¦‚æœExcelæ–‡ä»¶æ­£åœ¨è¢«å…¶ä»–ç¨‹åºæ‰“å¼€
   - å†™å…¥ä¼šå¤±è´¥

### åŸå› 2ï¼šé‡å¤è®°å½•

**ç¡®è®¤çš„åŸå› **ï¼š

å½“Excelæ–‡ä»¶çš„è¡Œç»“æ„å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆåˆ é™¤ã€æ’å…¥è¡Œï¼‰ï¼ŒåŒä¸€æ¥å£çš„`row_index`ä¼šæ”¹å˜ï¼Œå¯¼è‡´åˆ›å»ºæ–°è®°å½•ã€‚

**æ¡ˆä¾‹é‡ç°**ï¼š
```
åˆå§‹çŠ¶æ€ï¼š
è¡Œå·2: æ¥å£A  â†’  æ•°æ®åº“è®°å½•: (file_type=6, interface_id=A, row_index=2)

åˆ é™¤ç¬¬1è¡Œåï¼š
è¡Œå·2: æ¥å£Aï¼ˆåŸæ¥æ˜¯è¡Œå·3ï¼‰
è¡Œå·3: æ¥å£Aï¼ˆè¢«Excelè‡ªåŠ¨è°ƒæ•´ï¼‰

ç¬¬äºŒæ¬¡å¤„ç†ï¼š
è¡Œå·2: æ¥å£A  â†’  æ•°æ®åº“è®°å½•: (file_type=6, interface_id=A, row_index=2) â† æ›´æ–°
è¡Œå·3: æ¥å£A  â†’  æ•°æ®åº“è®°å½•: (file_type=6, interface_id=A, row_index=3) â† æ–°åˆ›å»ºï¼
```

### åŸå› 3ï¼šè´£ä»»äººè¿‡æ»¤å¯¼è‡´çŠ¶æ€å˜åŒ–

å¦‚æœè´£ä»»äººåˆ—åŒ…å«ä¸åœ¨`valid_names_set`ä¸­çš„å§“åï¼š
```python
# è¿‡æ»¤å‰ï¼šè´£ä»»äºº = "å¼ ä¸‰,æå››a"
# è¿‡æ»¤åï¼šè´£ä»»äºº = ""ï¼ˆå¦‚æœ"å¼ ä¸‰"å’Œ"æå››"éƒ½ä¸åœ¨å§“åè§’è‰²è¡¨ä¸­ï¼‰

# registry/util.py ç¬¬338-339è¡Œ
if responsible_person:
    fields['responsible_person'] = responsible_person
```

å¦‚æœ`responsible_person`è¢«è¿‡æ»¤æˆç©ºï¼š
- `fields`ä¸­ä¸åŒ…å«`responsible_person`
- Registryåˆ¤æ–­ä¸ºæ— è´£ä»»äºº
- `display_status = "è¯·æŒ‡æ´¾"`

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®å¤Excelå†™å…¥é—®é¢˜ï¼ˆç«‹å³ï¼‰

**æ£€æŸ¥é¡¹**ï¼š

1. ç¡®è®¤`result_df['source_file']`æ˜¯ç»å¯¹è·¯å¾„
```python
# main.py ç¬¬3740è¡Œ
result_df['source_file'] = os.path.abspath(file_path)  # ç¡®ä¿æ˜¯ç»å¯¹è·¯å¾„
```

2. ç¡®è®¤"åŸå§‹è¡Œå·"æ­£ç¡®
```python
# main.py ç¬¬3695è¡Œ
result_df['åŸå§‹è¡Œå·'] = excel_row_numbers  # åº”è¯¥æ˜¯ExcelçœŸå®è¡Œå·ï¼ˆä»2å¼€å§‹ï¼‰
```

3. æ·»åŠ å†™å…¥é”™è¯¯æ—¥å¿—
```python
# input_handler.py ç¬¬332-336è¡Œ
except Exception as e:
    print(f"[ERROR] å†™å…¥å¤±è´¥: {e}")
    print(f"  file_path: {file_path}")
    print(f"  row_index: {row_index}")
    print(f"  file_type: {file_type}")
    import traceback
    traceback.print_exc()
    return False
```

---

### æ–¹æ¡ˆ2ï¼šé˜²æ­¢é‡å¤è®°å½•ï¼ˆæ ¹æœ¬ï¼‰

**ä¿®æ”¹å”¯ä¸€æ€§çº¦æŸ**ï¼š

é—®é¢˜ï¼šç°åœ¨çš„UNIQUEçº¦æŸåŒ…å«`row_index`ï¼Œå¯¼è‡´è¡Œå·å˜åŒ–æ—¶åˆ›å»ºæ–°è®°å½•

**è§£å†³**ï¼šä½¿ç”¨`business_id`ä½œä¸ºå”¯ä¸€æ€§åˆ¤æ–­

```python
# registry/service.py batch_upsert_tasks
# ä¿®æ”¹é€»è¾‘ï¼š
# 1. å…ˆæ ¹æ®business_idæŸ¥æ‰¾ç°æœ‰è®°å½•
# 2. å¦‚æœæ‰¾åˆ°ï¼Œæ›´æ–°è¯¥è®°å½•çš„row_indexå’Œsource_file
# 3. å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ›å»ºæ–°è®°å½•
```

å…·ä½“å®ç°ï¼š
```python
# åœ¨batch_upsert_tasksä¸­
for task_data in tasks_data:
    key = task_data['key']
    fields = task_data['fields']
    
    # æŸ¥æ‰¾ç°æœ‰è®°å½•ï¼ˆåŸºäºbusiness_idï¼‰
    old_task = find_task_by_business_id(
        db_path, wal, 
        key['file_type'], 
        key['project_id'], 
        key['interface_id']
    )
    
    if old_task:
        # æ›´æ–°ç°æœ‰è®°å½•çš„row_indexå’Œsource_file
        conn.execute("""
            UPDATE tasks
            SET row_index = ?, source_file = ?, last_seen_at = ?
            WHERE id = ?
        """, (key['row_index'], key['source_file'], now_str, old_task['id']))
    else:
        # åˆ›å»ºæ–°è®°å½•
        # ... æ­£å¸¸INSERTé€»è¾‘
```

---

### æ–¹æ¡ˆ3ï¼šä¿®å¤"æœªçŸ¥é¡¹ç›®"é—®é¢˜ï¼ˆç«‹å³ï¼‰

**é—®é¢˜**ï¼šæ–‡ä»¶6çš„é¡¹ç›®å·å¦‚æœä¸ºç©ºä¼šè¢«è®¾ç½®ä¸º"æœªçŸ¥é¡¹ç›®"

**ä¿®å¤**ï¼š
```python
# registry/util.py ç¬¬132-135è¡Œ
# ã€åˆ é™¤ã€‘æ–‡ä»¶6çš„ç‰¹æ®Šå¤„ç†
if file_type == 6 and (not project_id or project_id.lower() in ['nan', 'none', '']):
    return "æœªçŸ¥é¡¹ç›®"  # â† åˆ é™¤è¿™ä¸ªé€»è¾‘

# ã€æ”¹ä¸ºã€‘ç»Ÿä¸€å¤„ç†
if not project_id or project_id.lower() in ['nan', 'none', '']:
    # ä»filenameæå–
    return extract_project_id_from_filename(source_file)
```

---

### æ–¹æ¡ˆ4ï¼šä¿®å¤è´£ä»»äººè¿‡æ»¤é—®é¢˜ï¼ˆç«‹å³ï¼‰

**é—®é¢˜**ï¼šè´£ä»»äººè¢«è¿‡æ»¤æˆç©ºå­—ç¬¦ä¸²åï¼ŒçŠ¶æ€å˜æˆ"è¯·æŒ‡æ´¾"

**ä¿®å¤**ï¼š
```python
# main.py ç¬¬3730-3733è¡Œ
# è¿‡æ»¤è´£ä»»äººï¼šåªä¿ç•™åœ¨å§“åè§’è‰²è¡¨ä¸­å­˜åœ¨çš„å§“å
if valid_names_set:
    filtered_names = filter_valid_names(names_str, valid_names_set)
    # ã€æ–°å¢ã€‘å¦‚æœè¿‡æ»¤åä¸ºç©ºï¼Œä¿ç•™åŸå§‹å€¼
    if filtered_names:
        names_str = filtered_names
    # else: ä¿æŒåŸå§‹names_strä¸å˜

owners.append(names_str)
```

---

## ğŸš¨ ç«‹å³è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥æ•°æ®åº“è®°å½•

```sql
SELECT id, project_id, interface_id, row_index, source_file,
       responsible_person, display_status, response_number,
       first_seen_at
FROM tasks
WHERE file_type = 6 AND interface_id = 'æ‚¨çš„æ¥å£å·'
ORDER BY first_seen_at;
```

**æ£€æŸ¥**ï¼š
- æ˜¯å¦æœ‰ä¸¤æ¡è®°å½•ï¼Ÿ
- `row_index`æ˜¯å¦ä¸åŒï¼Ÿ
- `responsible_person`æ˜¯å¦ä¸€ä¸ªä¸ºç©ºï¼Œä¸€ä¸ªæœ‰å€¼ï¼Ÿ
- `response_number`æ˜¯å“ªæ¡è®°å½•æœ‰å€¼ï¼Ÿ

---

### æ­¥éª¤2ï¼šæ£€æŸ¥Excelæ–‡ä»¶

```
æ‰“å¼€Excelæ–‡ä»¶ï¼Œæ£€æŸ¥ï¼š
1. è¯¥æ¥å£å½“å‰åœ¨ç¬¬å‡ è¡Œï¼Ÿ
2. Xåˆ—ï¼ˆè´£ä»»äººï¼‰çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿ
3. Låˆ—ï¼ˆå›æ–‡å•å·ï¼‰æ˜¯å¦ä¸ºç©ºï¼Ÿ
4. Jåˆ—ï¼ˆå®Œæˆæ—¶é—´ï¼‰æ˜¯å¦ä¸ºç©ºï¼Ÿ
5. Nåˆ—ï¼ˆå†™å…¥äººï¼‰æ˜¯å¦ä¸ºç©ºï¼Ÿ
```

---

### æ­¥éª¤3ï¼šæ£€æŸ¥æ§åˆ¶å°è¾“å‡º

å½“åŒå‡»æ¥å£å·æ—¶ï¼Œæ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ï¼š
```
[æ–‡ä»¶6] è‡ªåŠ¨æ›´æ–°Måˆ—: ...
æˆåŠŸå†™å…¥: ..., è¡ŒX, å›æ–‡å•å·=...
```

å¦‚æœæ²¡æœ‰è¿™äº›è¾“å‡ºï¼Œè¯´æ˜å†™å…¥å¤±è´¥æˆ–æ²¡è¢«è°ƒç”¨ã€‚

---

## ğŸ“ ä¿®å¤æ¸…å•

| ä¿®å¤é¡¹ | ä¼˜å…ˆçº§ | æ–‡ä»¶ | è¡Œå· |
|--------|--------|------|------|
| ä½¿ç”¨ç»å¯¹è·¯å¾„ | ğŸ”´ é«˜ | main.py | 3740 |
| åˆ é™¤"æœªçŸ¥é¡¹ç›®"é€»è¾‘ | ğŸ”´ é«˜ | registry/util.py | 132-135 |
| ä¿®å¤è´£ä»»äººè¿‡æ»¤ | ğŸ”´ é«˜ | main.py | 3730-3733 |
| æ·»åŠ å†™å…¥é”™è¯¯æ—¥å¿— | ğŸŸ¡ ä¸­ | input_handler.py | 332-336 |
| é˜²æ­¢é‡å¤è®°å½• | ğŸŸ¡ ä¸­ | registry/service.py | batch_upsert_tasks |

---

## â° ä¸‹ä¸€æ­¥

è¯·ç”¨æˆ·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. å‡ºé—®é¢˜çš„å…·ä½“æ¥å£å·
2. è¯¥æ¥å£åœ¨Excelä¸­çš„å®é™…è¡Œå·
3. è¯¥æ¥å£Xåˆ—ï¼ˆè´£ä»»äººï¼‰çš„å®é™…å†…å®¹
4. åŒå‡»æ¥å£å·æ—¶çš„å®Œæ•´æ§åˆ¶å°è¾“å‡º

æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘å¯ä»¥ç²¾ç¡®å®šä½é—®é¢˜æ‰€åœ¨ï¼

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-10  
**çŠ¶æ€**: å¾…ç”¨æˆ·æä¾›è¯Šæ–­ä¿¡æ¯

