# ç§‘å®¤å­—æ®µä¸é…ç½®å¯¼å…¥ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**ï¼š2025-11-12  
**ä¿®å¤å·¥ç¨‹å¸ˆ**ï¼šAI Assistant  
**å½±å“èŒƒå›´**ï¼šRegistryæ¨¡å—ã€å¿½ç•¥å»¶æœŸåŠŸèƒ½

---

## é—®é¢˜æ€»ç»“

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

### é—®é¢˜1ï¼šæ‰€å±ç§‘å®¤åˆ—æ˜¾ç¤ºä¸ºç©º

**ç°è±¡**ï¼š
- åœ¨å¿½ç•¥å»¶æœŸä»»åŠ¡çª—å£ä¸­ï¼Œ"æ‰€å±ç§‘å®¤"åˆ—æ²¡æœ‰æ•°æ®æ˜¾ç¤º
- æ•°æ®åº“ä¸­departmentå­—æ®µä¸ºç©º

**æ ¹æœ¬åŸå› **ï¼š
- Registryæ¨¡å—çš„`extract_department`å‡½æ•°åªæŸ¥æ‰¾"éƒ¨é—¨"åˆ—
- ä½†Excelæ–‡ä»¶ä¸­å®é™…ä½¿ç”¨çš„åˆ—åæ˜¯"ç§‘å®¤"
- å¯¼è‡´ç§‘å®¤ä¿¡æ¯æ— æ³•è¢«æå–å’Œä¿å­˜åˆ°æ•°æ®åº“

### é—®é¢˜2ï¼šå¿½ç•¥åŠŸèƒ½æŠ¥é”™

**é”™è¯¯ä¿¡æ¯**ï¼š
```
å¿½ç•¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:
cannot import name 'get_config' from 'registry.config'
```

**æ ¹æœ¬åŸå› **ï¼š
- `ignore_overdue_dialog.py`ä¸­é”™è¯¯ä½¿ç”¨äº†`from registry.config import get_config`
- Registryæ¨¡å—ä¸­ä¸å­˜åœ¨`get_config`å‡½æ•°
- åº”è¯¥ä½¿ç”¨`registry.hooks._cfg()`æ¥è·å–é…ç½®

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šæ”¯æŒä»"ç§‘å®¤"åˆ—æå–æ•°æ®

**æ–‡ä»¶**ï¼š`registry/util.py`

**ä¿®æ”¹å†…å®¹**ï¼šæ‰©å±•`extract_department`å‡½æ•°ï¼Œä¼˜å…ˆæŸ¥æ‰¾"ç§‘å®¤"åˆ—ï¼Œå…¶æ¬¡æŸ¥æ‰¾"éƒ¨é—¨"åˆ—

```python
def extract_department(df_row: pd.Series) -> str:
    """
    ä»DataFrameè¡Œä¸­æå–éƒ¨é—¨/ç§‘å®¤ä¿¡æ¯
    
    å‚æ•°:
        df_row: DataFrameçš„ä¸€è¡Œï¼ˆpd.Seriesï¼‰
        
    è¿”å›:
        éƒ¨é—¨/ç§‘å®¤å­—ç¬¦ä¸²ï¼ˆå»é™¤å‰åç©ºæ ¼ï¼‰
    """
    # ä¼˜å…ˆæŸ¥æ‰¾"ç§‘å®¤"åˆ—ï¼ˆå¸¸ç”¨ï¼‰
    if "ç§‘å®¤" in df_row.index:
        dept = str(df_row["ç§‘å®¤"]).strip()
        if dept and dept.lower() not in ['nan', 'none', '']:
            return dept
    
    # å…¶æ¬¡æŸ¥æ‰¾"éƒ¨é—¨"åˆ—
    if "éƒ¨é—¨" in df_row.index:
        dept = str(df_row["éƒ¨é—¨"]).strip()
        if dept and dept.lower() not in ['nan', 'none', '']:
            return dept
    
    return ""
```

**å½±å“**ï¼š
- æ‰€æœ‰é€šè¿‡`on_process_done`é’©å­ä¿å­˜çš„ä»»åŠ¡éƒ½ä¼šæ­£ç¡®è®°å½•ç§‘å®¤ä¿¡æ¯
- å†å²ä»»åŠ¡ä¼šåœ¨ä¸‹æ¬¡å¤„ç†Excelæ—¶è‡ªåŠ¨æ›´æ–°ç§‘å®¤å­—æ®µ
- å¿½ç•¥å»¶æœŸçª—å£å°†æ­£ç¡®æ˜¾ç¤ºç§‘å®¤ä¿¡æ¯

### ä¿®å¤2ï¼šä¿®æ­£é…ç½®è·å–æ–¹å¼

**æ–‡ä»¶**ï¼š`ignore_overdue_dialog.py`

**ä¿®æ”¹å†…å®¹**ï¼šä½¿ç”¨æ­£ç¡®çš„Registryé…ç½®è·å–æ–¹å¼

**ä¿®æ”¹å‰**ï¼š
```python
from registry.config import get_config

cfg = get_config()
db_path = cfg['db_path']
wal = cfg.get('wal', True)
```

**ä¿®æ”¹å**ï¼š
```python
from registry import hooks as registry_hooks

cfg = registry_hooks._cfg()
db_path = cfg['registry_db_path']
wal = cfg.get('registry_wal', True)
```

**å…³é”®å˜åŒ–**ï¼š
1. ä½¿ç”¨`registry_hooks._cfg()`ä»£æ›¿ä¸å­˜åœ¨çš„`get_config()`
2. é…ç½®é”®ä»`db_path`æ”¹ä¸º`registry_db_path`
3. é…ç½®é”®ä»`wal`æ”¹ä¸º`registry_wal`

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ–‡ä»¶

åˆ›å»ºäº†`tests/test_department_and_config_fix.py`ï¼ŒåŒ…å«5ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

#### 1. `test_extract_department_from_excel`

æµ‹è¯•ä»Excelè¡Œæå–ç§‘å®¤ä¿¡æ¯çš„å„ç§åœºæ™¯ï¼š
- âœ… æœ‰"ç§‘å®¤"åˆ— â†’ æ­£ç¡®æå–
- âœ… æœ‰"éƒ¨é—¨"åˆ— â†’ æ­£ç¡®æå–
- âœ… ä¸¤åˆ—éƒ½æœ‰ â†’ ä¼˜å…ˆä½¿ç”¨"ç§‘å®¤"
- âœ… éƒ½æ²¡æœ‰ â†’ è¿”å›ç©ºå­—ç¬¦ä¸²
- âœ… å€¼ä¸ºNaN/None â†’ è¿”å›ç©ºå­—ç¬¦ä¸²

#### 2. `test_build_task_fields_includes_department`

éªŒè¯`build_task_fields_from_row`å‡½æ•°åŒ…å«departmentå­—æ®µï¼š
- âœ… è¿”å›çš„å­—å…¸åŒ…å«'department'é”®
- âœ… departmentå€¼æ­£ç¡®æå–

#### 3. `test_department_saved_to_database`

ç«¯åˆ°ç«¯æµ‹è¯•departmentå­—æ®µèƒ½æ­£ç¡®ä¿å­˜åˆ°æ•°æ®åº“ï¼š
- âœ… åˆ›å»ºåŒ…å«ç§‘å®¤ä¿¡æ¯çš„ä»»åŠ¡
- âœ… é€šè¿‡`upsert_task`ä¿å­˜
- âœ… ä»æ•°æ®åº“æŸ¥è¯¢éªŒè¯æ•°æ®å®Œæ•´æ€§

#### 4. `test_collect_overdue_includes_department`

éªŒè¯æ”¶é›†å»¶æœŸä»»åŠ¡æ—¶åŒ…å«departmentå­—æ®µï¼š
- âœ… ä½¿ç”¨`upsert_task`æ’å…¥å¸¦ç§‘å®¤çš„å»¶æœŸä»»åŠ¡
- âœ… ä»æ•°æ®åº“æŸ¥è¯¢éªŒè¯ç§‘å®¤å­—æ®µå­˜åœ¨ä¸”æ­£ç¡®

#### 5. `test_ignore_dialog_config_access`

éªŒè¯å¿½ç•¥å¯¹è¯æ¡†æ­£ç¡®è·å–Registryé…ç½®ï¼š
- âœ… `registry_hooks._cfg()`è°ƒç”¨æˆåŠŸ
- âœ… é…ç½®åŒ…å«å¿…è¦çš„é”®ï¼š`registry_db_path`ã€`registry_wal`

### æµ‹è¯•ç»“æœ

```bash
============================= test session starts =============================
collected 5 items

tests/test_department_and_config_fix.py::test_extract_department_from_excel PASSED
tests/test_department_and_config_fix.py::test_build_task_fields_includes_department PASSED
tests/test_department_and_config_fix.py::test_department_saved_to_database PASSED
tests/test_department_and_config_fix.py::test_collect_overdue_includes_department PASSED
tests/test_department_and_config_fix.py::test_ignore_dialog_config_access PASSED

============================== 5 passed in 0.62s ==============================
```

**âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼**

### å›å½’æµ‹è¯•

è¿è¡Œäº†å…³é”®çš„Registryå’Œå¿½ç•¥åŠŸèƒ½ç›¸å…³æµ‹è¯•ï¼š

```bash
tests/test_registry_superior_confirm.py - 5ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
tests/test_registry_ignore_overdue.py - 5ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
tests/test_department_and_config_fix.py - 5ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡

============================== 15 passed ==============================
```

**âœ… æ— å›å½’é—®é¢˜ï¼**

---

## æ•°æ®æµéªŒè¯

### ç§‘å®¤å­—æ®µçš„å®Œæ•´æ•°æ®æµ

```
Excelæ–‡ä»¶
  â†“
  "ç§‘å®¤"åˆ—ï¼ˆå¦‚ï¼šç»“æ„ä¸€å®¤ã€ç»“æ„äºŒå®¤ã€å»ºç­‘æ€»å›¾å®¤ï¼‰
  â†“
extract_department(df_row)  [registry/util.py]
  â†“
build_task_fields_from_row(df_row)  [registry/util.py]
  â†“
  è¿”å› {'department': 'ç»“æ„ä¸€å®¤', ...}
  â†“
registry_hooks.on_process_done()  [base.py]
  â†“
batch_upsert_tasks()  [registry/service.py]
  â†“
SQLiteæ•°æ®åº“ tasksè¡¨ departmentåˆ—
  â†“
_collect_overdue_tasks()  [base.py]
  â†“
  SELECT department FROM tasks
  â†“
IgnoreOverdueDialog  [ignore_overdue_dialog.py]
  â†“
Treeviewæ˜¾ç¤º"æ‰€å±ç§‘å®¤"åˆ—
```

### é…ç½®è·å–çš„æ­£ç¡®æµç¨‹

```
ignore_overdue_dialog.py
  â†“
from registry import hooks as registry_hooks
  â†“
cfg = registry_hooks._cfg()
  â†“
  å†…éƒ¨è°ƒç”¨ï¼šload_config(data_folder=_DATA_FOLDER)
  â†“
è¿”å›é…ç½®å­—å…¸ï¼š
  {
    'registry_enabled': True,
    'registry_db_path': '.../.registry/registry.db',
    'registry_wal': True,
    ...
  }
  â†“
db_path = cfg['registry_db_path']
wal = cfg.get('registry_wal', True)
  â†“
mark_ignored_batch(db_path, wal, ...)
```

---

## ç”¨æˆ·ä½¿ç”¨å½±å“

### ç«‹å³ç”Ÿæ•ˆ

1. **ç§‘å®¤ä¿¡æ¯æ˜¾ç¤º**
   - å¿½ç•¥å»¶æœŸçª—å£çš„"æ‰€å±ç§‘å®¤"åˆ—å°†æ­£ç¡®æ˜¾ç¤ºç§‘å®¤åç§°
   - å®¤ä¸»ä»»å¯ä»¥æŒ‰ç§‘å®¤ç­›é€‰å’Œç®¡ç†å»¶æœŸä»»åŠ¡

2. **å¿½ç•¥åŠŸèƒ½æ­£å¸¸å·¥ä½œ**
   - ç‚¹å‡»"å¿½ç•¥å»¶æœŸé¡¹"æŒ‰é’®ä¸å†æŠ¥é”™
   - å¯ä»¥æ­£å¸¸é€‰æ‹©å’Œæ‰¹é‡å¿½ç•¥å»¶æœŸä»»åŠ¡

### éœ€è¦é‡æ–°å¤„ç†

- **å†å²æ•°æ®æ›´æ–°**ï¼šæ—§çš„ä»»åŠ¡å¯èƒ½æ²¡æœ‰ç§‘å®¤ä¿¡æ¯
  - è§£å†³æ–¹æ¡ˆï¼šé‡æ–°è¿è¡Œ"å¼€å§‹å¤„ç†"ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ›´æ–°ç§‘å®¤å­—æ®µ
  - æˆ–è€…ç­‰å¾…ä¸‹æ¬¡æ­£å¸¸å¤„ç†ï¼Œç§‘å®¤ä¿¡æ¯ä¼šè‡ªåŠ¨è¡¥å……

---

## åç»­å»ºè®®

### æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

å¯ä»¥è¿è¡Œä»¥ä¸‹SQLæ£€æŸ¥ç§‘å®¤å­—æ®µçš„å¡«å……æƒ…å†µï¼š

```sql
-- æ£€æŸ¥æœ‰å¤šå°‘ä»»åŠ¡ç¼ºå°‘ç§‘å®¤ä¿¡æ¯
SELECT COUNT(*) 
FROM tasks 
WHERE (department IS NULL OR department = '') 
  AND status NOT IN ('archived');

-- æŒ‰ç§‘å®¤ç»Ÿè®¡ä»»åŠ¡æ•°é‡
SELECT department, COUNT(*) as task_count
FROM tasks
WHERE status NOT IN ('archived')
GROUP BY department
ORDER BY task_count DESC;
```

### å­—æ®µæ ‡å‡†åŒ–å»ºè®®

1. **ç»Ÿä¸€åˆ—å**ï¼šå»ºè®®åœ¨Excelæ¨¡æ¿ä¸­ç»Ÿä¸€ä½¿ç”¨"ç§‘å®¤"ä½œä¸ºåˆ—åï¼Œé¿å…æ··æ·†
2. **å­—å…¸æ˜ å°„**ï¼šå¦‚æœæœªæ¥éœ€è¦æ”¯æŒç§‘å®¤åˆ«åï¼ˆå¦‚"ä¸€å®¤"â†’"ç»“æ„ä¸€å®¤"ï¼‰ï¼Œå¯ä»¥åœ¨`extract_department`ä¸­æ·»åŠ æ˜ å°„é€»è¾‘

---

## æ€»ç»“

âœ… **é—®é¢˜1ï¼ˆç§‘å®¤å­—æ®µä¸ºç©ºï¼‰**ï¼šå·²ä¿®å¤ï¼Œé€šè¿‡æ‰©å±•`extract_department`å‡½æ•°æ”¯æŒ"ç§‘å®¤"åˆ—  
âœ… **é—®é¢˜2ï¼ˆå¯¼å…¥é”™è¯¯ï¼‰**ï¼šå·²ä¿®å¤ï¼Œä½¿ç”¨æ­£ç¡®çš„`registry_hooks._cfg()`è·å–é…ç½®  
âœ… **æµ‹è¯•è¦†ç›–**ï¼š5ä¸ªæ–°æµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨é€šè¿‡  
âœ… **å›å½’æµ‹è¯•**ï¼š15ä¸ªç›¸å…³æµ‹è¯•ï¼Œæ— å›å½’é—®é¢˜  
âœ… **æ•°æ®æµéªŒè¯**ï¼šä»Excelåˆ°æ•°æ®åº“å†åˆ°UIæ˜¾ç¤ºï¼Œé“¾è·¯å®Œæ•´  

**ä¿®å¤å®Œæˆï¼Œå¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼** ğŸ‰

