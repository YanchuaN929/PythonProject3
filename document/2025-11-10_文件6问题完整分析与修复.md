# æ–‡ä»¶6é—®é¢˜å®Œæ•´åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-11-10  
**é—®é¢˜ä¸¥é‡åº¦**: ğŸ”´ ä¸¥é‡  
**çŠ¶æ€**: è¿›è¡Œä¸­

---

## ğŸ› ç”¨æˆ·æŠ¥å‘Šçš„é—®é¢˜

**åŸè¯**ï¼š"ä¸è¡Œï¼Œç°åœ¨ä¾æ—§è¿˜æœ‰è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œä½†æ˜¯ä¹‹å‰è¿™ä¸¤ä¸ªé—®é¢˜æ˜¯è¢«è§£å†³äº†çš„ï¼Œä½†æ˜¯ç»è¿‡æœ€è¿‘çš„æ”¹åŠ¨åˆå‡ºç°äº†ï¼ï¼ï¼"

1. **Excelä¸­ä»€ä¹ˆéƒ½æ²¡å†™å…¥**ï¼ˆLã€Jã€Nåˆ—ä¸ºç©ºï¼‰
2. **å†å²æŸ¥è¯¢å‡ºç°é‡å¤è®°å½•**

---

## ğŸ” è¯¦ç»†è¯Šæ–­ç»“æœ

### æ•°æ®åº“çŠ¶æ€

è¿è¡Œ`check_duplicate_records.py`å‘ç°ï¼š

**åŒä¸€ä¸ªæ¥å£æœ‰2æ¡è®°å½•**ï¼š

```
business_id: 6|2016|EHHG-770010-ECZS-0160

è®°å½•1:
  source_file: æ”¶å‘æ–‡æ¸…å•1818.xlsx  â† åœ¨1818æ–‡ä»¶ä¸­
  row_index: 27541
  project_id: 2016  â† ä½†é¡¹ç›®å·æ˜¯2016ï¼é”™è¯¯ï¼
  status: completed (å¾…å®¡æŸ¥)

è®°å½•2:
  source_file: æ”¶å‘æ–‡æ¸…å•2016.xlsx  â† åœ¨2016æ–‡ä»¶ä¸­
  row_index: 511
  project_id: 2016  â† é¡¹ç›®å·æ˜¯2016ï¼Œæ­£ç¡®
  status: open (å¾…å®Œæˆ)
```

### æ–‡ä»¶å¤„ç†éªŒè¯

è¿è¡Œ`diagnose_file6_processing.py`å‘ç°ï¼š

```
æ–‡ä»¶6åˆ—è¡¨: 2ä¸ªæ–‡ä»¶

æ–‡ä»¶1:
  æ–‡ä»¶å: æ”¶å‘æ–‡æ¸…å•1818.xlsx
  é¡¹ç›®å·: 1818  â† æ­£ç¡®ï¼
  source_file: D:\...\æ”¶å‘æ–‡æ¸…å•1818.xlsx (ç»å¯¹è·¯å¾„âœ“)

æ–‡ä»¶2:
  æ–‡ä»¶å: æ”¶å‘æ–‡æ¸…å•2016.xlsx
  é¡¹ç›®å·: 2016  â† æ­£ç¡®ï¼
  source_file: D:\...\æ”¶å‘æ–‡æ¸…å•2016.xlsx (ç»å¯¹è·¯å¾„âœ“)
```

**ç»“è®º**ï¼šæ–‡ä»¶å¤„ç†æœ¬èº«æ˜¯æ­£ç¡®çš„ï¼

---

## ğŸ’¡ æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜é“¾è·¯è¿½è¸ª

1. **å¤„ç†é˜¶æ®µ**ï¼ˆæ­£ç¡®ï¼‰ï¼š
   ```python
   # base.py ç¬¬3638è¡Œ
   result['é¡¹ç›®å·'] = project_id  # project_idæ¥è‡ª(file_path, project_id)å…ƒç»„ï¼Œæ­£ç¡®ï¼
   ```

2. **UIæ˜¾ç¤ºé˜¶æ®µ**ï¼ˆæ­£ç¡®ï¼‰ï¼š
   ```python
   # base.py ç¬¬3644è¡Œ
   results6 = pd.concat(combined_results, ignore_index=True)
   # åˆå¹¶åæ¯è¡Œä»ä¿ç•™æ­£ç¡®çš„'é¡¹ç›®å·'åˆ—
   ```

3. **ç‚¹å‡»æ¥å£å·**ï¼ˆé—®é¢˜å¼€å§‹ï¼‰ï¼š
   ```python
   # window.py ç¬¬1048-1050è¡Œ
   project_col_idx = columns.index("é¡¹ç›®å·")
   project_id = str(item_values[project_col_idx])  # ä»UIæ˜¾ç¤ºçš„é‚£ä¸€è¡Œè¯»å–
   ```

4. **å¡«å†™å›æ–‡å•å·**ï¼ˆé”™è¯¯ä¼ æ’­ï¼‰ï¼š
   ```python
   # input_handler.py ç¬¬132è¡Œ
   project_id=self.project_id  # ä¼ å…¥é”™è¯¯çš„project_idï¼
   ```

5. **Registryè®°å½•**ï¼ˆé”™è¯¯å›ºåŒ–ï¼‰ï¼š
   ```python
   # registry/hooks.py ç¬¬289è¡Œ
   'project_id': normalize_project_id(project_id, file_type)  # ä½¿ç”¨é”™è¯¯çš„project_id
   ```

### å…³é”®å‘ç°

**é—®é¢˜å‡ºåœ¨concatä¹‹åçš„æ•°æ®ä¸åŒ¹é…ï¼**

å½“ä½¿ç”¨`pd.concat(combined_results, ignore_index=True)`æ—¶ï¼š
- **ignore_index=Trueä¼šé‡ç½®ç´¢å¼•ä¸º0,1,2,3...**
- ä½†`original_df`æ˜¯å¤„ç†åçš„result_df
- `item_index`æ˜¯åœ¨åˆå¹¶åçš„DataFrameä¸­çš„ç´¢å¼•
- `original_df.iloc[item_index]`è·å–çš„è¡Œå¯èƒ½ä¸æ˜¯ç‚¹å‡»çš„é‚£ä¸€è¡Œï¼

**ç¤ºä¾‹**ï¼š
```
å¤„ç†æ–‡ä»¶1ï¼ˆ1818ï¼‰ï¼š10è¡Œ â†’ DataFrame1ï¼Œç´¢å¼•0-9ï¼Œé¡¹ç›®å·=1818
å¤„ç†æ–‡ä»¶2ï¼ˆ2016ï¼‰ï¼š10è¡Œ â†’ DataFrame2ï¼Œç´¢å¼•0-9ï¼Œé¡¹ç›®å·=2016
concatåï¼š20è¡Œï¼Œç´¢å¼•0-19

ä½†original_df = results6ï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡»ç¬¬5è¡Œï¼š
- item_index = 5
- original_df.iloc[5] å¯èƒ½æ˜¯æ–‡ä»¶1çš„æ•°æ®ï¼ˆé¡¹ç›®å·=1818ï¼‰
- ä½†item_values[project_col_idx] æ˜¾ç¤ºçš„å¯èƒ½æ˜¯2016ï¼ˆå¦‚æœæ˜¯display_dfçš„ç¬¬5è¡Œå¯¹åº”results6çš„ç¬¬15è¡Œï¼‰
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒé—®é¢˜

**window.pyä¸­ä»item_valuesè¯»å–çš„project_idä¸original_df.iloc[item_index]çš„source_fileä¸åŒ¹é…ï¼**

### è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆï¼šä»original_dfè¯»å–é¡¹ç›®å·ï¼Œè€Œä¸æ˜¯ä»item_values**

#### ä¿®æ”¹ä½ç½®ï¼šwindow.py ç¬¬1044-1052è¡Œ

**ä¿®æ”¹å‰**ï¼š
```python
# è·å–é¡¹ç›®å·
project_id = ""
if "é¡¹ç›®å·" in columns:
    try:
        project_col_idx = columns.index("é¡¹ç›®å·")
        if project_col_idx < len(item_values):
            project_id = str(item_values[project_col_idx])  # âŒ ä»UIæ˜¾ç¤ºè¯»å–ï¼Œå¯èƒ½ä¸åŒ¹é…
    except:
        pass
```

**ä¿®æ”¹å**ï¼š
```python
# è·å–é¡¹ç›®å·ï¼ˆä»original_dfè¯»å–ï¼Œç¡®ä¿ä¸source_fileåŒ¹é…ï¼‰
project_id = ""
if 'source_file' in original_df.columns:
    try:
        if item_index < len(original_df):
            # ä¼˜å…ˆä»DataFrameçš„'é¡¹ç›®å·'åˆ—è¯»å–
            if 'é¡¹ç›®å·' in original_df.columns:
                project_id = str(original_df.iloc[item_index]['é¡¹ç›®å·'])
            else:
                # å…œåº•ï¼šä»source_fileæå–
                source_file_name = os.path.basename(original_df.iloc[item_index]['source_file'])
                import re
                match = re.search(r'(\d{4})', source_file_name)
                project_id = match.group(1) if match else ""
    except Exception as e:
        print(f"è·å–é¡¹ç›®å·å¤±è´¥: {e}")
        # é€€å›åˆ°ä»UIè¯»å–
        if "é¡¹ç›®å·" in columns:
            try:
                project_col_idx = columns.index("é¡¹ç›®å·")
                if project_col_idx < len(item_values):
                    project_id = str(item_values[project_col_idx])
            except:
                pass
```

---

## âœ… ä¿®å¤åçš„æ•ˆæœ

| åœºæ™¯ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|-----|--------|--------|
| ç‚¹å‡»1818æ–‡ä»¶ä¸­çš„æ¥å£ | project_idå¯èƒ½=2016 | project_id=1818 âœ“ |
| å¡«å†™å›æ–‡å•å· | åˆ›å»ºé”™è¯¯çš„business_id | åˆ›å»ºæ­£ç¡®çš„business_id âœ“ |
| Excelå†™å…¥ | å¯èƒ½å†™å…¥é”™è¯¯æ–‡ä»¶ | å†™å…¥æ­£ç¡®æ–‡ä»¶ âœ“ |
| é‡å¤è®°å½• | ä¼šå‡ºç° | ä¸ä¼šå‡ºç° âœ“ |

---

## ğŸ“Š æ¶‰åŠæ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|-----|---------|------|
| `window.py` | ä¿®æ”¹project_idè·å–é€»è¾‘ | ç¬¬1044-1052è¡Œ |
| `scripts/diagnose_file6_processing.py` | æ–°å¢è¯Šæ–­è„šæœ¬ | +120è¡Œ |

---

## ğŸ¯ å…³é”®æ•™è®­

1. **concatåçš„ç´¢å¼•é—®é¢˜**ï¼š`ignore_index=True`ä¼šå¯¼è‡´åŸå§‹ç´¢å¼•ä¸¢å¤±
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šUIæ˜¾ç¤ºçš„æ•°æ®ï¼ˆitem_valuesï¼‰ä¸åŸå§‹æ•°æ®ï¼ˆoriginal_dfï¼‰å¯èƒ½ä¸å¯¹åº”
3. **ä¼˜å…ˆä»DataFrameè¯»å–**ï¼šå…³é”®å­—æ®µï¼ˆå¦‚project_id, source_fileï¼‰åº”è¯¥ä»original_dfè¯»å–ï¼Œç¡®ä¿ä¸€è‡´æ€§

---

## ğŸ“ éªŒè¯çŠ¶æ€

1. âœ… source_fileæ˜¯å¦ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼ˆå·²éªŒè¯ï¼šæ­£ç¡®ï¼‰
2. âœ… target_files6å…ƒç»„æ˜¯å¦æ­£ç¡®ï¼ˆå·²éªŒè¯ï¼šæ­£ç¡®ï¼‰
3. âœ… window.pyçš„ä¿®å¤ï¼ˆå·²å®æ–½ï¼‰
4. â³ Excelå†™å…¥æ˜¯å¦æ­£å¸¸ï¼ˆå¾…ç”¨æˆ·æµ‹è¯•ï¼‰
5. â³ é‡å¤è®°å½•æ˜¯å¦æ¶ˆå¤±ï¼ˆå¾…ç”¨æˆ·æµ‹è¯•ï¼‰

---

## âœ… å®æ–½çš„ä¿®å¤

### window.py ç¬¬1044-1067è¡Œ

**å…³é”®æ”¹è¿›**ï¼š
- âœ… ä»`original_df.iloc[item_index]`è¯»å–é¡¹ç›®å·ï¼Œç¡®ä¿ä¸source_fileä¸€è‡´
- âœ… ä¼˜å…ˆä»'é¡¹ç›®å·'åˆ—è¯»å–
- âœ… å…œåº•æ–¹æ¡ˆï¼šä»source_fileæ–‡ä»¶åæå–
- âœ… å¼‚å¸¸å¤„ç†ï¼šå¦‚æœå¤±è´¥ï¼Œé€€å›åˆ°ä»UIè¯»å–
- âœ… è¯¦ç»†æ—¥å¿—ï¼šä¾¿äºè°ƒè¯•

---

**ä¿®å¤æ—¶é—´**ï¼š2025-11-10  
**çŠ¶æ€**ï¼šâœ… å·²å®æ–½ï¼Œå¾…ç”¨æˆ·éªŒè¯

