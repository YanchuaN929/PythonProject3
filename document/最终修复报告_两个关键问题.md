# 最终修复报告 - 两个关键问题

**日期**: 2025-11-13  
**状态**: ✅ 已修复，等待测试验证

---

## 问题回顾

### 问题1：接口更新功能失效
**现象**: 之前当一个已审查的接口的预期时间被修改后，该接口会另起一行重新开始走记录流程，但现在这一功能失效了。

**根本原因**: 在`batch_upsert_tasks`中，逻辑检查顺序错误。当任务已确认且完成列有值时，直接保持了确认状态，**没有优先检查预期时间是否变化**，导致即使预期时间变化也不会触发归档和重置。

### 问题2：已忽略的更新功能依然失效
**现象**: 已忽略的接口在预期时间变化后，没有自动取消忽略。

**根本原因**: 
1. 忽略快照检查逻辑存在，但执行位置不对
2. 忽略快照检查的代码块缩进错误，导致逻辑嵌套在错误的位置

---

## 修复方案

### 修复1：调整逻辑检查顺序（registry/service.py）

**位置**: `batch_upsert_tasks`函数，约第1107-1158行

**修改前的逻辑顺序**:
```
1. 检查完成列是否被清空
2. 检查是否已确认且完成列有值 → 保持确认状态
3. 检查预期时间是否变化 → 归档和重置
```

**修改后的逻辑顺序**:
```
1. 【优先】检查预期时间是否变化 → 归档和重置
2. 检查完成列是否被清空
3. 检查是否已确认且完成列有值 → 保持确认状态
```

**关键代码**:
```python
# 【关键修复】优先检查接口时间是否变化（预期时间变化应该触发归档和重置）
if should_reset_task_status(old_task['interface_time'], fields.get('interface_time', ''), 
                           old_completed_val, new_completed_val):
    # 如果有完整数据链，归档旧记录
    if old_task.get('completed_at') and old_task.get('confirmed_at'):
        print(f"[Registry版本化-批量] {key['interface_id']} 检测到预期时间变化，之前有完整数据链，归档旧记录")
        # 归档逻辑...
    
    # 预期时间变化，重置状态
    print(f"[Registry] 接口{key['interface_id']}: 预期时间变化，重置状态")
    fields['display_status'] = '待完成' if old_task['responsible_person'] else '请指派'
    fields['status'] = Status.OPEN
    # 清除完成和确认相关字段
    fields['completed_at'] = None
    fields['completed_by'] = None
    fields['confirmed_at'] = None
    fields['confirmed_by'] = None
```

---

### 修复2：修正忽略快照检查的位置和缩进

**位置**: `batch_upsert_tasks`函数，约第1038-1100行

**问题**: 
- 忽略快照检查的代码块缩进错误
- 导致后续的状态继承逻辑被错误地嵌套在忽略检查内部

**修复**: 
- 将忽略快照检查独立为一个顶层逻辑块
- 确保状态继承逻辑在正确的缩进级别执行
- 添加`time_changed_due_to_ignore`标志，用于后续逻辑判断

**关键代码**:
```python
# 【新增】基于快照检测预期时间变化并自动取消忽略
# 这个检查要在预期时间变化重置之前，确保忽略状态被正确取消
time_changed_due_to_ignore = False
if old_task and old_task.get('ignored') == 1:
    # 查询忽略快照
    cursor = conn.execute("""
        SELECT snapshot_interface_time, ignored_at, ignored_by, ignored_reason, row_index
        FROM ignored_snapshots
        WHERE file_type = ? AND project_id = ? AND interface_id = ?
        ORDER BY ignored_at DESC
        LIMIT 1
    """, (...))
    snapshot = cursor.fetchone()
    
    if snapshot:
        snapshot_time_norm = normalize_time_for_ignore(snapshot_time)
        current_time_norm = normalize_time_for_ignore(current_interface_time)
        
        if snapshot_time_norm and current_time_norm and snapshot_time_norm != current_time_norm:
            print(f"[Registry自动取消忽略] {key['interface_id']}: 预期时间变化")
            time_changed_due_to_ignore = True
            
            # 取消忽略标记
            fields['ignored'] = 0
            # ... 删除快照记录

# 【关键】处理任务状态继承和重置逻辑（正确的缩进级别）
if old_task:
    # 检查是否因为时间变化取消了忽略
    need_force_reset = time_changed_due_to_ignore
    
    # 优先检查预期时间是否变化
    if should_reset_task_status(...):
        # 归档和重置
```

---

## 预期效果

### 问题1修复后的效果
1. 已审查的接口，预期时间变化后，会：
   - 归档旧记录（带完整数据链）
   - 创建新的待完成任务
   - 保留指派信息
   - 清除完成和确认相关字段

2. 控制台输出：
```
[Registry版本化-批量] S-XXX-XXX 检测到预期时间变化，之前有完整数据链，归档旧记录
[Registry版本化-批量] 旧记录已归档: xxx -> yyy
[Registry] 接口S-XXX-XXX: 预期时间变化，重置状态
```

### 问题2修复后的效果
1. 已忽略的接口，预期时间变化后，会：
   - 检测到快照时间与当前时间不一致
   - 取消忽略标记（`ignored=0`）
   - 删除快照记录
   - 然后触发问题1的归档和重置流程（如果有完整数据链）

2. 控制台输出：
```
[忽略快照检查] 接口S-XXX-XXX
  快照时间: '2025-11-10' -> 标准化: '2025-11-10'
  当前时间: '2025-12-20' -> 标准化: '2025-12-20'
  快照行号: 100, 当前行号: 100
[Registry自动取消忽略] S-XXX-XXX: 预期时间变化 (2025-11-10 -> 2025-12-20)
[Registry] 已删除忽略快照记录
[Registry版本化-批量] S-XXX-XXX 检测到预期时间变化，之前有完整数据链，归档旧记录
[Registry] 接口S-XXX-XXX: 预期时间变化，重置状态
```

---

## 测试方案

已创建测试文件：`tests/test_fixed_issues.py`

### 测试用例1：`test_confirmed_task_time_change_archives`
- 创建并确认任务
- 修改预期时间
- 验证有归档记录
- 验证新记录状态是`open`

### 测试用例2：`test_ignored_task_time_change_unignores`
- 创建任务
- 忽略任务
- 验证快照已创建
- 修改预期时间
- 验证忽略被取消
- 验证快照被删除

---

## 用户验证步骤

### 验证问题1已修复
1. 找一个已审查的接口
2. 在Excel中修改其预期时间（如从2025-11-10改为2025-12-20）
3. 运行程序
4. 查看控制台输出，应该有"检测到预期时间变化，归档旧记录"
5. 在历史查询中搜索该接口，应该有2条记录（1条归档，1条待完成）

### 验证问题2已修复
1. 以所领导角色登录
2. 忽略一个延期任务
3. 在Excel中修改其预期时间
4. 运行程序
5. 查看控制台输出，应该有"[Registry自动取消忽略]"
6. 该接口应该重新显示在主窗口中

---

## 技术总结

### 关键改进
1. **逻辑检查顺序优化**: 确保预期时间变化检查优先于状态继承检查
2. **代码结构修正**: 修正了嵌套缩进导致的逻辑错误
3. **状态管理清晰化**: 使用`time_changed_due_to_ignore`标志明确标记忽略取消的原因

### 已知风险
1. 代码改动较大，可能影响其他逻辑
2. 需要全面的回归测试
3. 建议用户先在测试环境验证

---

**请用户先测试，如有问题立即反馈！**

