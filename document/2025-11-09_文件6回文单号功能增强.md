# 文件6回文单号功能增强实施报告

**实施日期**: 2025-11-09  
**实施人员**: AI Assistant  
**任务来源**: 用户需求

---

## 📋 需求概述

### 需求1：文件6自动更新M列
当设计人员写入回文单号时，程序需要自动判断回复是否及时：
- 对比**当前日期**和**I列（预期时间）**
- 如果 当前日期 ≤ 预期时间 → 写入 `"按时回复"`
- 如果 当前日期 > 预期时间 → 写入 `"延期回复"`

### 需求2：历史记录增加回文单号字段
- 在Registry数据库中增加`response_number`字段
- 记录本程序写入的回文单号
- 历史查询UI显示该字段
- 支持导出到Excel

---

## 🔧 实施内容

### 1️⃣ 修改`input_handler.py` - 文件6自动更新M列

**文件**: `input_handler.py`  
**修改位置**: `write_response_to_excel`函数（第278-324行）

**修改内容**:
```python
# 【新增】文件6特殊逻辑：自动更新M列（回复状态列）
if file_type == 6:
    try:
        # I列（索引8）是预期时间列
        expected_time_cell = ws.cell(row_index, 9)  # I列是第9列（A=1）
        expected_time = expected_time_cell.value
        
        # 比较当前日期和预期时间
        from datetime import datetime
        today = date.today()
        
        # 解析预期时间
        if expected_time:
            try:
                # 尝试解析为日期对象
                if isinstance(expected_time, datetime):
                    expected_date = expected_time.date()
                elif isinstance(expected_time, date):
                    expected_date = expected_time
                else:
                    # 尝试字符串解析
                    import pandas as pd
                    parsed = pd.to_datetime(expected_time, errors='coerce')
                    if pd.notna(parsed):
                        expected_date = parsed.date()
                    else:
                        expected_date = None
                
                # 根据对比结果写入M列（第13列）
                if expected_date:
                    if today <= expected_date:
                        reply_status = "按时回复"
                    else:
                        reply_status = "延期回复"
                    
                    ws.cell(row_index, 13, reply_status)  # M列是第13列
                    print(f"[文件6] 自动更新M列: {reply_status} (预期:{expected_date}, 实际:{today})")
```

**功能说明**:
- 读取I列（第9列）的预期时间
- 支持多种日期格式（datetime对象、date对象、字符串）
- 比较当前日期和预期时间
- 自动写入M列（第13列）："按时回复" 或 "延期回复"
- 即使M列更新失败，也不影响回文单号写入

---

### 2️⃣ 修改`registry/db.py` - 数据库Schema增加字段

**文件**: `registry/db.py`  
**修改位置**: `init_db`函数（第78-108行）

**修改内容**:
```python
CREATE TABLE IF NOT EXISTS tasks (
    ...
    confirmed_by TEXT DEFAULT NULL,
    responsible_person TEXT DEFAULT NULL,
    response_number TEXT DEFAULT NULL,  # 【新增】
    first_seen_at TEXT NOT NULL,
    ...
);
```

**字段说明**:
- **字段名**: `response_number`
- **类型**: TEXT
- **默认值**: NULL
- **用途**: 存储本程序写入的回文单号

---

### 3️⃣ 修改`registry/migrate.py` - 数据库迁移脚本

**文件**: `registry/migrate.py`  
**修改位置**: `migrate_database`函数（第39-49行）

**修改内容**:
```python
new_columns = [
    ("assigned_by", "TEXT DEFAULT NULL"),
    ("assigned_at", "TEXT DEFAULT NULL"),
    ("display_status", "TEXT DEFAULT NULL"),
    ("confirmed_by", "TEXT DEFAULT NULL"),
    ("responsible_person", "TEXT DEFAULT NULL"),
    ("business_id", "TEXT DEFAULT NULL"),
    ("response_number", "TEXT DEFAULT NULL")  # 【新增】
]
```

**功能说明**:
- 为现有数据库自动添加`response_number`字段
- 支持无缝升级，不影响已有数据

---

### 4️⃣ 修改`registry/hooks.py` - 记录回文单号

**文件**: `registry/hooks.py`  
**修改位置**: `on_response_written`函数（第336-342行）

**修改内容**:
```python
fields_to_update = {
    'display_status': display_status,
    'interface_time': old_interface_time,
    '_completed_col_value': '有值',
    'response_number': response_number  # 【新增】记录回文单号
}
```

**功能说明**:
- 在`on_response_written`钩子中捕获回文单号
- 通过`upsert_task`将回文单号写入数据库

---

### 5️⃣ 修改`registry/service.py` - 支持回文单号字段

**文件**: `registry/service.py`  
**修改内容**:

#### A. `upsert_task`函数（第205-260行）

**SQL修改**:
```python
INSERT INTO tasks (
    id, file_type, project_id, interface_id, source_file, row_index,
    business_id,
    department, interface_time, role, status, 
    assigned_by, assigned_at, display_status, confirmed_by, responsible_person,
    response_number, completed_at, confirmed_at,  # 【新增】response_number
    first_seen_at, last_seen_at
)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
ON CONFLICT(id) DO UPDATE SET
    ...
    response_number = COALESCE(excluded.response_number, response_number),  # 【新增】
    ...
```

**参数修改**:
```python
(
    ...
    fields.get('response_number'),  # 【新增】回文单号
    fields.get('completed_at'),
    fields.get('confirmed_at'),
    ...
)
```

#### B. `batch_upsert_tasks`函数（第697-750行）

**SQL修改**:
```python
INSERT INTO tasks (
    ...
    completed_at, confirmed_at, response_number  # 【新增】response_number
)
VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
ON CONFLICT(id) DO UPDATE SET
    ...
    response_number = COALESCE(excluded.response_number, response_number)  # 【新增】保持已有回文单号
```

**功能说明**:
- `upsert_task`: 支持写入和更新`response_number`
- `batch_upsert_tasks`: 从Excel处理时保持已有回文单号（使用COALESCE）

---

### 6️⃣ 修改`registry/history_ui.py` - 历史查询UI显示

**文件**: `registry/history_ui.py`  
**修改内容**:

#### A. 添加"回文单号"列（第233-257行）

```python
# 创建Treeview
columns = (
    '序号', '文件类型', '状态', '首次发现', '完成时间', 
    '确认时间', '归档时间', '指派人', '设计人员', '上级人员',
    '回文单号', '接口时间', '最后出现', '消失时间'  # 【新增】回文单号
)

column_widths = {
    ...
    '回文单号': 150,  # 【新增】回文单号列
    ...
}
```

#### B. 显示回文单号（第326-344行）

```python
# 【新增】回文单号
response_number = task.get('response_number') or '-'

values = (
    idx,
    file_type_name,
    display_status,
    format_time(task.get('first_seen_at')),
    format_time(task.get('completed_at')),
    format_time(task.get('confirmed_at')),
    format_time(task.get('archived_at')) if task.get('archive_reason') else '-',
    assignor_display,
    assignee_name,
    superior_name,
    response_number,  # 【新增】回文单号
    task.get('interface_time') or '-',
    format_time(task.get('last_seen_at')),
    format_time(task.get('missing_since')),
)
```

#### C. 导出Excel支持（第380-401行）

```python
# 【新增】回文单号
response_number = task.get('response_number') or '-'

export_data.append({
    '序号': idx,
    '文件类型': file_type_name,
    ...
    '回文单号': response_number,  # 【新增】回文单号
    '接口时间': task.get('interface_time') or '-',
    ...
})
```

**功能说明**:
- 在历史查询结果表格中显示"回文单号"列
- 支持导出到Excel
- 列宽150像素，显示位置在"上级人员"和"接口时间"之间

---

## 📊 修改文件清单

| 序号 | 文件路径 | 修改内容 | 行数变化 |
|------|---------|---------|---------|
| 1 | `input_handler.py` | 文件6自动更新M列 | +47 |
| 2 | `registry/db.py` | Schema增加response_number字段 | +1 |
| 3 | `registry/migrate.py` | 迁移脚本支持新字段 | +2 |
| 4 | `registry/hooks.py` | 记录回文单号 | +1 |
| 5 | `registry/service.py` | upsert支持response_number | +7 |
| 6 | `registry/history_ui.py` | UI显示和导出回文单号 | +7 |

**总计**: 6个文件，新增约65行代码

---

## 🎯 功能验证要点

### 验证1：文件6自动更新M列

**测试步骤**:
1. 打开文件6（收发文清单）
2. 找到一条I列有预期时间的记录
3. 点击"写入回文单号"
4. 检查M列是否自动更新为"按时回复"或"延期回复"

**预期结果**:
- 如果当前日期 ≤ I列日期：M列 = `"按时回复"`
- 如果当前日期 > I列日期：M列 = `"延期回复"`
- 控制台输出：`[文件6] 自动更新M列: 按时回复 (预期:2025-11-15, 实际:2025-11-09)`

---

### 验证2：回文单号记录

**测试步骤**:
1. 写入回文单号（任意文件类型）
2. 点击"历史查询"
3. 输入项目号和接口号
4. 查看历史记录

**预期结果**:
- 历史记录表格中显示"回文单号"列
- 已写入回文单号的记录显示具体单号
- 未写入的记录显示"-"

---

### 验证3：导出Excel包含回文单号

**测试步骤**:
1. 在历史查询窗口点击"导出Excel"
2. 打开导出的Excel文件

**预期结果**:
- Excel中包含"回文单号"列
- 数据正确导出

---

### 验证4：数据库迁移

**测试步骤**:
1. 使用已有的旧版本数据库
2. 启动程序
3. 检查控制台输出

**预期结果**:
- 控制台输出：`[Migrate] Added column: response_number`
- 程序正常运行，不报错

---

## ⚠️ 注意事项

### 1. 数据一致性
- **问题**: 旧的历史记录没有回文单号
- **解决**: 显示为"-"，不影响功能

### 2. M列更新失败容错
- **处理**: 即使M列更新失败，回文单号仍会写入L、J、N列
- **原因**: 使用try-except包裹M列更新逻辑

### 3. 字段保留策略
- **batch_upsert**: 使用`COALESCE(excluded.response_number, response_number)`
- **原因**: Excel处理时不会覆盖已有的回文单号

### 4. 兼容性
- **向后兼容**: 所有修改都是增量式的，不破坏现有功能
- **数据库兼容**: 通过迁移脚本自动升级旧数据库

---

## 📝 用户使用说明

### 功能1：文件6自动判断回复及时性

当您为文件6（收发文清单）写入回文单号时：
1. 程序会自动读取I列（预期回复时间）
2. 对比当前日期和预期时间
3. 自动在M列填写"按时回复"或"延期回复"
4. 无需手动填写M列

**示例**:
- I列日期：2025-11-15
- 今天：2025-11-09
- 程序自动写入M列：`"按时回复"`

---

### 功能2：历史查询显示回文单号

在历史查询界面：
1. 点击"历史查询"按钮
2. 输入项目号和接口号
3. 在结果表格中可以看到"回文单号"列
4. 显示该接口的所有历史回文单号
5. 支持导出到Excel

**说明**:
- 只记录本程序写入的回文单号
- 如果接口没有写过回文单号，显示"-"
- 历史记录按时间倒序排列

---

## ✅ 完成状态

| 任务项 | 状态 |
|--------|------|
| 文件6自动更新M列 | ✅ 完成 |
| 数据库Schema增加字段 | ✅ 完成 |
| 数据库迁移脚本 | ✅ 完成 |
| Registry记录回文单号 | ✅ 完成 |
| Service层支持新字段 | ✅ 完成 |
| 历史查询UI显示 | ✅ 完成 |
| 导出Excel支持 | ✅ 完成 |

---

## 🔄 后续建议

1. **测试验证**: 建议在测试环境充分测试后再部署到生产环境
2. **数据备份**: 首次运行新版本前，建议备份`registry.db`数据库
3. **性能监控**: 如果历史记录过多，关注查询性能
4. **功能扩展**: 未来可考虑支持批量查询多个接口的回文单号

---

**报告生成时间**: 2025-11-09  
**实施状态**: ✅ 全部完成

