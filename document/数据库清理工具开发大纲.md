# 数据库清理工具开发大纲

## 1. 背景与需求

### 1.1 问题描述
- SQLite 数据库文件 `registry.db` 在网络盘上损坏
- 错误信息：`database disk image is malformed`
- 多用户同时使用主程序，数据库文件被占用
- 无法直接删除，提示"文件被占用"

### 1.2 目标
开发一个独立的清理工具，能够：
1. 检测并显示数据库文件的占用状态
2. 通知/强制断开占用的连接
3. 安全地删除损坏的数据库文件
4. 支持网络路径（UNC 路径）

### 1.3 使用场景
- 管理员在服务器端或任意客户端运行
- 需要清理损坏的共享数据库文件
- 用户无需关闭程序（工具自动处理）

---

## 2. 技术方案

### 2.1 核心功能模块

```
┌─────────────────────────────────────────────────────┐
│                  数据库清理工具                      │
├─────────────────────────────────────────────────────┤
│  1. 路径配置模块     - 定位数据库文件                │
│  2. 占用检测模块     - 检测文件占用状态              │
│  3. 占用解除模块     - 断开连接/结束进程             │
│  4. 文件操作模块     - 删除/重命名/备份              │
│  5. 日志记录模块     - 记录操作过程                  │
│  6. GUI 界面模块     - 简单的操作界面                │
└─────────────────────────────────────────────────────┘
```

### 2.2 技术选型

| 组件 | 选择 | 说明 |
|------|------|------|
| 语言 | Python 3.8+ | 与主程序保持一致 |
| GUI | Tkinter | 轻量级，无需额外依赖 |
| 文件占用检测 | psutil / handle.exe | 检测哪些进程占用文件 |
| 进程管理 | psutil / taskkill | 结束占用进程 |
| 打包 | PyInstaller | 生成独立 exe |

### 2.3 依赖库

```
psutil>=5.9.0    # 进程和文件占用检测
```

---

## 3. 详细设计

### 3.1 路径配置模块

```python
功能：
- 自动检测默认数据库路径
- 支持手动输入/浏览路径
- 支持 UNC 网络路径 (\\server\share\...)
- 验证文件是否存在

默认路径模式：
- {数据文件夹}/.registry/registry.db
- 例如：//10.102.2.7/文件服务器/.../各项目内外部接口手册/.registry/registry.db
```

### 3.2 占用检测模块

```python
功能：
- 检测文件是否被占用
- 列出占用该文件的所有进程（进程名、PID、用户、机器名）
- 区分本地进程和网络访问

实现方案 A（推荐）：使用 psutil
- psutil.process_iter() 遍历进程
- process.open_files() 获取打开的文件
- 匹配目标文件路径

实现方案 B：使用 Sysinternals Handle.exe
- 调用 handle.exe 命令行工具
- 解析输出获取占用信息
- 需要管理员权限

输出格式：
[
    {"pid": 1234, "name": "接口筛选.exe", "user": "张三", "machine": "PC-001"},
    {"pid": 5678, "name": "接口筛选.exe", "user": "李四", "machine": "PC-002"},
]
```

### 3.3 占用解除模块

```python
功能：
- 方式1：温和请求 - 发送关闭信号
- 方式2：强制结束 - 终止进程
- 方式3：等待超时 - 设置等待时间后强制

实现：
- 本地进程：taskkill /PID xxx /F
- 远程进程：需要管理员权限或通知用户手动关闭

安全措施：
- 确认对话框，防止误操作
- 记录被结束的进程信息
- 支持"仅断开连接，不结束进程"（如果可行）
```

### 3.4 文件操作模块

```python
功能：
- 删除：直接删除 registry.db
- 重命名：registry.db → registry.db.malformed.{timestamp}.bak
- 清理附属文件：registry.db-shm, registry.db-wal
- 重建：创建新的空数据库（可选）

操作顺序：
1. 先尝试重命名（保留备份）
2. 重命名失败再尝试删除
3. 清理 WAL 相关文件
4. 验证操作结果
```

### 3.5 日志记录模块

```python
功能：
- 记录所有操作到日志文件
- 日志位置：工具同目录/db_cleaner.log
- 格式：[时间] [级别] 消息

记录内容：
- 检测到的占用信息
- 执行的操作
- 操作结果
- 错误信息
```

### 3.6 GUI 界面模块

```
┌────────────────────────────────────────────────────┐
│  数据库清理工具 v1.0                          [X]  │
├────────────────────────────────────────────────────┤
│                                                    │
│  数据库路径：                                      │
│  ┌──────────────────────────────────┐ [浏览...]   │
│  │ //10.102.../registry.db          │             │
│  └──────────────────────────────────┘             │
│                                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │ 状态信息显示区域                              │ │
│  │                                              │ │
│  │ [2024-01-01 10:00:00] 检测到 3 个进程占用    │ │
│  │   - 接口筛选.exe (PID: 1234) 用户: 张三     │ │
│  │   - 接口筛选.exe (PID: 5678) 用户: 李四     │ │
│  │   - 接口筛选.exe (PID: 9012) 用户: 王五     │ │
│  │                                              │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  [检测占用]  [结束所有占用]  [删除数据库]  [退出]  │
│                                                    │
│  ⚠ 警告：结束占用会导致相关用户程序崩溃           │
└────────────────────────────────────────────────────┘
```

---

## 4. 关键代码结构

```
db_cleaner/
├── main.py              # 入口，GUI 主窗口
├── detector.py          # 占用检测模块
├── terminator.py        # 进程终止模块
├── file_ops.py          # 文件操作模块
├── logger.py            # 日志模块
├── config.py            # 配置（默认路径等）
└── db_cleaner.spec      # PyInstaller 打包配置
```

### 4.1 核心类设计

```python
class DatabaseCleaner:
    """数据库清理器主类"""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
        
    def detect_locks(self) -> List[ProcessInfo]:
        """检测文件占用"""
        pass
        
    def terminate_processes(self, pids: List[int], force: bool = False) -> bool:
        """终止占用进程"""
        pass
        
    def delete_database(self, backup: bool = True) -> bool:
        """删除数据库文件"""
        pass
        
    def cleanup_wal_files(self) -> bool:
        """清理 WAL 相关文件"""
        pass
```

---

## 5. 使用流程

```
1. 启动工具
   │
2. 输入/浏览数据库路径
   │
3. 点击"检测占用"
   │
   ├── 无占用 → 直接删除/重命名
   │
   └── 有占用 → 显示占用列表
               │
               ├── 选择"通知用户" → 等待用户关闭程序
               │
               └── 选择"强制结束" → 确认对话框 → 结束进程
                                              │
4. 点击"删除数据库"
   │
5. 确认对话框
   │
6. 执行删除/重命名
   │
7. 显示结果
```

---

## 6. 注意事项

### 6.1 权限问题
- 本地进程：需要管理员权限才能结束其他用户的进程
- 网络文件：需要对共享文件夹有写入权限
- 远程进程：无法直接结束，只能通知用户

### 6.2 网络路径特殊处理
- UNC 路径需要特殊处理
- 网络延迟可能导致状态不一致
- 文件服务器可能缓存文件句柄

### 6.3 安全考虑
- 多次确认，防止误操作
- 默认备份而非直接删除
- 记录详细日志供审计

### 6.4 用户体验
- 操作前明确告知影响
- 提供"温和模式"（仅检测，不操作）
- 支持命令行模式（自动化运维）

---

## 7. 扩展功能（可选）

1. **广播通知**：向所有占用用户发送消息，请求关闭程序
2. **定时重试**：设置定时任务，等待用户关闭后自动删除
3. **数据库修复**：尝试使用 `sqlite3 .recover` 恢复数据
4. **健康检查**：定期检查数据库完整性（`PRAGMA integrity_check`）
5. **远程执行**：支持通过 SSH/WMI 在远程机器执行操作

---

## 8. 打包配置

```python
# db_cleaner.spec
a = Analysis(
    ['main.py'],
    datas=[],
    hiddenimports=['psutil'],
)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.datas,
    name='数据库清理工具',
    console=False,  # 无控制台窗口
    icon='cleaner.ico',
    uac_admin=True,  # 请求管理员权限
)
```

---

## 9. 测试要点

1. **本地文件测试**：在本地创建测试数据库，验证检测和删除，需要在本地也模拟网络共享环境
2. **网络文件测试**：在网络共享上测试
3. **多用户占用测试**：模拟多个进程占用同一文件
4. **权限测试**：普通用户 vs 管理员权限
5. **边界情况**：文件不存在、路径无效、无权限等

---

## 10. 预期交付物

1. `数据库清理工具.exe` - 独立可执行文件
2. `README.txt` - 使用说明
3. 源代码（用于后续维护）

---

**编写日期**：2025-12-01  
**适用场景**：清理网络共享上被多用户占用的损坏 SQLite 数据库

