# 历史记录版本化功能实施报告

**实施日期**: 2025-11-12  
**版本**: v1.1  

---

## 📋 需求总结

用户提出的三个问题及解决方案：

### 1. **上级人员点击勾选框无响应** ✅
**问题**: 设计人员填入回文单号后，上级人员点击勾选框不响应，控制台报错"无法获取项目号或接口号"

**根本原因**: 
- `_bind_checkbox_click_event`中的metadata从`display_df`获取，而`display_df`是优化后的DataFrame，缺少`project_id`和`interface_id`等原始列

**修复方案**:
- 在`window.py`的`display_excel_data`函数中，确保metadata从`filtered_df`（完整数据）获取`project_id`和`interface_id`
- 修复后，上级人员可以正常点击勾选框进行确认/取消确认操作

**修改文件**: 
- `window.py` (metadata存储逻辑)

---

### 2. **开始处理弹窗统计包含待审查任务** ✅
**问题**: 设计人员点击"开始处理"后，弹窗中显示的数量统计仍然包含待审查的个数，但导出结果中已经没有了

**根本原因**:
- `base.py`的`start_processing`函数在计算弹窗统计时，没有应用`_exclude_pending_confirmation_rows`过滤

**修复方案**:
- 在计算`display_count`之前，对`results1`和`results2`应用过滤函数
- 确保弹窗统计数字与实际显示/导出的数据一致

**修改文件**:
- `base.py` (`start_processing`函数，completion_messages部分)

---

### 3. **历史记录版本化机制** ✅
**问题**: 当接口更新/重置后，之前的完成确认信息被覆盖，历史记录意义丧失

**需求定义**:
- **更新/重置**: 完成时间列数据值变为空，且预期时间列值变化
- **完整数据链**: 发现-完成-确认（无须归档）
- **触发条件**: 检测到更新/重置时，如果之前有完整数据链，就创建新轮次记录
- **显示要求**: 显示所有轮次记录（包括已归档），新轮次记录的`first_seen_at`标注为"(更新日期)YYYY-MM-DD"

**实施方案**:

#### 3.1 增强7天归档逻辑
**文件**: `registry/service.py`

- **阶段1**: 标记消失任务（status='open'或'completed'，且last_seen_at过期）
- **阶段2**: 归档超期消失任务（missing_since超过7天）
- **阶段3（新增）**: 确认后7天归档（status='confirmed'，且confirmed_at超过7天）

```python
# 阶段3：确认后7天归档
confirmed_cutoff_date = (now - timedelta(days=7)).isoformat()

cursor = conn.execute("""
    SELECT id, interface_id, confirmed_at FROM tasks
    WHERE status = 'confirmed'
      AND confirmed_at IS NOT NULL
      AND confirmed_at < ?
""", (confirmed_cutoff_date,))

# 归档并设置 archived_at, archive_reason='confirmed_expired'
```

#### 3.2 添加`archived_at`字段
**文件**: 
- `registry/db.py` (表结构)
- `registry/migrate.py` (数据库迁移)

```sql
CREATE TABLE IF NOT EXISTS tasks (
    ...
    archived_at TEXT NULL
);
```

#### 3.3 实现历史记录版本化
**文件**: `registry/service.py` (`upsert_task`函数)

**核心逻辑**:
```python
# 检测更新/重置条件
if need_reset and old_task.get('completed_at') and old_task.get('confirmed_at'):
    # 有完整数据链，创建新轮次记录
    
    # 1. 归档旧记录
    # 修改row_index和id避免UNIQUE约束冲突
    archived_row_index = -1000000 - int(time.time() % 1000000)
    archived_tid = calc_tid(...)
    conn.execute("""
        UPDATE tasks
        SET id = ?,
            row_index = ?,
            status = 'archived',
            archive_reason = 'updated',
            archived_at = ?
        WHERE id = ?
    """, (archived_tid, archived_row_index, now_str, old_tid))
    
    # 2. 创建新记录
    # 设置first_seen_at为"(更新日期)YYYY-MM-DD"格式
    update_date = now.strftime('%Y-%m-%d')
    fields['_versioned_first_seen'] = f"(更新日期){update_date}"
    
    # 重置need_reset标志，因为新记录是全新任务
    need_reset = False
```

**UNIQUE约束处理策略**:
- 数据库有`UNIQUE(file_type, project_id, interface_id, source_file, row_index)`约束
- 归档旧记录时，将其`id`和`row_index`修改为基于负数row_index的新值
- 这样新记录可以正常插入，不会触发UNIQUE约束冲突
- 历史查询通过`business_id`查询，可以获取所有版本（包括归档的）

#### 3.4 修改历史UI显示
**文件**: `registry/history_ui.py`

**`format_time`函数增强**:
```python
def format_time(time_str):
    """格式化时间显示"""
    # 【历史记录版本化】如果是更新日期格式，直接返回
    str_val = str(time_str)
    if str_val.startswith('(更新日期)'):
        return str_val
    
    # 否则解析ISO格式...
```

**查询逻辑**:
- `query_task_history`函数不过滤已归档记录
- 所有轮次记录（包括`status='archived'`）都会显示在历史UI中
- 按`first_seen_at`倒序排列，最新的在最上面

---

## 🔧 技术实现细节

### 数据库Schema变更
```sql
-- 新增字段
ALTER TABLE tasks ADD COLUMN archived_at TEXT NULL;
```

### 核心文件修改清单
| 文件 | 修改内容 | 影响范围 |
|-----|---------|---------|
| `registry/service.py` | 增强`finalize_scan`，添加确认后7天归档逻辑 | 归档机制 |
| `registry/service.py` | 修改`upsert_task`，实现历史记录版本化 | 任务创建/更新 |
| `registry/service.py` | 修复`mark_confirmed`等函数，使用business_id查找任务 | 确认功能 |
| `registry/db.py` | 添加`archived_at`字段到tasks表 | 数据库结构 |
| `registry/migrate.py` | 添加`archived_at`到迁移脚本 | 数据库升级 |
| `registry/history_ui.py` | 修改`format_time`，支持更新日期格式 | 历史UI显示 |
| `window.py` | 修复metadata获取逻辑 | 勾选框功能 |
| `base.py` | 修复弹窗统计逻辑 | 开始处理功能 |

---

## ✅ 功能验证清单

- [x] 问题1：上级人员可以正常点击勾选框
- [x] 问题2：弹窗统计数字与实际显示一致
- [x] 问题3：历史记录版本化
  - [x] 检测更新/重置条件
  - [x] 归档旧记录（有完整数据链）
  - [x] 创建新轮次记录
  - [x] 新记录first_seen_at标注为"(更新日期)YYYY-MM-DD"
  - [x] 历史UI显示所有轮次（包括已归档）
  - [x] 确认后7天自动归档
- [x] 数据库迁移脚本更新
- [x] 代码无语法错误
- [x] **Pytest测试覆盖：6个测试场景全部通过** ✅
- [x] **2025-11-12更新：确认功能修复** ✅

---

## 🎯 测试建议

### 测试场景1：历史记录版本化
1. 创建一个接口任务（文件类型1，项目2016）
2. 设计人员填写回文单号 → 状态变为"待审查"
3. 上级人员确认 → 状态变为"已审查"，任务消失
4. 修改Excel中的接口时间（K列），删除回文单号（M列）
5. 再次"开始处理" → 应该检测到更新/重置
6. 打开历史查询 → 应该看到两条记录：
   - 第一条：已归档，状态"已归档"，归档原因"updated"
   - 第二条：待完成，首次发现显示"(更新日期)2025-11-12"

### 测试场景2：确认后7天归档
1. 创建并确认一个任务
2. 修改系统时间到8天后（或修改数据库中的`confirmed_at`字段）
3. 运行"开始处理" → 应该触发归档逻辑
4. 打开历史查询 → 应该看到任务状态变为"已归档"，归档原因"confirmed_expired"

### 测试场景3：上级勾选框功能
1. 设计人员填写回文单号
2. 切换到上级账户
3. 点击勾选框 → 应该正常确认，无报错
4. 再次点击勾选框 → 应该正常取消确认

### 测试场景4：弹窗统计准确性
1. 设计人员账户，有2个待完成任务，1个待审查任务
2. 点击"开始处理" → 弹窗应显示2个待完成任务（不包括待审查）
3. 导出Excel → 应该只有2条记录

---

## 📝 注意事项

### UNIQUE约束处理
- 归档记录的`id`和`row_index`都被修改，释放UNIQUE约束
- 历史查询通过`business_id`查询，可以获取所有版本
- 负数`row_index`只是用于规避UNIQUE约束，不会在UI中显示

### 数据迁移
- 首次运行时会自动添加`archived_at`字段
- 旧数据不受影响，`archived_at`为NULL
- 新的归档操作会填充`archived_at`字段

### 版本化触发条件
- **必须同时满足**：
  1. `completed_at`变空（Excel中完成列被删除）
  2. `interface_time`变化（接口时间发生变化）
  3. 旧记录有`completed_at`和`confirmed_at`（完整数据链）
- 如果缺少任一条件，不会触发版本化，而是按原逻辑重置状态

### 确认功能修复（2025-11-12）
- `mark_completed`、`mark_confirmed`、`mark_unconfirmed`函数现在使用`business_id`查找最新的非归档任务
- 这确保了即使归档记录的`id`被修改，确认功能仍能正常工作

---

## 🔧 2025-11-12更新：确认功能修复

**问题描述**：
- 控制台输出了确认信息，但实际没有写入数据库
- 主显示窗重新处理后依旧显示已确认的接口
- 后台的确认人和确认时间没有被写入

**根本原因**：
- 历史记录版本化实现中，归档旧记录时修改了`id`字段
- `mark_confirmed`等函数使用计算的`tid`查找记录，但归档后的记录id已变，导致找不到记录

**修复方案**：
修改`mark_completed`、`mark_confirmed`、`mark_unconfirmed`函数，使用`business_id`查找最新的非归档任务：

```python
# 【版本化修复】使用business_id查找最新的非归档任务
business_id = make_business_id(key['file_type'], key['project_id'], key['interface_id'])

cursor = conn.execute("""
    SELECT id FROM tasks
    WHERE business_id = ?
      AND status != 'archived'
    ORDER BY last_seen_at DESC
    LIMIT 1
""", (business_id,))

row = cursor.fetchone()
if not row:
    print(f"[Registry] 警告: 找不到非归档任务 {key['interface_id']}")
    return

tid = row[0]
# 使用查找到的tid进行更新...
```

**修改文件**：
- `registry/service.py`: 修改`mark_completed`、`mark_confirmed`、`mark_unconfirmed`三个函数

**验证**：
- ✅ 所有pytest测试通过（6/6）
- ✅ 确认功能可以正常写入数据库

---

## 🎉 完成总结

本次实施完成了用户提出的所有问题的修复和增强：

1. ✅ **修复上级勾选框无响应问题**
2. ✅ **修复弹窗统计不一致问题**
3. ✅ **实现历史记录版本化机制**
4. ✅ **增强7天归档逻辑**（新增确认后7天归档）
5. ✅ **添加archived_at字段**
6. ✅ **修改历史UI显示**（支持更新日期格式）
7. ✅ **修复确认功能**（2025-11-12更新）

所有修改均已通过语法检查和测试验证，未引入新的linter错误。

---

**报告生成时间**: 2025-11-12  
**最后更新**: 2025-11-12 15:30  
**实施版本**: Registry v1.1 - 历史记录版本化（含确认功能修复）

