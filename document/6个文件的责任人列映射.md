# 6个文件的责任人列映射

**检查日期**：2025-11-12  
**数据来源**：main.py和distribution.py

---

## 责任人列映射表

| 文件类型 | Excel列名 | 列索引 | 代码位置 | 提取方式 |
|---------|----------|--------|---------|---------|
| **文件1**（内部需打开接口） | **R列** | **17** | main.py 第546行 | 提取中文字符 |
| **文件2**（内部需回复接口） | **AM列** | **38** | main.py 第1201行 | 提取中文字符 |
| **文件3**（外部需打开接口） | **AP列** | **41** | main.py 第1748行 | 提取中文字符 |
| **文件4**（外部需回复接口） | **AH列** | **33** | main.py 第2571行 | 提取中文字符 |
| **文件5**（三维提资接口） | **K列** | **10** | main.py（需确认） | 提取中文字符 |
| **文件6**（收发文函） | **X列** | **23** | main.py 第3732行 | 按分隔符拆分多人 |

---

## 详细说明

### 文件1：内部需打开接口
**位置**：main.py 第546-558行
```
# 新增"责任人"列（基于R列：索引17，提取中文）
zh_pattern = re.compile(r"[\u4e00-\u9fa5]+")
owners = []
for idx in result_df.index:
    cell_val = df.iloc[idx, 17] if 17 < len(df.columns) else None
    ...
```
- **Excel列**：R列（第18列）
- **索引**：17
- **提取方式**：使用正则表达式提取所有中文字符

---

### 文件2：内部需回复接口
**位置**：main.py 第1201-1214行
```
# 新增"责任人"列（基于AM列：索引38，提取中文）
zh_pattern = re.compile(r"[\u4e00-\u9fa5]+")
owners = []
for idx in result_df.index:
    cell_val = df.iloc[idx, 38] if 38 < len(df.columns) else None
    ...
```
- **Excel列**：AM列（第39列）
- **索引**：38
- **提取方式**：使用正则表达式提取所有中文字符

---

### 文件3：外部需打开接口
**位置**：main.py 第1748-1760行
```
# 新增"责任人"列（基于AP列：索引41，提取中文）
zh_pattern = re.compile(r"[\u4e00-\u9fa5]+")
owners = []
for idx in result_df.index:
    cell_val = df.iloc[idx, 41] if 41 < len(df.columns) else None
    ...
```
- **Excel列**：AP列（第42列）
- **索引**：41
- **提取方式**：使用正则表达式提取所有中文字符

---

### 文件4：外部需回复接口
**位置**：main.py 第2571-2583行
```
# 新增"责任人"列（基于AH列：索引33，提取中文）
try:
    zh_pattern = re.compile(r"[\u4e00-\u9fa5]+")
    owners = []
    for idx in result_df.index:
        cell_val = df.iloc[idx, 33] if 33 < len(df.columns) else None
        ...
```
- **Excel列**：AH列（第34列）
- **索引**：33
- **提取方式**：使用正则表达式提取所有中文字符

---

### 文件5：三维提资接口
**位置**：main.py 第3224-3235行
```
# 新增"责任人"列（基于K列：索引10，提取中文）
try:
    zh_pattern = re.compile(r"[\u4e00-\u9fa5]+")
    owners = []
    for idx in result_df.index:
        cell_val = df.iloc[idx, 10] if 10 < len(df.columns) else None
        s = str(cell_val) if cell_val is not None else ""
        found = zh_pattern.findall(s)
        owners.append("".join(found))
    result_df['责任人'] = owners
```
- **Excel列**：K列（第11列）
- **索引**：10
- **提取方式**：使用正则表达式提取所有中文字符

---

### 文件6：收发文函
**位置**：main.py 第3732-3754行
```
# 责任人：X列（索引23）按分隔符拆分并保留原始姓名集合（供过滤）
try:
    owners = []
    for idx in result_df.index:
        cell_val = df.iloc[idx, 23] if 23 < len(df.columns) else None
        s = str(cell_val) if cell_val is not None else ""
        # 分隔符：, ， ; ； / 、
        for sep in [',', '，', ';', '；', '/', '、']:
            s = s.replace(sep, ',')
        tokens = [t.strip() for t in s.split(',') if t.strip()]
        names_str = ','.join(tokens)
        
        # 【新增】过滤责任人：只保留在姓名角色表中存在的姓名
        if valid_names_set:
            filtered_names = filter_valid_names(names_str, valid_names_set)
            if filtered_names:
                names_str = filtered_names
        
        owners.append(names_str)
    result_df['责任人'] = owners
```
- **Excel列**：X列（第24列）
- **索引**：23
- **提取方式**：
  - 支持多个分隔符：`, ， ; ； / 、`
  - 拆分后过滤有效姓名
  - 支持多人责任人

---

## Excel列名与索引对照

### 按索引排序

| 索引 | 列名 | 用途 |
|------|------|------|
| 10 | K | 文件5责任人 |
| 17 | R | 文件1责任人 |
| 23 | X | 文件6责任人（多人） |
| 33 | AH | 文件4责任人 |
| 38 | AM | 文件2责任人 |
| 41 | AP | 文件3责任人 |

### 按文件类型排序

| 文件类型 | 列名 | 索引 |
|---------|------|------|
| 文件1 | R | 17 |
| 文件2 | AM | 38 |
| 文件3 | AP | 41 |
| 文件4 | AH | 33 |
| 文件5 | K | 10 |
| 文件6 | X | 23 |

---

## 代码统一性检查

### distribution.py中的映射
```python
def get_responsible_column(file_type):
    column_map = {
        1: 'R',   # 文件1责任人列（索引17）
        2: 'AM',  # 文件2责任人列（索引38）
        3: 'AP',  # 文件3责任人列（索引41）
        4: 'AH',  # 文件4责任人列（索引33）
        5: 'K',   # 文件5责任人列（索引10）
        6: 'X',   # 文件6责任人列（索引23）
    }
```

### main.py中的实际读取

| 文件 | distribution.py | main.py实际读取 | 是否一致 |
|------|----------------|----------------|---------|
| 文件1 | R (17) | R (17) | ✅ 一致 |
| 文件2 | AM (38) | AM (38) | ✅ 一致 |
| 文件3 | AP (41) | AP (41) | ✅ 一致 |
| 文件4 | AH (33) | AH (33) | ✅ 一致 |
| 文件5 | K (10) | K (10) | ✅ 一致 |
| 文件6 | X (23) | X (23) | ✅ 一致 |

---

## 关键发现

### 1. 所有文件的责任人列映射已确认

✅ **全部验证通过**：6个文件的责任人列在distribution.py和main.py中完全一致

| 文件类型 | 列名 | 索引 | 状态 |
|---------|------|------|------|
| 文件1 | R | 17 | ✅ |
| 文件2 | AM | 38 | ✅ |
| 文件3 | AP | 41 | ✅ |
| 文件4 | AH | 33 | ✅ |
| 文件5 | K | 10 | ✅ |
| 文件6 | X | 23 | ✅ |

### 2. 提取方式差异
- 文件1-5：使用正则表达式`[\u4e00-\u9fa5]+`提取中文字符
- 文件6：按分隔符拆分，支持多人，且会过滤姓名角色表

### 3. 空值处理
- 文件1-4：空值显示为"无"
- 文件6：空值为空字符串

---

## 用户报告的"重大错误"

用户提到发现了一个重大错误，要求检查6个文件的责任人读取逻辑。

**检查结果**：
- ✅ 所有6个文件的责任人列映射已确认正确
- ✅ distribution.py和main.py完全一致
- ✅ 所有文件都使用正确的列索引读取责任人

**可能的问题**：
1. **提取方式**：文件1-5使用正则提取中文，可能丢失英文姓名或特殊字符
2. **空值处理**：文件1-5空值为"无"，文件6为空字符串，不一致
3. **文件6多人**：文件6支持多人用分隔符分隔，其他文件不支持

**建议**：
- 请用户具体说明发现的"重大错误"是什么
- 是否发现某个文件读取的列不对？
- 是否有责任人数据丢失或错误？

