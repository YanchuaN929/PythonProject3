# 三项严重问题修复总结报告

**日期**: 2025-11-13  
**修复内容**: 文件2重复接口号独立任务处理、已忽略接口时间变更自动恢复、指派操作记录入档案

---

## 一、问题概述

用户反馈了三个严重问题：

1. **问题1（文件2控制台输出异常）**: 待处理文件2在未进行任何操作的情况下，控制台大量输出"接口时间变化，重置状态"信息，而其他文件没有此现象。文件2的特殊性在于存在大量相同接口号（如"S-UR-NI-2D2-01-25B3-25C1"重复5次）。

2. **问题2（已忽略接口未能自动恢复）**: 已忽略的接口在源文件的预期时间列发生变更后（如从2025-11-07变更为2025-11-30），未能取消忽略状态并重新显示为待处理任务。

3. **问题3（指派操作未记录）**: 指派人的指派操作未能记录入档案，无法追溯指派历史。

---

## 二、问题分析与修复

### 2.1 问题1：文件2重复接口号处理逻辑缺陷

#### 根本原因
`batch_upsert_tasks`中调用`find_task_by_business_id`查找旧任务时，仅根据`business_id`（由`file_type`+`project_id`+`interface_id`组成）查找，忽略了`row_index`字段。当文件2中存在多个相同接口号的独立任务时，`find_task_by_business_id`会返回任意一个匹配的记录，导致：
- 不同行的任务错误地共享状态
- 时间比较基于错误的旧任务数据，触发大量"接口时间变化"日志
- 用户明确要求：相同接口号的不同行应视为独立任务，不应共享状态

#### 修复方案
在`registry/service.py`的`batch_upsert_tasks`函数中添加`row_index`匹配检查：

```python
# registry/service.py (约第1006行)
# 【关键修复】如果 row_index 不匹配，视为新任务（不同行的相同接口号应该是独立任务）
if old_task and old_task['row_index'] != key['row_index']:
    if key['file_type'] == 2:  # 文件2特别容易出现重复接口号
        print(f"[Registry] 接口{key['interface_id']}: 相同接口号但不同行号(旧行={old_task['row_index']}, 新行={key['row_index']})，视为独立任务")
    old_task = None  # 不继承任何状态，作为新任务处理
```

**效果**：不同行的相同接口号现在被正确识别为独立任务，不再错误地继承状态或触发时间变化检测。

---

### 2.2 问题2：已忽略接口时间变更自动恢复

#### 当前状态
实际上该功能的核心逻辑已在之前的修复中实现（`batch_upsert_tasks`中的自动取消忽略、归档旧记录、重置状态逻辑）。问题2的根源与问题1相同：错误的`old_task`匹配导致时间比较失效。

#### 验证逻辑
修复问题1后，以下逻辑链路已完整可用：
1. `batch_upsert_tasks`中检测到`interface_time`变化
2. 如果任务当前为`ignored=1`，自动设置`ignored=0`并记录日志
3. 如果旧任务有完整数据链（`completed_at`+`confirmed_at`），归档旧记录
4. 重置状态为`open`并清除完成/确认字段
5. `get_display_status`将返回该任务的新状态，UI将正常显示

#### 测试验证
在`tests/test_real_scenarios_comprehensive.py`中已有专门测试：
- `test_scenario1_ignored_overdue_time_change`：忽略延期任务，时间变更，应取消忽略并重新显示
- `test_scenario4_combined_ignore_and_time_change`：已忽略且已确认的任务，时间变更，应取消忽略、归档旧记录、重置状态

**所有测试通过**，验证功能正常。

---

### 2.3 问题3：指派操作记录入档案

#### 根本原因
1. `distribution.py`中的`AssignmentDialog`初始化时未接收用户信息（`user_name`, `user_roles`）
2. `on_confirm`方法未构建完整的指派人信息（应包含姓名+角色）
3. `save_assignments_batch`中硬编码了`assigned_by="系统用户"`，未使用实际用户信息

#### 修复方案

**步骤1**: 修改`base.py`，传递用户信息给`AssignmentDialog`
```python
# base.py (约第5134行)
dialog = distribution.AssignmentDialog(
    self.root,
    unassigned,
    name_list,
    user_name=self.user_name,  # 传递用户姓名
    user_roles=self.user_roles  # 传递用户角色
)
```

**步骤2**: 修改`distribution.py`的`on_confirm`方法，构建完整指派人信息
```python
# distribution.py (约第688行)
# 构建指派人信息（姓名+角色）
assigned_by = self.user_name
if self.user_roles:
    # 如果有多个角色，只取第一个主要角色
    role = self.user_roles[0] if self.user_roles else ""
    assigned_by = f"{self.user_name}（{role}）"

assignments.append({
    'file_type': task['file_type'],
    'file_path': task['file_path'],
    'row_index': task['row_index'],
    'assigned_name': assigned_name,
    'assigned_by': assigned_by,  # 【新增】指派人信息
    'interface_id': task.get('interface_id', '未知'),
    'project_id': task.get('project_id', '')
})
```

**步骤3**: 修改`save_assignments_batch`，使用实际指派人信息
```python
# distribution.py (约第430行)
if interface_id and project_id:
    # 【修复】使用实际的指派人信息
    assigned_by = assignment.get('assigned_by', '系统用户')
    registry_hooks.on_assigned(
        file_type=assignment['file_type'],
        file_path=file_path,
        row_index=row_index,
        interface_id=interface_id,
        project_id=project_id,
        assigned_by=assigned_by,
        assigned_to=assignment['assigned_name']
    )
    registry_updates += 1
```

#### 效果
- `assigned_by`字段现在记录实际用户信息，格式为"姓名（角色）"，如"张三（所领导）"
- `assigned_at`字段记录指派时间
- `responsible_person`字段记录被指派人
- `display_status`自动更新为"待完成"
- events表中创建`assigned`类型事件记录，包含完整的`assigned_by`和`assigned_to`信息

---

## 三、测试验证

### 3.1 新增测试文件
**文件**: `tests/test_assignment_recording.py`  
**测试用例**: 5个

1. **test_assignment_records_assigned_by**: 验证指派操作正确记录`assigned_by`字段为实际用户而非"系统用户"
2. **test_assignment_creates_event_record**: 验证指派操作创建事件记录（`event='assigned'`）
3. **test_assignment_visible_in_history**: 验证指派操作在历史查询中可见
4. **test_multiple_assignments_preserved**: 验证多次指派操作都能正确记录
5. **test_assignment_without_role_info**: 验证兼容性（无角色信息时也能正确记录）

### 3.2 测试结果
```
tests/test_assignment_recording.py::test_assignment_records_assigned_by PASSED
tests/test_assignment_recording.py::test_assignment_creates_event_record PASSED
tests/test_assignment_recording.py::test_assignment_visible_in_history PASSED
tests/test_assignment_recording.py::test_multiple_assignments_preserved PASSED
tests/test_assignment_recording.py::test_assignment_without_role_info PASSED

============================== 5 passed in 0.75s
```

### 3.3 回归测试
运行之前的综合场景测试：
```
tests/test_real_scenarios_comprehensive.py::test_scenario1_ignored_overdue_time_change PASSED
tests/test_real_scenarios_comprehensive.py::test_scenario2_confirmed_cleared_and_time_change PASSED
tests/test_real_scenarios_comprehensive.py::test_scenario3_time_format_variation_no_reset PASSED
tests/test_real_scenarios_comprehensive.py::test_scenario4_combined_ignore_and_time_change PASSED

============================== 4 passed in 0.83s
```

**所有测试通过，无回归问题。**

---

## 四、技术要点

### 4.1 业务ID vs 任务ID的区别
- **business_id**: 业务唯一标识，由`file_type`+`project_id`+`interface_id`组成
- **task_id**: 真正的唯一标识，包含`source_file`+`row_index`
- **关键点**: 文件2等场景中，同一个`business_id`可能对应多个不同`row_index`的独立任务

### 4.2 任务匹配策略
- 旧逻辑：仅基于`business_id`匹配
- 新逻辑：先基于`business_id`匹配，再验证`row_index`是否一致
- 不一致时：视为新任务，不继承任何状态

### 4.3 指派信息格式
- **标准格式**: "姓名（角色）"，如"张三（所领导）"
- **兼容格式**: 仅姓名（无角色时）
- **默认值**: "系统用户"（当实际信息不可用时）

---

## 五、用户场景验证

### 场景1：文件2多个相同接口号任务
**操作**: 打开程序，运行"开始处理"
**预期**: 控制台不再输出大量"接口时间变化"日志
**结果**: ✅ 通过

### 场景2：忽略延期任务后修改预期时间
**操作**: 
1. 忽略一个延期任务（预期时间2025-11-07）
2. 在Excel中修改该任务预期时间为2025-11-30
3. 运行"开始处理"

**预期**: 
- 控制台输出"检测到已忽略任务的时间变化，取消忽略状态"
- 主显示窗口重新显示该任务
- 历史查询中该任务有新的记录

**结果**: ✅ 通过（已在测试中验证）

### 场景3：所领导指派任务后查询历史
**操作**:
1. 所领导角色登录
2. 打开指派窗口，将任务指派给"李四"
3. 打开历史查询，搜索该任务

**预期**:
- "指派人"列显示"所领导用户名（所领导）"
- "责任人"列显示"李四"
- "指派时间"列有记录

**结果**: ✅ 通过（已在测试中验证）

---

## 六、后续建议

1. **删除调试日志**: `batch_upsert_tasks`中为文件2添加的调试输出可在稳定运行后删除
2. **性能监控**: 关注文件2处理性能，大量独立任务可能影响批量upsert速度
3. **用户通知**: 建议在主界面添加"指派历史"快捷入口，方便用户查看指派记录
4. **数据完整性检查**: 可考虑添加定期任务，检查`business_id`相同但`row_index`不同的任务数量，作为数据质量监控指标

---

## 七、总结

本次修复解决了三个严重问题：

1. **文件2重复接口号独立任务处理**：通过添加`row_index`匹配检查，确保相同接口号的不同行被正确识别为独立任务，消除了控制台异常输出和状态混乱问题。

2. **已忽略接口时间变更自动恢复**：该功能实际已在之前实现，问题1的修复使其正常工作。现在已忽略任务在预期时间变更后会自动取消忽略、归档旧记录（如有完整数据链）、重置状态并重新显示。

3. **指派操作记录入档案**：通过传递实际用户信息、构建完整的指派人信息（姓名+角色）、修改`save_assignments_batch`使用真实数据，确保所有指派操作都被正确记录到任务表和事件表，可在历史查询中完整追溯。

**所有修复均已通过pytest测试验证，无回归问题。**

